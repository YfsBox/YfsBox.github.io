<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="1.实现基础 1) 索引系统 之前的lab中,Tuple在文件中的分布是没有规律的,而且想要在表对应的文件中查询一个Tuple,不得不在该文件中逐页地遍历查找,至于删除,插入等操作亦复如是. 而索引系统(这里主要围绕着B+ tree展开).其作用在于,能够根据某个字段或者多个字段,加速其查找.也可以说,索引是在原始存储的数据中,所抽象出来的一层将数据中的键值根据某种方式组织成的便于查找的数据结构,">
<meta property="og:type" content="article">
<meta property="og:title" content="mit 6.830 数据库系统: lab 5">
<meta property="og:url" content="http://example.com/2022/09101815.html">
<meta property="og:site_name" content="Yfs&#39;s Box">
<meta property="og:description" content="1.实现基础 1) 索引系统 之前的lab中,Tuple在文件中的分布是没有规律的,而且想要在表对应的文件中查询一个Tuple,不得不在该文件中逐页地遍历查找,至于删除,插入等操作亦复如是. 而索引系统(这里主要围绕着B+ tree展开).其作用在于,能够根据某个字段或者多个字段,加速其查找.也可以说,索引是在原始存储的数据中,所抽象出来的一层将数据中的键值根据某种方式组织成的便于查找的数据结构,">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2010%2016%2045%2019%201662799519%201662799519534%20dpwghL%20image-20220910164519396%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2010%2023%2017%2054%201662823074%201662823074233%20kCHVVZ%201191DF3D9BB32CD2F8B39AE3E736E033%20.jpg">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2011%2008%2054%2028%201662857668%201662857668375%20ylrF7i%20image-20220911085428235%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2011%2011%2002%2030%201662865350%201662865350896%20fm1lfg%20image-20220911110230782%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2011%2011%2006%2022%201662865582%201662865582427%20HpWI7l%20image-20220911110622307%20.png">
<meta property="article:published_time" content="2022-09-10T05:50:05.000Z">
<meta property="article:modified_time" content="2022-09-11T03:51:09.488Z">
<meta property="article:author" content="yfs">
<meta property="article:tag" content="数据库系统">
<meta property="article:tag" content="mit 6.830">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2010%2016%2045%2019%201662799519%201662799519534%20dpwghL%20image-20220910164519396%20.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>mit 6.830 数据库系统: lab 5</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<link rel="stylesheet" href="/js/prism/prism.css">

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/09101623.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/090523276.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/09101815.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/09101815.html&text=mit 6.830 数据库系统: lab 5"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/09101815.html&is_video=false&description=mit 6.830 数据库系统: lab 5"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=mit 6.830 数据库系统: lab 5&body=Check out this article: http://example.com/2022/09101815.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/09101815.html&name=mit 6.830 数据库系统: lab 5&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/09101815.html&t=mit 6.830 数据库系统: lab 5"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">1.实现基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.1.</span> <span class="toc-text">1) 索引系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b%E6%A0%91"><span class="toc-number">1.2.</span> <span class="toc-text">2) B+树</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">2.实现过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise-1-btreefile.findleafpage"><span class="toc-number">2.1.</span> <span class="toc-text">1) Exercise 1:
BTreeFile.findLeafPage()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise-2-splitting-pages"><span class="toc-number">2.2.</span> <span class="toc-text">2) Exercise 2: Splitting Pages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise-3-redistributing-pages"><span class="toc-number">2.3.</span> <span class="toc-text">3) Exercise 3: Redistributing
pages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise-4-merging-pages"><span class="toc-number">2.4.</span> <span class="toc-text">4) Exercise 4: Merging pages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">3.小结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        mit 6.830 数据库系统: lab 5
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">yfs</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-09-10T05:50:05.000Z" itemprop="datePublished">2022-09-10</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/java/" rel="tag">java</a>, <a class="tag-link-link" href="/tags/mit-6-830/" rel="tag">mit 6.830</a>, <a class="tag-link-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F/" rel="tag">数据库系统</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="实现基础">1.实现基础</h2>
<h3 id="索引系统">1) 索引系统</h3>
<p>之前的lab中,Tuple在文件中的分布是没有规律的,而且想要在表对应的文件中查询一个Tuple,不得不在该文件中逐页地遍历查找,至于删除,插入等操作亦复如是.</p>
<p>而索引系统(这里主要围绕着B+
tree展开).其作用在于,能够根据某个字段或者多个字段,加速其查找.也可以说,索引是在原始存储的数据中,所抽象出来的一层将数据中的键值根据某种方式组织成的便于查找的数据结构,比如说在本次lab中,就会将文件中的数据中的某个键组织成一颗B+树,之后关于对文件的增删查操作都会现在B+
树上进行,找到目标后,就返回其对应的Page.这样显然避免了对整个文件的遍历.</p>
<p>此外,一个原始数据文件可以有多个索引文件,每个不同的索引文件可以代表不同键值处所构造的索引.在本次lab中,通常是将一个文件有一个索引文件实现的.此外,索引还有稀疏或者稠密之分,稠密的索引就是一个文件中所有Record都有索引项的方式,否则就是稀疏的.</p>
<h3 id="b树">2) B+树</h3>
<p>首先B+树有几个基本的特点:</p>
<ul>
<li>除了leaf节点之外,不存储实际的数据.</li>
<li>叶子结点以链表的方式连接起来,所以B+树具有范围查找的能力,相比之下,B树的leaf节点并没有串起来,所以没有范围查找的能力.</li>
<li>每个leaf的高度是一样的,相比一般的二叉树,其增长过程是从leaf开始,自下向上的,很多树都是自顶向下插入的.</li>
</ul>
<p>此外,由于这里数据库系统做I/O操作的基本单位是Page,而一个B+树节点也就是一个Page.因此,在这里,如果将一个文件(只有一个索引键)对应一个B+树的话,文件中的所有数据都在leaf上,想要定位一个数据就得查找到其所在的leaf
Page.</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2010%2016%2045%2019%201662799519%201662799519534%20dpwghL%20image-20220910164519396%20.png" alt="image-20220910164519396" style="zoom: 50%;"></p>
<p>关于检索,插入,删除等操作的执行过程,在下面的每个练习中会细说.</p>
<blockquote>
<p><strong>1.B树系列为什么适合磁盘上的读写操作?</strong></p>
<p>​
B树相比于红黑树等数据结构,不在限制于“二叉”的性质,而且一个节点可以包含多个数据项,所以一般情况下,相同的数量的数据n,一个B树所呈现的高度更低,对于存储于磁盘上的数据,操作系统I/O的基本单位是一个block,此外在读取或者写数据时,I/O时间要显著多于CPU时间,因此节省I/O时间是提升读写磁盘数据的关键.</p>
<p>由于B树作为多叉树的特点,可以有更低的高度,和更少的节点,一般B树一个节点对应disk上的一个block,因此访问block的次数大大减少,进而导致I/O开销大大减少,一个节点可以有多个数据项也充分地利用了disk分块作为单位读写的特点.</p>
<p>​
虽然一个节点有多个数据项的特点导致在查找时,需要多花费时间在遍历一个节点上,但是由于局部性的特点,这点开销不大.</p>
<p><strong>2.B树,B+树的区别有什么?</strong></p>
<p>​ 在实际的磁盘存储中,B+树用得比B树多一些.</p>
<p>(1).B+树只有叶子结点保存数据,再结合B+树平衡的特性,任何查找工作经过的路径长度都是相同的,因此B+树的查找开销是更加稳定的.</p>
<p>(2).B+树的叶子结点之间是具有指针连接的,这点使得B+树具有范围查找的能力.</p>
<p>(3).B+树的中间节点不保存数据,</p>
</blockquote>
<h2 id="实现过程">2.实现过程</h2>
<h3 id="exercise-1-btreefile.findleafpage">1) Exercise 1:
BTreeFile.findLeafPage()</h3>
<p>这一部分的实现是比较简单的,类似于一般的二叉树的递归,但是B+树是多叉树,因此每一步向下递归的过程中,还会涉及到对于一个节点上的数据项的遍历.</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword keyword-private">private</span> <span class="token class-name">BTreeLeafPage</span> <span class="token function">findLeafPage</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> dirtypages<span class="token punctuation">,</span> <span class="token class-name">BTreePageId</span> pid<span class="token punctuation">,</span> <span class="token class-name">Permissions</span> perm<span class="token punctuation">,</span>
                                      <span class="token class-name">Field</span> f<span class="token punctuation">)</span>
				<span class="token keyword keyword-throws">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
	<span class="token comment">// some code goes here</span>
		<span class="token class-name">BTreePageId</span> pageId <span class="token operator">=</span> pid<span class="token punctuation">;</span>
		<span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>pageId<span class="token punctuation">.</span><span class="token function">pgcateg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">BTreePageId</span><span class="token punctuation">.</span>LEAF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Page</span> page <span class="token operator">=</span> <span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>pageId<span class="token punctuation">,</span><span class="token class-name">Permissions</span><span class="token punctuation">.</span>READ_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword keyword-int">int</span> pgcatag <span class="token operator">=</span> pageId<span class="token punctuation">.</span><span class="token function">pgcateg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pgcatag <span class="token operator">==</span> <span class="token class-name">BTreePageId</span><span class="token punctuation">.</span>INTERNAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BTreeEntry</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BTreeInternalPage</span><span class="token punctuation">)</span> page<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">BTreeEntry</span> entry <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
				<span class="token keyword keyword-boolean">boolean</span> isfound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					entry <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">Field</span> field <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> field<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>GREATER_THAN_OR_EQ<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						pageId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getLeftChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						isfound <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						<span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isfound <span class="token operator">&amp;&amp;</span> entry <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					pageId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getRightChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token class-name">BTreeLeafPage</span><span class="token punctuation">)</span> <span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>pageId<span class="token punctuation">,</span>perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直到遍历到一个leaf
Page即为到达终点,其中需要注意的是对于<code>null</code>来说,一直向左递归就可以了,还有关于向下递归的条件,究竟应该是”大于等于“还是“大于”.我之前是按照大于做的,但是这样会导致错误,尤其是对于有重复的情况.在此举一个例子:</p>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2010%2023%2017%2054%201662823074%201662823074233%20kCHVVZ%201191DF3D9BB32CD2F8B39AE3E736E033%20.jpg" alt="1191DF3D9BB32CD2F8B39AE3E736E033">
<figcaption aria-hidden="true">1191DF3D9BB32CD2F8B39AE3E736E033</figcaption>
</figure>
<p>对于图中的情况,如果等到“&gt;"才向下左递归的话,如果想要查找1,这样递归到根下面的一层后,就会朝最右方递归,这明显导致所读的leaf
Page数据不全的情况,如果想要查找的是2的话,则会递归到[2,3,3,3]这一个叶子结点,仍然是不能得到一个含有2的完整的leaf
Page.对于所要查找的值,正好等于一个中间节点(下一层就是leaf的情况),如果递归到左子则不一定含有该数值,但是由于leaf
Page相连的特点,还是可以遍历到下一个leaf
Page,进而达到完整地遍历该数值对应的leaf
Page的.如果是“&gt;”的条件就向左下遍历,那么容易造成缺页,进而无法完整遍历该数值所在的leaf
page.</p>
<p>B+树的叶子结点中的key呈现单调不下降的特点,当叶子进行分裂并将m/2项放到上一层节点的时候,未必就能保证该Tuple右边的一定就大,左边的就一定要小,它们还有可能是相等的.所以在这里我认为,不能认为左子树一定是小于的,右子树一定是大于的,左右子树都可以有等于的情况在其中.</p>
<h3 id="exercise-2-splitting-pages">2) Exercise 2: Splitting Pages</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword keyword-public">public</span> <span class="token class-name">BTreeInternalPage</span> <span class="token function">splitInternalPage</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> dirtypages<span class="token punctuation">,</span>
		<span class="token class-name">BTreeInternalPage</span> page<span class="token punctuation">,</span> <span class="token class-name">Field</span> field<span class="token punctuation">)</span> 
				<span class="token keyword keyword-throws">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>

	<span class="token class-name">BTreeInternalPage</span> newPage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BTreeInternalPage</span><span class="token punctuation">)</span> <span class="token function">getEmptyPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span><span class="token class-name">BTreePageId</span><span class="token punctuation">.</span>INTERNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-int">int</span> maxEntry <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getMaxEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">BTreeEntry</span> midEntry <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
	<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BTreeEntry</span><span class="token punctuation">&gt;</span></span> rit <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">reverseIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-int">int</span> maxSize <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getMaxEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BTreeEntry</span> entry <span class="token operator">=</span> rit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		page<span class="token punctuation">.</span><span class="token function">deleteKeyAndRightChild</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		newPage<span class="token punctuation">.</span><span class="token function">insertEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	midEntry <span class="token operator">=</span> rit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	page<span class="token punctuation">.</span><span class="token function">deleteKeyAndRightChild</span><span class="token punctuation">(</span>midEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">updateParentPointers</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">updateParentPointers</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>newPage<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">BTreePage</span> parentPage <span class="token operator">=</span> <span class="token function">getParentWithEmptySlots</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>page<span class="token punctuation">.</span><span class="token function">getParentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BTreeInternalPage</span><span class="token punctuation">)</span> parentPage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertEntry</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">BTreeEntry</span><span class="token punctuation">(</span>midEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>page<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>newPage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">updateParentPointers</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">BTreeInternalPage</span><span class="token punctuation">)</span> parentPage<span class="token punctuation">)</span><span class="token punctuation">;</span>

	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>parentPage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>parentPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newPage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>newPage<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>GREATER_THAN_OR_EQ<span class="token punctuation">,</span>midEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword keyword-return">return</span> newPage<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-return">return</span> page<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一部分的实现相对来说比较简单,这里只列举<code>splitInternalPage</code>.</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2011%2008%2054%2028%201662857668%201662857668375%20ylrF7i%20image-20220911085428235%20.png" alt="image-20220911085428235" style="zoom: 50%;"></p>
<p>其中分裂的规则就是两方对半平分,至于<code>Internal,Leaf</code>的主要区别就在于,是否需要将第m/2个节点移除,由于B+树的特点就是所有的叶子结点必须涵盖所有的数据,因此当leaf
Page进行split时无需将第m/2个节点移除,如果是Internal的话,则需要进行移除.</p>
<p>所以在<code>splitInternalPage</code>的实现中,主要分为如下过程:</p>
<ul>
<li>将page的部分节点移除(对半平分),并且插入到newpage中.</li>
<li>对于最后一个移除的要进行一定的特殊处理,这一个不需要插入到newpage中.</li>
<li>更新newpage和page的孩子节点.</li>
<li>使用<code>getParentWithEmptySlots</code>(递归地)获取这两个节点的父节点.</li>
<li>将mid项插入(注意左右child的设置),到父节点.</li>
<li>缓存脏页并返回.</li>
</ul>
<p>理解了<code>split</code>操作后,就可以将insert概括为,首先<code>findLeafPage</code>找到目标应该所在的leaf
Page,然后根据其当前大小判断是否要进行split,如果不需要就直接加入,否则就将其分裂出一个new
leaf
Page,并且加入一个新的中间结点,如果中间节点也出现了超出数量的情况,则继续递归到中间节点,并执行split,再加入新的中间结点,以此类推,知道不需要分裂或者到达根节点为止.</p>
<h3 id="exercise-3-redistributing-pages">3) Exercise 3: Redistributing
pages</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-void">void</span> <span class="token function">stealFromLeftInternalPage</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> dirtypages<span class="token punctuation">,</span>
		<span class="token class-name">BTreeInternalPage</span> page<span class="token punctuation">,</span> <span class="token class-name">BTreeInternalPage</span> leftSibling<span class="token punctuation">,</span> <span class="token class-name">BTreeInternalPage</span> parent<span class="token punctuation">,</span>
		<span class="token class-name">BTreeEntry</span> parentEntry<span class="token punctuation">)</span> <span class="token keyword keyword-throws">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
	<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BTreeEntry</span><span class="token punctuation">&gt;</span></span> rit <span class="token operator">=</span> leftSibling<span class="token punctuation">.</span><span class="token function">reverseIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-int">int</span> totalNum <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getNumEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> leftSibling<span class="token punctuation">.</span><span class="token function">getNumEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">BTreeEntry</span> bTreeEntry <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>newBtreeEntry <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>

	<span class="token class-name">BTreeEntry</span> oldParentEntry <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">BTreeEntry</span><span class="token punctuation">(</span>parentEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
								leftSibling<span class="token punctuation">.</span><span class="token function">reverseIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRightChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
								page<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeftChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	page<span class="token punctuation">.</span><span class="token function">insertEntry</span><span class="token punctuation">(</span>oldParentEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getNumEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> totalNum <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bTreeEntry <span class="token operator">=</span> rit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		leftSibling<span class="token punctuation">.</span><span class="token function">deleteKeyAndRightChild</span><span class="token punctuation">(</span>bTreeEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		page<span class="token punctuation">.</span><span class="token function">insertEntry</span><span class="token punctuation">(</span>bTreeEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	newBtreeEntry <span class="token operator">=</span> rit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	leftSibling<span class="token punctuation">.</span><span class="token function">deleteKeyAndRightChild</span><span class="token punctuation">(</span>newBtreeEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">updateParentPointers</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>leftSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">updateParentPointers</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>

	parentEntry<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>newBtreeEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	parent<span class="token punctuation">.</span><span class="token function">updateEntry</span><span class="token punctuation">(</span>parentEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">updateParentPointers</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>leftSibling<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>leftSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于删除操作需要涉及到的操作有<code>steal</code>和<code>Merge</code>,前者的原则仍然是对半平分.</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2011%2011%2002%2030%201662865350%201662865350896%20fm1lfg%20image-20220911110230782%20.png" alt="image-20220911110230782" style="zoom:50%;"></p>
<h3 id="exercise-4-merging-pages">4) Exercise 4: Merging pages</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-void">void</span> <span class="token function">mergeInternalPages</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> dirtypages<span class="token punctuation">,</span>
		<span class="token class-name">BTreeInternalPage</span> leftPage<span class="token punctuation">,</span> <span class="token class-name">BTreeInternalPage</span> rightPage<span class="token punctuation">,</span> <span class="token class-name">BTreeInternalPage</span> parent<span class="token punctuation">,</span> <span class="token class-name">BTreeEntry</span> parentEntry<span class="token punctuation">)</span> 
				<span class="token keyword keyword-throws">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
   
	<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BTreeEntry</span><span class="token punctuation">&gt;</span></span> entryIt <span class="token operator">=</span> rightPage<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">BTreeEntry</span> oldparentEntry <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">BTreeEntry</span><span class="token punctuation">(</span>parentEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>leftPage<span class="token punctuation">.</span><span class="token function">reverseIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRightChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			rightPage<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLeftChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	leftPage<span class="token punctuation">.</span><span class="token function">insertEntry</span><span class="token punctuation">(</span>oldparentEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>entryIt<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BTreeEntry</span> entry <span class="token operator">=</span> entryIt<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		rightPage<span class="token punctuation">.</span><span class="token function">deleteKeyAndLeftChild</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		leftPage<span class="token punctuation">.</span><span class="token function">insertEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">updateParentPointers</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>leftPage<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">setEmptyPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>rightPage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">deleteParentEntry</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>leftPage<span class="token punctuation">,</span>parent<span class="token punctuation">,</span>parentEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">updateParentPointers</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>dirtypages<span class="token punctuation">,</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>leftPage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>leftPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rightPage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rightPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dirtypages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中以<code>mergeInternalPages</code>为例,这里的实现过程(将右leaf
Page合并到左leaf Page)如下:</p>
<ul>
<li>将需要移除的BTreeEntry追加到left page中(注意child的设置).</li>
<li>将所有right page中的项移除,并insert到left leaf page.</li>
<li>更新left page的child的父母节点,将已经合并的righht
page设置为null,移除父节点中对应的项.</li>
<li>缓存脏页.</li>
</ul>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2009%2011%2011%2006%2022%201662865582%201662865582427%20HpWI7l%20image-20220911110622307%20.png" alt="image-20220911110622307" style="zoom:50%;"></p>
<p>在这里关于<code>merge</code>的实现,其中中间节点和leaf结点的区别在于,同样都需要将对应的某个parent进行移除,但是移除的时候是否还需要将这个移除的项加入到子节点中呢?如果是leaf
page,直接移除就可以,其他不需要做什么,如果是中间节点,则还需要将移除的节点项加入到某个child
Page中.因为在其他的操作中,都不会破坏leaf page维护全部数据的性质.</p>
<p>接下来可以简单地梳理一下<code>delete</code>过程,仍然是先找到目标所在的leaf
page.然后检查该leaf
page的数量,如果去掉一个后不少于一半就直接移除该项,否则进行<code>steal</code>或者<code>merge</code>,首先进行steal,如果steal之后发现仍然有一方数量不足就进行merge.一直向上递归,知道递归到某个节点的数量符合要求或者到达根节点.</p>
<h2 id="小结">3.小结</h2>
<p>这个lab怎么说呢,B+树的实现方面细节比较多,这算是一个难点,但是这次lab并不会涉及到太多关于整个database的架构的理解.至于这次lab的实现,我有个很遗憾的地方在于,并没有通过附加题中的<code>BTreetest</code>.我想应该是我在<code>Lock Manager</code>方面出的问题吧,暂时先鸽了.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">1.实现基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.1.</span> <span class="toc-text">1) 索引系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b%E6%A0%91"><span class="toc-number">1.2.</span> <span class="toc-text">2) B+树</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">2.实现过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise-1-btreefile.findleafpage"><span class="toc-number">2.1.</span> <span class="toc-text">1) Exercise 1:
BTreeFile.findLeafPage()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise-2-splitting-pages"><span class="toc-number">2.2.</span> <span class="toc-text">2) Exercise 2: Splitting Pages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise-3-redistributing-pages"><span class="toc-number">2.3.</span> <span class="toc-text">3) Exercise 3: Redistributing
pages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise-4-merging-pages"><span class="toc-number">2.4.</span> <span class="toc-text">4) Exercise 4: Merging pages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">3.小结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/09101815.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/09101815.html&text=mit 6.830 数据库系统: lab 5"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/09101815.html&is_video=false&description=mit 6.830 数据库系统: lab 5"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=mit 6.830 数据库系统: lab 5&body=Check out this article: http://example.com/2022/09101815.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/09101815.html&title=mit 6.830 数据库系统: lab 5"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/09101815.html&name=mit 6.830 数据库系统: lab 5&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/09101815.html&t=mit 6.830 数据库系统: lab 5"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    yfs
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">首页</a></li><!--
    --><!--
      --><li><a href="/about/">关于</a></li><!--
    --><!--
      --><li><a href="/archives/">归档</a></li><!--
    -->
      </ul>
      <ul>
        
          <!-- 不蒜子统计 -->
          <span id="busuanzi_container_site_pv">
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  本站访客数<span id="busuanzi_value_site_uv"></span>人
          </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  
</footer>

<script src="/js/prism/prism.js" async></script>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
