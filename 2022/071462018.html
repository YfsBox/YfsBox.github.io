<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="0.前言 久仰mit 6.824的威名,上个学期的时候我就一直想抽空学一学,但是一直没有抽出太多时间.假期打算好好做做. 至于做这个实验的语言基础方面,我在大二下学期只接触过一点点go语言,没有写过太多,在lab中我把中途遇到的一些问题写到了另一篇博客中,也算是0的基础吧. 除此之外,在多线程&#x2F;进程编程和网络方面,当时做计网编程作业时也遇到过类似的,当时x老师布置了一个实现基于分布式系统的ipv6">
<meta property="og:type" content="article">
<meta property="og:title" content="mit 6.824:lab 1">
<meta property="og:url" content="http://example.com/2022/071462018.html">
<meta property="og:site_name" content="Yfs&#39;s Box">
<meta property="og:description" content="0.前言 久仰mit 6.824的威名,上个学期的时候我就一直想抽空学一学,但是一直没有抽出太多时间.假期打算好好做做. 至于做这个实验的语言基础方面,我在大二下学期只接触过一点点go语言,没有写过太多,在lab中我把中途遇到的一些问题写到了另一篇博客中,也算是0的基础吧. 除此之外,在多线程&#x2F;进程编程和网络方面,当时做计网编程作业时也遇到过类似的,当时x老师布置了一个实现基于分布式系统的ipv6">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2014%2022%2058%2050%201657810730%201657810730893%20hI0nGA%20image-20220714225850817%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2014%2023%2009%2052%201657811392%201657811392330%20LmWIQi%20image-20220714230952253%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2015%2013%2050%2043%201657864243%201657864243457%20ZJqHqi%20image-20220715135043336%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2023%2023%2009%2017%201658588957%201658588957672%20xu8Tux%20DD781F2F36F93AD7AFAC3781FD05EB4A%20.jpg">
<meta property="article:published_time" content="2022-07-14T14:34:03.000Z">
<meta property="article:modified_time" content="2022-07-23T15:12:25.495Z">
<meta property="article:author" content="yfs">
<meta property="article:tag" content="分布式系统">
<meta property="article:tag" content="mit 6.824">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2014%2022%2058%2050%201657810730%201657810730893%20hI0nGA%20image-20220714225850817%20.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>mit 6.824:lab 1</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<link rel="stylesheet" href="/js/prism/prism.css">

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/071719892.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/070837932.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/071462018.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/071462018.html&text=mit 6.824:lab 1"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/071462018.html&is_video=false&description=mit 6.824:lab 1"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=mit 6.824:lab 1&body=Check out this article: http://example.com/2022/071462018.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/071462018.html&name=mit 6.824:lab 1&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/071462018.html&t=mit 6.824:lab 1"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0.前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6%E5%92%8C%E6%80%9D%E8%B7%AF"><span class="toc-number">2.</span> <span class="toc-text">1.基本框架和思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">2.具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mastercoordinator"><span class="toc-number">3.1.</span> <span class="toc-text">1) master(coordinator)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#worker"><span class="toc-number">3.2.</span> <span class="toc-text">2) worker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">4.</span> <span class="toc-text">3.测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%9C%B0%E5%A4%8D%E7%9B%98"><span class="toc-number">5.</span> <span class="toc-text">4. 简单地复盘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E9%81%97%E6%86%BE"><span class="toc-number">6.</span> <span class="toc-text">5.我的遗憾</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        mit 6.824:lab 1
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">yfs</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-07-14T14:34:03.000Z" itemprop="datePublished">2022-07-14</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/mit-6-824/" rel="tag">mit 6.824</a>, <a class="tag-link-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" rel="tag">分布式系统</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="前言">0.前言</h2>
<p>久仰mit
6.824的威名,上个学期的时候我就一直想抽空学一学,但是一直没有抽出太多时间.假期打算好好做做.</p>
<p>至于做这个实验的语言基础方面,我在大二下学期只接触过一点点go语言,没有写过太多,在lab中我把中途遇到的一些问题写到了另一篇博客中,也算是0的基础吧.</p>
<p>除此之外,在多线程/进程编程和网络方面,当时做计网编程作业时也遇到过类似的,当时x老师布置了一个实现基于分布式系统的ipv6
DNS服务的作业,我花了一些时间去做,虽然实现效果不好,但是一些设计的想法感觉在这里的lab
1还是可以用上的.而且最近也在学习用c++写一个webserver程序(被死锁折磨qaq......)感觉也是有不少东西是相通的.</p>
<p>在真正动手编程之前,读了一下<code>MapReduce</code>的论文,只读了前一半,至于对做这个实验来说,感觉足够了.</p>
<h2 id="基本框架和思路">1.基本框架和思路</h2>
<p>其框架结构图基本上是遵循论文中的架构的.</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2014%2022%2058%2050%201657810730%201657810730893%20hI0nGA%20image-20220714225850817%20.png" alt="image-20220714225850817" style="zoom: 33%;"></p>
<p>但是若论实现,不同的人肯定还是有不同的实现方式吧,往细节处追究还是会有不小的差别的.</p>
<h2 id="具体实现">2.具体实现</h2>
<h3 id="mastercoordinator">1) master(coordinator)</h3>
<p>从总体上看的话,master相当于一个接收处理rpc请求的服务器,这些请求也正是来自于那些<code>worker</code>.所以说其主要部分就是实现一些rpc函数.</p>
<p>但是master还有个重要的任务在于,追踪在线的<code>worker</code>,并且记录整个<code>MapReduce</code>任务的状态.所以说还需要一些数据结构,来保存这些信息,并且这些信息还应该在处理rpc的过程中改变.</p>
<p>就像论文中所说:</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2014%2023%2009%2052%201657811392%201657811392330%20LmWIQi%20image-20220714230952253%20.png" alt="论文片段" style="zoom:33%;"></p>
<p>其实我的在实现时,和它还是有一些区别的.我在记录状态时,不仅仅记录了非空闲<code>worker</code>的状态.·<code>master</code>的总体数据结构如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-type">type</span> Coordinator <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your definitions here.</span>
	isShut     <span class="token builtin">bool</span>
	nMap       <span class="token builtin">int</span> <span class="token comment">//map任务的总数</span>
	nReduce    <span class="token builtin">int</span> <span class="token comment">//reduce任务的总数</span>
	mapfinishM <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token comment">//已经完成的map任务</span>
	mapfinishR <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token comment">//已经完成的reduce任务</span>
	maplist    list<span class="token punctuation">.</span>List <span class="token comment">//待分配的map任务</span>
	reducelist list<span class="token punctuation">.</span>List <span class="token comment">//待分配的reduce任务</span>
	inputFiles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//输入map任务的文件路径</span>
	interFiles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//输入reduce任务的文件路径,也是由map任务所产生的</span>
	mapWorker  <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span>workerState <span class="token comment">//worker的状态记录</span>
	mutex      sync<span class="token punctuation">.</span>Mutex <span class="token comment">//锁</span>
	wg         sync<span class="token punctuation">.</span>WaitGroup
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最初我在考虑记录任务完成的情况,只是考虑使用一个表示完成数量的变量,但现在之所以考虑使用<code>map</code>是与我所设计的容错机制有关的,会在后面再详细说明.其中这里map的key是每个<code>worker</code>的编号,这个编号是每个<code>worker</code>进程的pid,关于<code>worker</code>状态,则有相应的数据结构进行描述:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-type">type</span> workerState <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	tasktype <span class="token builtin">int</span> <span class="token comment">//记录最近一次所处理任务的类型，只在任务分配时更新</span>
	tid      <span class="token builtin">int</span> <span class="token comment">//最近处理任务类型的编号</span>
	deadtime <span class="token builtin">int64</span> <span class="token comment">//倒计时,当过期时判定该worker为crash</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为什么要考虑使用<code>tasktype</code>和<code>tid</code>这一对变量呢?这用于,当检查到某个<code>worker</code>宕机的时候,可以因此确定其最近所处理的任务类型和任务编号,然后再根据<code>mapfinishM</code>或者<code>mapfinishR</code>来判断这个宕机<code>worker</code>所处理的任务有没有完成,如果已经完成了,就此作罢,否则就将其重新加入到分配队列<code>maplist</code>或者<code>reducelist</code>,将该任务重新等待分配.</p>
<p>说完这些,看一下RPC函数:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">ReplyTask</span><span class="token punctuation">(</span>args <span class="token operator">*</span>AskTaskArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>Task<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">GetFinishSig</span><span class="token punctuation">(</span>args <span class="token operator">*</span>Task<span class="token punctuation">,</span> reply <span class="token operator">*</span>FinishReply<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">BeatReponse</span><span class="token punctuation">(</span>args <span class="token operator">*</span>BeatArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>BeatReply<span class="token punctuation">)</span> <span class="token builtin">error</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其中<code>ReplyTask</code>用来为<code>worker</code>分配任务,<code>GetFinishSig</code>则用于接收完成任务的<code>worker</code>的通知,进而对相关的状态信息进行变化.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">ReplyTask</span><span class="token punctuation">(</span>args <span class="token operator">*</span>AskTaskArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>Task<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	wid <span class="token operator">:=</span> args<span class="token punctuation">.</span>Wid
	c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	nfinishMap <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>mapfinishM<span class="token punctuation">)</span>
	allocatedMap <span class="token operator">:=</span> c<span class="token punctuation">.</span>maplist<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	allocatedReduce <span class="token operator">:=</span> c<span class="token punctuation">.</span>reducelist<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	reply<span class="token punctuation">.</span>Nreduce <span class="token operator">=</span> c<span class="token punctuation">.</span>nReduce
	reply<span class="token punctuation">.</span>FilesTask <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword keyword-if">if</span> nfinishMap <span class="token operator">!=</span> c<span class="token punctuation">.</span>nMap <span class="token operator">&amp;&amp;</span> allocatedMap <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">//分配一个map任务,在这里的nalloc和nmap的判断其实不对</span>
		Front <span class="token operator">:=</span> c<span class="token punctuation">.</span>maplist<span class="token punctuation">.</span><span class="token function">Front</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Tid <span class="token operator">=</span> Front<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>maplist<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>Front<span class="token punctuation">)</span> <span class="token comment">//直接从front移除</span>

		reply<span class="token punctuation">.</span>TaskType <span class="token operator">=</span> MapTask
		reply<span class="token punctuation">.</span>FilesTask <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>reply<span class="token punctuation">.</span>FilesTask<span class="token punctuation">,</span> c<span class="token punctuation">.</span>inputFiles<span class="token punctuation">[</span>reply<span class="token punctuation">.</span>Tid<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//暂时先按照一个来算</span>
		tmp <span class="token operator">:=</span> c<span class="token punctuation">.</span>mapWorker<span class="token punctuation">[</span>wid<span class="token punctuation">]</span>
		tmp<span class="token punctuation">.</span>tasktype <span class="token operator">=</span> MapTask
		tmp<span class="token punctuation">.</span>tid <span class="token operator">=</span> reply<span class="token punctuation">.</span>Tid
    
		c<span class="token punctuation">.</span>mapWorker<span class="token punctuation">[</span>wid<span class="token punctuation">]</span> <span class="token operator">=</span> tmp

	<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> nfinishMap <span class="token operator">==</span> c<span class="token punctuation">.</span>nMap <span class="token operator">&amp;&amp;</span> allocatedReduce <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		Front <span class="token operator">:=</span> c<span class="token punctuation">.</span>reducelist<span class="token punctuation">.</span><span class="token function">Front</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		reply<span class="token punctuation">.</span>Tid <span class="token operator">=</span> Front<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>reducelist<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>Front<span class="token punctuation">)</span>

		reply<span class="token punctuation">.</span>TaskType <span class="token operator">=</span> ReduceTask
		re <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">"[0-9]+"</span><span class="token punctuation">)</span>
		<span class="token comment">//fmt.Println(re.FindAllString("mr-intermadiate-0-4", -1))</span>
		<span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> filename <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> c<span class="token punctuation">.</span>interFiles <span class="token punctuation">{</span>
			findstrs <span class="token operator">:=</span> re<span class="token punctuation">.</span><span class="token function">FindAllString</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			number<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>findstrs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token keyword keyword-if">if</span> number <span class="token operator">==</span> reply<span class="token punctuation">.</span>Tid <span class="token punctuation">{</span> <span class="token comment">//对应的文件应该分配给worker</span>
				reply<span class="token punctuation">.</span>FilesTask <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>reply<span class="token punctuation">.</span>FilesTask<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		tmp <span class="token operator">:=</span> c<span class="token punctuation">.</span>mapWorker<span class="token punctuation">[</span>wid<span class="token punctuation">]</span>
		tmp<span class="token punctuation">.</span>tasktype <span class="token operator">=</span> ReduceTask
		tmp<span class="token punctuation">.</span>tid <span class="token operator">=</span> reply<span class="token punctuation">.</span>Tid

		c<span class="token punctuation">.</span>mapWorker<span class="token punctuation">[</span>wid<span class="token punctuation">]</span> <span class="token operator">=</span> tmp

	<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Tid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		reply<span class="token punctuation">.</span>TaskType <span class="token operator">=</span> IdleTask
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先来看一下这个rpc参数和返回值的数据结构:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-type">type</span> AskTaskArgs <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	Wid <span class="token builtin">int</span> <span class="token comment">//该worker的编号</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-type">type</span> Task <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span> <span class="token comment">//这个将会作为reply返回,也可以用来作为已经完成的任务的信息</span>
	Tid       <span class="token builtin">int</span> <span class="token comment">//任务号</span>
	TaskType  <span class="token builtin">int</span> <span class="token comment">//任务类型</span>
	Nreduce   <span class="token builtin">int</span> <span class="token comment">//任务数量</span>
	FilesTask <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">//任务对应的处理文件</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中的<code>Wid</code>作用在于因为需要更新<code>worker</code>的状态,更新为最近处理的任务.而返回值,除了任务类型和任务编号,还有对应的文件.</p>
<p>代码看上去有点长,但是大体上可以分为四个分支:</p>
<ul>
<li>Map任务还没有分配完,应该分配Map任务.</li>
<li>Map做完了,应该分配Reduce了,所以分配Reduce任务.</li>
<li>所有任务完成或者其他情况,都是不分配任务的.</li>
</ul>
<p>当有任务分配给一个<code>worker</code>时,首先从待分配队列中摘出一个任务,这个任务就是分配给这个<code>worker</code>的任务,根据这个任务的<code>tid</code>来确定相应的处理文件,进而设置好reply,然后更新此<code>worker</code>的任务状态(tid,tasktype).</p>
<p>下面是关于接收到finish的处理.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">GetFinishSig</span><span class="token punctuation">(</span>args <span class="token operator">*</span>Task<span class="token punctuation">,</span> reply <span class="token operator">*</span>FinishReply<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-defer">defer</span> c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-if">if</span> args<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> MapTask <span class="token punctuation">{</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> isfinish <span class="token operator">:=</span> c<span class="token punctuation">.</span>mapfinishM<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Tid<span class="token punctuation">]</span>
		<span class="token keyword keyword-if">if</span> isfinish <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span>mapfinishM<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Tid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
		c<span class="token punctuation">.</span>interFiles <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>interFiles<span class="token punctuation">,</span> args<span class="token punctuation">.</span>FilesTask<span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>mapfinishM<span class="token punctuation">)</span> <span class="token operator">==</span> c<span class="token punctuation">.</span>nMap <span class="token punctuation">{</span> <span class="token comment">//表示所有map已完成</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"The Map is finished\n"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> args<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> ReduceTask <span class="token punctuation">{</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> isfinish <span class="token operator">:=</span> c<span class="token punctuation">.</span>mapfinishR<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Tid<span class="token punctuation">]</span>
		<span class="token keyword keyword-if">if</span> isfinish <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span>mapfinishR<span class="token punctuation">[</span>args<span class="token punctuation">.</span>Tid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token keyword keyword-if">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>mapfinishR<span class="token punctuation">)</span> <span class="token operator">==</span> c<span class="token punctuation">.</span>nReduce <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"The Reduce is finished\n"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要分为两种不同的任务,也就是<code>Map</code>和<code>Reduce</code>两种情况,首先检查此任务之前是否已经完成,如果之前就已经完成则将不继续处理,否则就设置该任务的finishmap为1,如果是<code>Map</code>就将生成的文件追加到<code>interFiles</code>中.对于<code>FinishReply</code>,其实并没有派上什么用场.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">BeatReponse</span><span class="token punctuation">(</span>args <span class="token operator">*</span>BeatArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>BeatReply<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">//fmt.Println("A worker ping the coordinator......")</span>
	wid <span class="token operator">:=</span> args<span class="token punctuation">.</span>WorkerId
	tmpargs <span class="token operator">:=</span> workerState<span class="token punctuation">{</span><span class="token punctuation">}</span>
	tmpargs<span class="token punctuation">.</span>deadtime <span class="token operator">=</span> args<span class="token punctuation">.</span>DeadLine <span class="token operator">+</span> <span class="token number">3</span>
	c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-defer">defer</span> c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	tmpargs<span class="token punctuation">.</span>tid <span class="token operator">=</span> c<span class="token punctuation">.</span>mapWorker<span class="token punctuation">[</span>wid<span class="token punctuation">]</span><span class="token punctuation">.</span>tid
	tmpargs<span class="token punctuation">.</span>tasktype <span class="token operator">=</span> c<span class="token punctuation">.</span>mapWorker<span class="token punctuation">[</span>wid<span class="token punctuation">]</span><span class="token punctuation">.</span>tasktype
	c<span class="token punctuation">.</span>mapWorker<span class="token punctuation">[</span>wid<span class="token punctuation">]</span> <span class="token operator">=</span> tmpargs <span class="token comment">//相当于只有deadtime变了</span>
	<span class="token comment">//fmt.Printf("the worker %v deadtime is %v\n", wid, tmpargs.deadtime)</span>
	<span class="token keyword keyword-if">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>mapfinishR<span class="token punctuation">)</span> <span class="token operator">==</span> c<span class="token punctuation">.</span>nReduce <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>isShut <span class="token operator">=</span> <span class="token boolean">true</span>
		reply<span class="token punctuation">.</span>IsShut <span class="token operator">=</span> <span class="token boolean">true</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"The master shut\n"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>isShut <span class="token operator">=</span> <span class="token boolean">false</span>
		reply<span class="token punctuation">.</span>IsShut <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">//无需关机</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里核心在于更新<code>worker</code>状态中的时间,不过我把总任务终止的判断也写在这里了,这看上去不太好,似乎把这一部分放到<code>GetFinishSig</code>中是更符合人直觉的,但是我认为放到<code>BeatReponse</code>有一个优点就在于,每个在线的<code>worker</code>都会通过心跳包来和<code>master</code>交互,因而每个<code>worker</code>都可以通过心跳包的响应得出退出的信号.如果在<code>GetFinishSig</code>中实现的话,只有当时完成任务的<code>worker</code>才可以得知<code>master</code>shut的信号,就难以做到通知所有<code>worker</code>了.此外还有一个问题,就是<code>master</code>应当等待其他<code>worker</code>退出后,自己再退出,在这里的实现上,我做的方式比较笨,我是通过<code>sleep</code>等待来实现的,让<code>master</code>sleep的时间长一些,这样一般就能保证其他的<code>worker</code>已经都退出了.如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	ret <span class="token operator">:=</span> <span class="token boolean">false</span>
	c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ret <span class="token operator">=</span> c<span class="token punctuation">.</span>isShut
	<span class="token comment">// Your code here.</span>
	c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-if">if</span> ret <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-return">return</span> ret
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后是关于<code>crash</code>的判断,这一部分并不是一个rpc请求,而是分出一个单独的线程运行.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Coordinator<span class="token punctuation">)</span> <span class="token function">CheckCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
		current <span class="token operator">:=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">//fmt.Printf("The current time is %v\n", current)</span>
		c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-for">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> c<span class="token punctuation">.</span>mapWorker <span class="token punctuation">{</span>
			<span class="token keyword keyword-if">if</span> current <span class="token operator">&gt;</span> value<span class="token punctuation">.</span>deadtime <span class="token punctuation">{</span> <span class="token comment">//只要出现一个crash的,直接从头remake</span>
				tid <span class="token operator">:=</span> value<span class="token punctuation">.</span>tid
				flag <span class="token operator">:=</span> <span class="token boolean">false</span> <span class="token comment">//加入</span>
				<span class="token keyword keyword-if">if</span> value<span class="token punctuation">.</span>tasktype <span class="token operator">==</span> MapTask <span class="token punctuation">{</span>
					<span class="token keyword keyword-for">for</span> node <span class="token operator">:=</span> c<span class="token punctuation">.</span>maplist<span class="token punctuation">.</span><span class="token function">Front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> node <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword keyword-if">if</span> node<span class="token punctuation">.</span>Value <span class="token operator">==</span> tid <span class="token punctuation">{</span>
							flag <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">//分配队列中如果已经有了</span>
						<span class="token punctuation">}</span>
						<span class="token comment">//fmt.Printf("the node in maplist is %v\n", node.Value)</span>
					<span class="token punctuation">}</span>
					<span class="token boolean">_</span><span class="token punctuation">,</span> isfinish <span class="token operator">:=</span> c<span class="token punctuation">.</span>mapfinishM<span class="token punctuation">[</span>tid<span class="token punctuation">]</span>
					flag <span class="token operator">=</span> flag <span class="token operator">||</span> isfinish
					<span class="token keyword keyword-if">if</span> flag <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
						c<span class="token punctuation">.</span>maplist<span class="token punctuation">.</span><span class="token function">PushBack</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
					<span class="token keyword keyword-for">for</span> node <span class="token operator">:=</span> c<span class="token punctuation">.</span>reducelist<span class="token punctuation">.</span><span class="token function">Front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> node <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword keyword-if">if</span> node<span class="token punctuation">.</span>Value <span class="token operator">==</span> tid <span class="token punctuation">{</span>
							flag <span class="token operator">=</span> <span class="token boolean">true</span>
						<span class="token punctuation">}</span>
						<span class="token comment">//fmt.Printf("the node in maplist is %v\n", node.Value)</span>
					<span class="token punctuation">}</span>
					<span class="token boolean">_</span><span class="token punctuation">,</span> isfinish <span class="token operator">:=</span> c<span class="token punctuation">.</span>mapfinishR<span class="token punctuation">[</span>tid<span class="token punctuation">]</span>
					flag <span class="token operator">=</span> flag <span class="token operator">||</span> isfinish
					<span class="token keyword keyword-if">if</span> flag <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
						c<span class="token punctuation">.</span>reducelist<span class="token punctuation">.</span><span class="token function">PushBack</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token comment">//fmt.Printf("The crash......\n")</span>
				<span class="token function">delete</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>mapWorker<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">//移除,将其持有的任务放入list中</span>
				<span class="token comment">//c.isCrash = true</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> c<span class="token punctuation">.</span>isShut <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"The check thread exit\n"</span><span class="token punctuation">)</span>
			<span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-return">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一部分的设计,简而言之就是周期性地检查<code>mapWorker</code>.如果其中某个节点的已经过期了,就判断为此<code>worker</code>宕机,所以这个时候就跟绝<code>workerState</code>中记录的其所处理的<code>task</code>的状态,其中这个任务记录的是这个<code>worker</code>最近一次处理的任务类型和tid,所以这个任务有可能早已运行完了,也可能正在运行.所以对于这个响应的任务,首先判断<code>待分配任务队列</code>里有没有,这个队列里的任务一定是还没有完成的,需要分配的.除此之外,还需要判断这个任务有没有完成,如果已经完成所以就免了.最后如果符合“(待分配队列中没有&amp;&amp;未完成)”的任务,才会加入到<code>待分配队列</code>中.最后,对于这个<code>worker</code>再`<code>mapWorker</code>中对应的项,也将会被移除.</p>
<p>由于这是一个单独的线程,所以对于其退出的判断也需要点讲究,所以每次还会检查<code>isShut</code>是否为真,否则就会返回.</p>
<p>至此,关于<code>master</code>的主干部分就说完了.</p>
<h3 id="worker">2) worker</h3>
<p><code>worker</code>的实现相对比较复杂.</p>
<p><code>worker</code>相比<code>master</code>来说,只需要记录与自己有关的数据和信息就行了.对于一个<code>worker</code>来说,其全局性的信息如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-const">const</span> <span class="token punctuation">(</span> <span class="token comment">//表示状态机的状态</span>
	IdleState     <span class="token operator">=</span> <span class="token number">0</span>
	MapState      <span class="token operator">=</span> <span class="token number">1</span>
	ReduceState   <span class="token operator">=</span> <span class="token number">2</span>
	FinishedState <span class="token operator">=</span> <span class="token number">3</span>
	EndState      <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">)</span>
<span class="token keyword keyword-type">type</span> worker <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	state      <span class="token builtin">int</span> <span class="token comment">//状态,用于状态机的表示</span>
	wid        <span class="token builtin">int</span> <span class="token comment">//这个worker的编号</span>
	taskDoing  Task <span class="token comment">//正在做的任务</span>
	taskFinish Task <span class="token comment">//已经完成的任务</span>
	funcM      <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>KeyValue <span class="token comment">//Map对应的处理函数</span>
	funcR      <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">//Reduce对应的处理函数</span>
	mutex      sync<span class="token punctuation">.</span>Mutex <span class="token comment">//锁</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了便于实现,我对于<code>worker</code>采用了状态机的模式来进行处理,不过也不算非常规范的状态机.其中</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2015%2013%2050%2043%201657864243%201657864243457%20ZJqHqi%20image-20220715135043336%20.png" alt="image-20220715135043336" style="zoom:33%;"></p>
<p>对于各个状态:</p>
<ul>
<li>IdleState,就是初始状态,出于此状态时发送任务请求,如果没有任务仍然保持在Idle否则,进入Mapping或者Reducing.</li>
<li>Mapping,Reducing,调用相应的处理函数,处理完就进入<code>Complated</code>状态.</li>
<li>Completed,向<code>master</code>发送完成信号,之后进入Idle状态.</li>
<li>End状态,可以看做是一个由外部事件触发的(也就是在心跳包中如果收到<code>isShut</code>为true).</li>
</ul>
<p>其状态机相关实现如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>worker<span class="token punctuation">)</span> <span class="token function">doMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-defer">defer</span> w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-switch">switch</span> w<span class="token punctuation">.</span>state <span class="token punctuation">{</span>
	<span class="token keyword keyword-case">case</span> IdleState<span class="token punctuation">:</span> <span class="token comment">//这个时候的任务在于发送请求</span>
		task <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token function">AskForTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> MapTask <span class="token punctuation">{</span> <span class="token comment">//根据所分配的任务变化状态</span>
			w<span class="token punctuation">.</span>state <span class="token operator">=</span> MapState
			w<span class="token punctuation">.</span>taskDoing <span class="token operator">=</span> task
		<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> ReduceTask <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span>state <span class="token operator">=</span> ReduceState
			w<span class="token punctuation">.</span>taskDoing <span class="token operator">=</span> task
		<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span>TaskType <span class="token operator">==</span> IdleTask <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span>state <span class="token operator">=</span> IdleState
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-break">break</span>
	<span class="token keyword keyword-case">case</span> MapState<span class="token punctuation">:</span>
		w<span class="token punctuation">.</span><span class="token function">doMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		w<span class="token punctuation">.</span>state <span class="token operator">=</span> FinishedState
		<span class="token keyword keyword-break">break</span>
	<span class="token keyword keyword-case">case</span> ReduceState<span class="token punctuation">:</span>
		w<span class="token punctuation">.</span><span class="token function">doReduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		w<span class="token punctuation">.</span>state <span class="token operator">=</span> FinishedState
		<span class="token keyword keyword-break">break</span>
	<span class="token keyword keyword-case">case</span> FinishedState<span class="token punctuation">:</span>
		w<span class="token punctuation">.</span><span class="token function">SignalFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		w<span class="token punctuation">.</span>taskDoing <span class="token operator">=</span> Task<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">//清空</span>
		w<span class="token punctuation">.</span>taskFinish <span class="token operator">=</span> Task<span class="token punctuation">{</span><span class="token punctuation">}</span>
		w<span class="token punctuation">.</span>state <span class="token operator">=</span> IdleState
		<span class="token keyword keyword-break">break</span>
	<span class="token keyword keyword-case">case</span> EndState<span class="token punctuation">:</span>
		<span class="token keyword keyword-break">break</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外<code>running</code>是一个状态机的主线程,如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>worker<span class="token punctuation">)</span> <span class="token function">running</span><span class="token punctuation">(</span>wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-defer">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">doMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">//第一次一般就是申请任务的动作.</span>
		w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> w<span class="token punctuation">.</span>state <span class="token operator">==</span> EndState <span class="token punctuation">{</span>
			<span class="token comment">//return true //终止</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"the state is end\n"</span><span class="token punctuation">)</span>
			w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword keyword-return">return</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
		flag <span class="token operator">:=</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>state <span class="token operator">==</span> IdleState<span class="token punctuation">)</span>
		w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> flag <span class="token punctuation">{</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">//状态机采用轮询的方式</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-return">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里之所以对于IdleState状态时,进行sleep处理,是为了防止空闲状态出现过多无用的任务请求和响应包.当处于<code>EndState</code>状态时,这个线程就会终止,这也就意味着整个<code>worker</code>将要终止.</p>
<p><strong>下面是关于<code>worker</code>中心跳请求的实现</strong></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>worker<span class="token punctuation">)</span> <span class="token function">beatRequest</span><span class="token punctuation">(</span>wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-defer">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	args <span class="token operator">:=</span> BeatArgs<span class="token punctuation">{</span><span class="token punctuation">}</span>
	reply <span class="token operator">:=</span> BeatReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
	args<span class="token punctuation">.</span>WorkerId <span class="token operator">=</span> w<span class="token punctuation">.</span>wid

	w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	args<span class="token punctuation">.</span>WorkerState <span class="token operator">=</span> w<span class="token punctuation">.</span>state
	w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
		args<span class="token punctuation">.</span>DeadLine <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> w<span class="token punctuation">.</span>state <span class="token operator">==</span> EndState <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword keyword-return">return</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
		w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		ok <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"Coordinator.BeatReponse"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>
		w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"beat a time error,the wid is %v"</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>WorkerId<span class="token punctuation">)</span>
			w<span class="token punctuation">.</span>state <span class="token operator">=</span> EndState
		<span class="token punctuation">}</span>
		<span class="token keyword keyword-if">if</span> reply<span class="token punctuation">.</span>IsShut <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
			<span class="token comment">//fmt.Printf("the state is end")</span>
			w<span class="token punctuation">.</span>state <span class="token operator">=</span> EndState
			w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword keyword-return">return</span> <span class="token boolean">true</span> <span class="token comment">//心跳程序关闭</span>
		<span class="token punctuation">}</span>
		w<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">//每3秒心跳一次</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-return">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>心跳线程主要就是一个loop,所以这一部分是作为一个额外的<code>goroutine</code>存在的,与<code>running</code>作为并行的.这个loop中每隔3s进行一次,每一轮首先要获取当前时间这是RPC请求中的重要参数,除此之外,参数中还需要这个<code>worker</code>的编号与状态.这个编号用于使<code>master</code>定位此心跳对应的状态表,而这个状态则与容错的处理有关.</p>
<p>当RPC接收到请求之后,其中我们关闭机制是通过心跳包来进行通知的,所以对于reply的判断中一个<code>IsShut</code>将会决定是否将要退出.</p>
<p>除此之外,还有两个相对比较简单的RPC调用.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>worker<span class="token punctuation">)</span> <span class="token function">AskForTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Task <span class="token punctuation">{</span>
	args <span class="token operator">:=</span> AskTaskArgs<span class="token punctuation">{</span><span class="token punctuation">}</span>
	args<span class="token punctuation">.</span>Wid <span class="token operator">=</span> w<span class="token punctuation">.</span>wid
	reply <span class="token operator">:=</span> Task<span class="token punctuation">{</span><span class="token punctuation">}</span>

	ok <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"Coordinator.ReplyTask"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>
	<span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>
	<span class="token keyword keyword-return">return</span> reply
<span class="token punctuation">}</span>
<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>worker<span class="token punctuation">)</span> <span class="token function">SignalFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	args <span class="token operator">:=</span> w<span class="token punctuation">.</span>taskFinish <span class="token comment">//传递已经完成的任务的信息</span>
	reply <span class="token operator">:=</span> FinishReply<span class="token punctuation">{</span><span class="token punctuation">}</span>

	ok <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"Coordinator.GetFinishSig"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>
	<span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前者用于当<code>worker</code>处于空闲状态时,向<code>master</code>请求任务.后者用于<code>worker</code>完成一个任务时(处于完成状态)时,将任务进行通知,其中参数是一个<code>Task</code>结构体类型,这个结构体描述了一个任务.其中对于<code>w.taskFinish</code>的设置会出现在处理完<code>Map</code>和<code>Reduce</code>末尾的部分,可以将这个数据成员理解为<strong>最近一次所完成的任务</strong>.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//Map和Reduce相应的处理函数中,末尾对taskFinish进行设置</span>
w<span class="token punctuation">.</span>taskFinish<span class="token punctuation">.</span>Tid <span class="token operator">=</span> rid
w<span class="token punctuation">.</span>taskFinish<span class="token punctuation">.</span>TaskType <span class="token operator">=</span> ReduceTask
w<span class="token punctuation">.</span>taskFinish<span class="token punctuation">.</span>FilesTask <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>taskFinish<span class="token punctuation">.</span>FilesTask<span class="token punctuation">,</span> oname<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="测试">3.测试</h2>
<p>测试结果并不完美,对于<code>crash test</code>之前的测试用例可以达到100%的正确率.</p>
<p>但是对于<code>crash test</code>会存在一定的问题,偶尔也会出错,正确率一般在95%以上.</p>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2007%2023%2023%2009%2017%201658588957%201658588957672%20xu8Tux%20DD781F2F36F93AD7AFAC3781FD05EB4A%20.jpg" alt="DD781F2F36F93AD7AFAC3781FD05EB4A">
<figcaption aria-hidden="true">DD781F2F36F93AD7AFAC3781FD05EB4A</figcaption>
</figure>
<h2 id="简单地复盘">4. 简单地复盘</h2>
<p>我认为这个系统的设计,其中最核心的部分就在于心跳(状态跟踪),分配,容错.</p>
<h2 id="我的遗憾">5.我的遗憾</h2>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0.前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6%E5%92%8C%E6%80%9D%E8%B7%AF"><span class="toc-number">2.</span> <span class="toc-text">1.基本框架和思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">2.具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mastercoordinator"><span class="toc-number">3.1.</span> <span class="toc-text">1) master(coordinator)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#worker"><span class="toc-number">3.2.</span> <span class="toc-text">2) worker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">4.</span> <span class="toc-text">3.测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%9C%B0%E5%A4%8D%E7%9B%98"><span class="toc-number">5.</span> <span class="toc-text">4. 简单地复盘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E9%81%97%E6%86%BE"><span class="toc-number">6.</span> <span class="toc-text">5.我的遗憾</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/071462018.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/071462018.html&text=mit 6.824:lab 1"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/071462018.html&is_video=false&description=mit 6.824:lab 1"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=mit 6.824:lab 1&body=Check out this article: http://example.com/2022/071462018.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/071462018.html&title=mit 6.824:lab 1"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/071462018.html&name=mit 6.824:lab 1&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/071462018.html&t=mit 6.824:lab 1"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    yfs
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">首页</a></li><!--
    --><!--
      --><li><a href="/about/">关于</a></li><!--
    --><!--
      --><li><a href="/archives/">归档</a></li><!--
    -->
      </ul>
      <ul>
        
          <!-- 不蒜子统计 -->
          <span id="busuanzi_container_site_pv">
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  本站访客数<span id="busuanzi_value_site_uv"></span>人
          </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  
</footer>

<script src="/js/prism/prism.js" async></script>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
