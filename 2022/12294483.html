<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="â€‹ å…³äºè¿™ä¸ªå°é¡¹ç›®, æˆ‘å‘ç°ä¸å°‘æå®‰å…¨çš„å¤§ä½¬åœ¨å­¦ä¹ ç¼–è¯‘åŸç†éƒ½åšè¿‡, è™½ç„¶æˆ‘å’Œä»–ä»¬æƒ³è¦èµ°çš„å­¦ä¹ è·¯çº¿å¹¶ä¸ä¸€æ ·, å­¦ç¼–è¯‘åŸç†ä¹Ÿæ²¡æœ‰æƒ³ç€å»æfuzzæŒ–æ¼æ´(æ¯•ç«Ÿæˆ‘ä¸å¤ªæƒ³åšå®‰å…¨),ä½†æˆ‘è®¤ä¸ºä»–ä»¬ç¡®å®æä¾›äº†ä¸€ä¸ªæ‰å®åˆç³»ç»Ÿçš„ç¼–è¯‘åŸç†å­¦ä¹ è·¯çº¿, æˆ‘åªæ˜¯æƒ³æ»¡è¶³è‡ªå·±å†™ç¼–è¯‘å™¨çš„å°å°æ¢¦æƒ³, å¹¶ä¸”ç¼–è¯‘è¿™æ¡æŠ€èƒ½æ ‘æ‰“é€šå, ä¹Ÿå¯ä»¥è€ƒè™‘å’Œæ•°æ®åº“å†…æ ¸ç›¸ç»“åˆ, æ¯”å¦‚è¯´æŸ¥è¯¢å¼•æ“ä¼˜åŒ–ç­‰ç­‰,æˆ–è€…è¯»ç ”ä¹ƒè‡³å·¥ä½œ,ç¼–è¯‘éƒ½æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„è·¯å­. æ€»">
<meta property="og:type" content="article">
<meta property="og:title" content="LLVM IR Pass Labs">
<meta property="og:url" content="http://example.com/2022/12294483.html">
<meta property="og:site_name" content="Yfs&#39;s Box">
<meta property="og:description" content="â€‹ å…³äºè¿™ä¸ªå°é¡¹ç›®, æˆ‘å‘ç°ä¸å°‘æå®‰å…¨çš„å¤§ä½¬åœ¨å­¦ä¹ ç¼–è¯‘åŸç†éƒ½åšè¿‡, è™½ç„¶æˆ‘å’Œä»–ä»¬æƒ³è¦èµ°çš„å­¦ä¹ è·¯çº¿å¹¶ä¸ä¸€æ ·, å­¦ç¼–è¯‘åŸç†ä¹Ÿæ²¡æœ‰æƒ³ç€å»æfuzzæŒ–æ¼æ´(æ¯•ç«Ÿæˆ‘ä¸å¤ªæƒ³åšå®‰å…¨),ä½†æˆ‘è®¤ä¸ºä»–ä»¬ç¡®å®æä¾›äº†ä¸€ä¸ªæ‰å®åˆç³»ç»Ÿçš„ç¼–è¯‘åŸç†å­¦ä¹ è·¯çº¿, æˆ‘åªæ˜¯æƒ³æ»¡è¶³è‡ªå·±å†™ç¼–è¯‘å™¨çš„å°å°æ¢¦æƒ³, å¹¶ä¸”ç¼–è¯‘è¿™æ¡æŠ€èƒ½æ ‘æ‰“é€šå, ä¹Ÿå¯ä»¥è€ƒè™‘å’Œæ•°æ®åº“å†…æ ¸ç›¸ç»“åˆ, æ¯”å¦‚è¯´æŸ¥è¯¢å¼•æ“ä¼˜åŒ–ç­‰ç­‰,æˆ–è€…è¯»ç ”ä¹ƒè‡³å·¥ä½œ,ç¼–è¯‘éƒ½æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„è·¯å­. æ€»">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2012%2030%2020%2051%2018%201672404678%201672404678809%20Qc2ql6%20image-20221230205118710%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2012%2030%2020%2048%2025%201672404505%201672404505596%20RVd5PB%20image-20221230204825499%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2023%2001%2006%2020%2058%2020%201673009900%201673009900517%20orCIay%20image-20230106205820432%20.png">
<meta property="article:published_time" content="2022-12-29T08:12:56.000Z">
<meta property="article:modified_time" content="2023-01-07T03:59:53.457Z">
<meta property="article:author" content="yfs">
<meta property="article:tag" content="ç¼–è¯‘åŸç†">
<meta property="article:tag" content="llvm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2012%2030%2020%2051%2018%201672404678%201672404678809%20Qc2ql6%20image-20221230205118710%20.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>LLVM IR Pass Labs</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<link rel="stylesheet" href="/js/prism/prism.css">

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="ç›®å½•"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="ç›®å½•"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="é¡¶éƒ¨" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/about/">å…³äº</a></li><!--
     --><!--
       --><li><a href="/archives/">å½’æ¡£</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="ä¸Šä¸€ç¯‡" href="/2023/010612922.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="ä¸‹ä¸€ç¯‡" href="/2022/122854432.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="è¿”å›é¡¶éƒ¨" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="åˆ†äº«æ–‡ç« " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">ä¸Šä¸€ç¯‡</span>
      <span id="i-next" class="info" style="display:none;">ä¸‹ä¸€ç¯‡</span>
      <span id="i-top" class="info" style="display:none;">è¿”å›é¡¶éƒ¨</span>
      <span id="i-share" class="info" style="display:none;">åˆ†äº«æ–‡ç« </span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/12294483.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/12294483.html&text=LLVM IR Pass Labs"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/12294483.html&is_video=false&description=LLVM IR Pass Labs"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=LLVM IR Pass Labs&body=Check out this article: http://example.com/2022/12294483.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/12294483.html&name=LLVM IR Pass Labs&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/12294483.html&t=LLVM IR Pass Labs"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.</span> <span class="toc-text">0 .ç¯å¢ƒå‡†å¤‡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#introduction-to-llvm"><span class="toc-number"></span> <span class="toc-text">1. Introduction to LLVM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%87%BD%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">1) è¾“å‡ºå‡½æ•°ä¿¡æ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E4%BC%98%E5%8C%96%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">2) å±€éƒ¨ä¼˜åŒ–å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dataflow-analysis"><span class="toc-number"></span> <span class="toc-text">2. Dataflow Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#framework%E7%9A%84%E5%8F%AF%E5%8F%98%E5%9B%A0%E7%B4%A0%E4%B8%8E%E6%A8%A1%E7%89%88%E5%8F%82%E6%95%B0"><span class="toc-number">1.</span> <span class="toc-text">1)
Frameworkçš„å¯å˜å› ç´ ä¸æ¨¡ç‰ˆå‚æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#framework%E4%B8%AD%E7%9A%84%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">2) Frameworkä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">3) è¿­ä»£ç®—æ³•å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#loop-invariant-code-motion"><span class="toc-number"></span> <span class="toc-text">3. Loop Invariant Code Motion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E4%B8%8D%E5%8F%98%E9%87%8F%E8%AE%A1%E7%AE%97"><span class="toc-number">1.</span> <span class="toc-text">1) å¾ªç¯ä¸å˜é‡è®¡ç®—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">ä¾èµ–è®¾ç½®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">æ ¸å¿ƒæ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">æ ¸å¿ƒå®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E5%88%86%E9%85%8D"><span class="toc-number">2.</span> <span class="toc-text">2) å¯„å­˜å™¨åˆ†é…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example%E4%B8%AD%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.1.</span> <span class="toc-text">exampleä¸­çš„ç®€å•å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%8F%82%E8%80%83"><span class="toc-number"></span> <span class="toc-text">ç›¸å…³å‚è€ƒ</span></a>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        LLVM IR Pass Labs
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">yfs</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-12-29T08:12:56.000Z" itemprop="datePublished">2022-12-29</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/llvm/" rel="tag">llvm</a>, <a class="tag-link-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">ç¼–è¯‘åŸç†</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>â€‹ å…³äºè¿™ä¸ªå°é¡¹ç›®, æˆ‘å‘ç°ä¸å°‘æå®‰å…¨çš„å¤§ä½¬åœ¨å­¦ä¹ ç¼–è¯‘åŸç†éƒ½åšè¿‡,
è™½ç„¶æˆ‘å’Œä»–ä»¬æƒ³è¦èµ°çš„å­¦ä¹ è·¯çº¿å¹¶ä¸ä¸€æ ·,
å­¦ç¼–è¯‘åŸç†ä¹Ÿæ²¡æœ‰æƒ³ç€å»æfuzzæŒ–æ¼æ´(æ¯•ç«Ÿæˆ‘ä¸å¤ªæƒ³åšå®‰å…¨),ä½†æˆ‘è®¤ä¸ºä»–ä»¬ç¡®å®æä¾›äº†ä¸€ä¸ªæ‰å®åˆç³»ç»Ÿçš„ç¼–è¯‘åŸç†å­¦ä¹ è·¯çº¿,
æˆ‘åªæ˜¯æƒ³æ»¡è¶³è‡ªå·±å†™ç¼–è¯‘å™¨çš„å°å°æ¢¦æƒ³, å¹¶ä¸”ç¼–è¯‘è¿™æ¡æŠ€èƒ½æ ‘æ‰“é€šå,
ä¹Ÿå¯ä»¥è€ƒè™‘å’Œæ•°æ®åº“å†…æ ¸ç›¸ç»“åˆ,
æ¯”å¦‚è¯´æŸ¥è¯¢å¼•æ“ä¼˜åŒ–ç­‰ç­‰,æˆ–è€…è¯»ç ”ä¹ƒè‡³å·¥ä½œ,ç¼–è¯‘éƒ½æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„è·¯å­.
æ€»ä¹‹, æˆ‘è®¤ä¸ºç¼–è¯‘è¿™ä¸€å—è¿˜æ˜¯å¾ˆå€¼å¾—æ·±å…¥ä¸€å­¦çš„.</p>
<h3 id="ç¯å¢ƒå‡†å¤‡">0 .ç¯å¢ƒå‡†å¤‡</h3>
<p>è¿™ä¸ªé¡¹ç›®çš„è¿è¡Œç¯å¢ƒæ˜¯åŸºäºdockeræ„å»ºçš„, å…¶ä¸­ç»™å‡ºçš„æ–‡æ¡£ä¸­çš„å‘½ä»¤å¦‚ä¸‹:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token builtin class-name">cd</span> Assignment1-Introduction_to_LLVM/FunctionInfo
$ <span class="token function">docker</span> run -it -v <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/mnt --rm --name cscd70_a1 cscd70:2021S<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯æˆ‘è®¤ä¸ºè¿™æ ·ç”¨èµ·æ¥ä¸æ˜¯å¤ªé¡ºæ‰‹, å› æ­¤æˆ‘å¹¶ä¸æƒ³å…³æ‰å®¹å™¨å,å°±å°†å®¹å™¨åˆ é™¤,
å› æ­¤æˆ‘æ²¡æœ‰åŠ â€œ--rmâ€,æ­¤å¤–,æˆ‘å¸Œæœ›åœ¨åæ¥å†™ä»£ç çš„æ—¶å€™é€šè¿‡vscodeå¯¹å®¹å™¨ssh,
å› æ­¤å¿…é¡»è¦è®¾ç½®å®¹å™¨çš„ç«¯å£æ˜ å°„,å¹¶ä¸”é…ç½®å®¹å™¨å†…çš„sshæœåŠ¡.åœ¨è¿™é‡Œä¹Ÿç®€å•åœ°è®°å½•ä¸€ä¸‹é…ç½®çš„è¿‡ç¨‹å§.</p>
<p>ç›¸æ¯”å‰é¢çš„é‚£ä¸ªrunå‘½ä»¤,æˆ‘åšäº†ç‚¹è°ƒæ•´.</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">docker</span> run -dit -p <span class="token number">14010</span>:22 -v <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>:/mnt  --name cscd70_a1 cscd70:2021S<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>åœ¨å®¹å™¨ä¸­è®¾ç½®å¯†ç ã€æ›´æ–°æºã€å®‰è£…openssh-serverã€ä¿®æ”¹sshé…ç½®æ–‡ä»¶ã€é‡å¯sshæœåŠ¡,
ä¸€å¥—ä¸‹æ¥è½»è½¦ç†Ÿè·¯å°±å¯ä»¥äº†.</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">passwd</span>
$ <span class="token function">apt-get</span> -y <span class="token function">install</span> openssh-server
$ <span class="token function">vi</span> /etc/ssh/sshd_config
RSAAuthentication <span class="token function">yes</span>
PubkeyAuthentication <span class="token function">yes</span>
AuthorizedKeysFile .ssh/authorized_keys
PermitRootLogin <span class="token function">yes</span>
$ /etc/init.d/ssh restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¹‹åå°±å¯ä»¥ä½¿ç”¨vscode sshå®¹å™¨æ¥è¿›è¡Œå†™ä»£ç äº†.</p>
<h2 id="introduction-to-llvm">1. Introduction to LLVM</h2>
<h3 id="è¾“å‡ºå‡½æ•°ä¿¡æ¯">1) è¾“å‡ºå‡½æ•°ä¿¡æ¯</h3>
<p>è¿™ä¸€éƒ¨åˆ†çš„å®ç°ç›¸å½“ç®€å•.å¦‚ä¸‹æ‰€ç¤º:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">  <span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-bool">bool</span> <span class="token function">runOnModule</span><span class="token punctuation">(</span>Module <span class="token operator">&amp;</span>M<span class="token punctuation">)</span> <span class="token keyword keyword-override">override</span> <span class="token punctuation">{</span>
    <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"CSCD70 Function Information Pass"</span>
           <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> <span class="token operator">&amp;</span>func <span class="token operator">:</span> M<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">showFuncInfo</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// class FunctionInfo</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">FunctionInfo</span><span class="token double-colon punctuation">::</span><span class="token function">showFuncInfo</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Function <span class="token operator">&amp;</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"#Name:"</span> <span class="token operator">&lt;&lt;</span> func<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nArgs:"</span> <span class="token operator">&lt;&lt;</span> func<span class="token punctuation">.</span><span class="token function">arg_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nCalls:"</span>
            <span class="token operator">&lt;&lt;</span> func<span class="token punctuation">.</span><span class="token function">getNumUses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nBlocks:"</span> <span class="token operator">&lt;&lt;</span> func<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nInsts:"</span>
            <span class="token operator">&lt;&lt;</span> func<span class="token punctuation">.</span><span class="token function">getInstructionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç›´æ¥åœ¨Moduleä¸­éå†å‡½æ•°å°±å¯ä»¥äº†, å¯¹äºæ‰€è®¿é—®çš„å‡½æ•°,
Functionéƒ½æä¾›äº†ä¸€äº›æ¥å£è®¿é—®å†…éƒ¨ä¿¡æ¯.</p>
<h3 id="å±€éƒ¨ä¼˜åŒ–å®ç°">2) å±€éƒ¨ä¼˜åŒ–å®ç°</h3>
<p>è¿™ä¸€éƒ¨åˆ†åŒºåˆ†äº†ä¸‰ä¸ªä¸åŒçš„å­ä»»åŠ¡, ä½†å®ç°èµ·æ¥éƒ½æ˜¯å·®ä¸å¤šçš„.
è¿™é‡Œä»¥<code>MultiInstOpt</code>ä¸ºä¾‹ç®€è¦åˆ†æä¸€ä¸‹:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-bool">bool</span> <span class="token function">runOnFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span> <span class="token keyword keyword-override">override</span> <span class="token punctuation">{</span>
      std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>Instruction<span class="token operator">*</span><span class="token operator">&gt;</span> delete_list<span class="token punctuation">;</span>
      <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> <span class="token operator">&amp;</span>bb <span class="token operator">:</span> F<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> <span class="token operator">&amp;</span>curr_ins <span class="token operator">:</span> bb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>curr_ins<span class="token punctuation">.</span><span class="token function">isBinaryOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> curr_ins<span class="token punctuation">.</span><span class="token function">getOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Instruction<span class="token double-colon punctuation">::</span>Sub<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword keyword-int">int</span> curr_other_idx<span class="token punctuation">;</span>
                  <span class="token keyword keyword-auto">auto</span> curr_const_int <span class="token operator">=</span> <span class="token function">getConstIntOperand</span><span class="token punctuation">(</span>curr_ins<span class="token punctuation">,</span> <span class="token operator">&amp;</span>curr_other_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>curr_const_int <span class="token operator">==</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword keyword-auto">auto</span> other_ins <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dyn_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Instruction<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>curr_ins<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span>curr_other_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>other_ins <span class="token operator">==</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>other_ins<span class="token operator">-&gt;</span><span class="token function">isBinaryOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> other_ins<span class="token operator">-&gt;</span><span class="token function">getOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Instruction<span class="token double-colon punctuation">::</span>Add<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword keyword-int">int</span> pre_other_idx<span class="token punctuation">;</span>
                  <span class="token keyword keyword-auto">auto</span> pre_const_int <span class="token operator">=</span> <span class="token function">getConstIntOperand</span><span class="token punctuation">(</span><span class="token operator">*</span>other_ins<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pre_other_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pre_const_int <span class="token operator">==</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token comment">// ç„¶ååˆ¤æ–­å¸¸æ•°éƒ¨åˆ†çš„å€¼æ˜¯å¦ç›¸ç­‰</span>
                  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pre_const_int<span class="token operator">-&gt;</span><span class="token function">getSExtValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> curr_const_int<span class="token operator">-&gt;</span><span class="token function">getSExtValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¯ä»¥è¢«ä¼˜åŒ–</span>
                      curr_ins<span class="token punctuation">.</span><span class="token function">replaceAllUsesWith</span><span class="token punctuation">(</span>curr_ins<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span>curr_other_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      delete_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>curr_ins<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> delete_ins <span class="token operator">:</span> delete_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          delete_ins<span class="token operator">-&gt;</span><span class="token function">eraseFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸€éƒ¨åˆ†æä¾›äº†ä»¥å‡½æ•°ä¸ºå•ä½çš„å±€éƒ¨ä¼˜åŒ–,
åœ¨æ¯ä¸ªå‡½æ•°å†…éƒ¨å¯ä»¥é€šè¿‡éå†BasicBlockçš„æ–¹å¼éå†æ¯ä¸€ä¸ªæŒ‡ä»¤.
æ ¹æ®Assignmentçš„è¦æ±‚, éœ€è¦è®¿é—®å…¶ä¸­çš„æ“ä½œæ•°. ç„¶è€Œæ“ä½œæ•°æ˜¯æœ‰åŒºåˆ«çš„,
æœ‰å¯èƒ½æ˜¯åˆ«çš„æŒ‡ä»¤æ‰€å®šä¹‰çš„å˜é‡, æœ‰å¯èƒ½æ˜¯å‡½æ•°å½¢å‚, ä¹Ÿæœ‰å¯èƒ½æ˜¯å¸¸é‡.
å¦‚ä½•çŸ¥é“ç©¶ç«Ÿæ˜¯å“ªä¸€ç§ç±»å‹å‘¢?
ä»¥ä¸Šä¸‰è€…åˆ†åˆ«å¯¹åº”äº†Instructionã€Argumentã€Constantç­‰ç­‰,å¯ä»¥é€šè¿‡lllvmä¸­æ‰€æä¾›çš„isaæ¥åˆ¤æ–­(ä¹Ÿå¯ä»¥ç”¨dyn_cast).åœ¨è¿™é‡ŒåŒºåˆ†å¼€Instructionå’ŒConstantå°±å¥½äº†.</p>
<p>å¯¹äºå…¶ä¸­Constant,
å¯ä»¥é€šè¿‡<code>getSExtValue</code>æˆ–è€…<code>getZExtValue</code>åˆ†åˆ«ä»¥signedå’Œunsignedçš„æ–¹å¼è¿”å›int.</p>
<p>å…¶ä¸­éœ€è¦æ¶‰åŠåˆ°æŒ‡ä»¤åˆ é™¤, è¿™é‡Œå¯¹äºæŒ‡ä»¤åˆ é™¤é‡‡ç”¨äº†ä¸€ç§å»¶è¿Ÿçš„æŠ€å·§,
é¦–å…ˆå°†å…¶åŠ å…¥åˆ°ä¸€ä¸ªlistä¸­, æœ€åå†é€ä¸ªåˆ é™¤,
å› ä¸ºå¦‚æœåœ¨éå†æ—¶åˆ é™¤,ä¼šå¯¹éå†è¿­ä»£å™¨äº§ç”Ÿå½±å“.</p>
<p>è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„,
è¿™å…¶ä¸­æ¶‰åŠåˆ°å¯¹äºdef-useé“¾çš„è°ƒæ•´.æˆ‘ä»¬éœ€è¦åˆ é™¤ä¸€ä¸ªInstruction,
ä¹Ÿå°±æ„å‘³ç€åˆ é™¤äº†è¯¥Instructionæ‰€å¯¹åº”çš„å˜é‡,
å› æ­¤å¯¹äºå…¶ä»–å¼•ç”¨è¿‡è¯¥å˜é‡çš„åœ°æ–¹åº”è¯¥è¿›è¡Œæ›¿æ¢.</p>
<pre class="line-numbers language-none"><code class="language-none">ğ‘ = ğ‘ + 1, ğ‘ = ğ‘-1 â‡’ ğ‘ = ğ‘+1, ğ‘ = ğ‘<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™é‡Œç»™å‡ºæ¥çš„æ ·å­åƒæ˜¯æ›¿æ¢æŒ‡ä»¤, æˆ‘æœ€åˆçš„æƒ³æ³•æ˜¯â€œå…ˆåˆ é™¤å†åˆ›å»ºâ€,
ä½†è¿™å®é™…ä¸Šèµ°äº†å¼¯è·¯,
åªè¦å°†â€œc=a-1â€åˆ é™¤,è€Œå¼•ç”¨è¿‡cçš„åœ°æ–¹éƒ½æ¢æˆbå°±å¥½äº†.è¿™é‡Œéœ€è¦ä½¿ç”¨åˆ°<code>replaceAllUsesWith</code>,
å…¶ä¸­çš„å‚æ•°å°±å¯¹åº”äº†b.</p>
<blockquote>
<p>è¿™é‡ŒçœŸçš„å¯ä»¥ä½“ä¼šåˆ°SSAçš„ä¼˜è¶Šæ€§, å¦‚æœæ²¡æœ‰SSA,
å¼•ç”¨çš„å˜é‡å°±æ— æ³•ç›´æ¥è·å–å…¶å¯¹åº”çš„defæŒ‡ä»¤.
SSAå¯ä»¥ä½¿å¾—æ¯ä¸ªuseå’Œdeféƒ½èƒ½ä¸€ä¸€å¯¹åº”.</p>
</blockquote>
<h2 id="dataflow-analysis">2. Dataflow Analysis</h2>
<p>è¿™ä¸€éƒ¨åˆ†çš„å®ç°éœ€è¦å¯¹å¸¸ç”¨çš„æ•°æ®æµåˆ†æç®—æ³•çš„æ¨¡ç‰ˆæœ‰æ‰€ç†è§£:</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2012%2030%2020%2051%2018%201672404678%201672404678809%20Qc2ql6%20image-20221230205118710%20.png" alt="image-20221230205118710" style="zoom:50%;"></p>
<h3 id="frameworkçš„å¯å˜å› ç´ ä¸æ¨¡ç‰ˆå‚æ•°">1)
Frameworkçš„å¯å˜å› ç´ ä¸æ¨¡ç‰ˆå‚æ•°</h3>
<p>æ´»è·ƒå˜é‡åˆ†æå’Œå¯ç”¨è¡¨è¾¾å¼åˆ†æéƒ½æ˜¯ä¸€ç§è¿­ä»£ç®—æ³•.
å…¶ä¸­å·®åˆ«ä¹Ÿä¸»è¦åœ¨äºä¸Šé¢æ‰€è®¾è®¡çš„ä¸€äº›æ•°æ®ç»“æ„.ä¸‹é¢å°±ä»è¿™äº›æ•°æ®ç»“æ„çš„è§’åº¦å»ç†è§£å®ç°è¿™ä¸ªframeworkçš„å…³é”®è¦ç´ .</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2012%2030%2020%2048%2025%201672404505%201672404505596%20RVd5PB%20image-20221230204825499%20.png" alt="image-20221230204825499" style="zoom:50%;"></p>
<p>é¦–å…ˆ, è¿™å…¶ä¸­éœ€è¦å°†ä¸åŒç±»å‹çš„æ•°æ®ç»“æ„æˆ–å‚æ•°å¸¦å…¥åˆ°è¯¥Frameworkä¸­,
å› æ­¤Frameworkä¹Ÿå°±å¾ˆè‡ªç„¶åœ°è®¾è®¡æˆäº†ä¸€ä¸ªæ¨¡ç‰ˆç±».å…¶ä¸­çš„å‚æ•°ä¹Ÿæ­£åˆè¡¨æ ¼æ‰€æåˆ°çš„å› ç´ æœ‰å…³.ä¸‹é¢æ‰€åˆ—ä¸¾çš„è¿™äº›å› ç´ éƒ½å¯¹åº”äº†Frameworkä¸­çš„æ¨¡ç‰ˆå‚æ•°:</p>
<ul>
<li><p>â€œåŸŸâ€è¿™ä¸€éƒ¨åˆ†, åˆ†åˆ«æ˜¯å˜é‡ä¹Ÿå¯ä»¥æ˜¯è¡¨è¾¾å¼.
æˆ‘æœ€åˆè®¤ä¸ºè¿™ä¸¤è€…éƒ½å¯ä»¥ç”¨Instructionæ¥è¡¨ç¤º, å°±ä¸å†éœ€è¦é¢å¤–çš„å°è£…äº†,
ä½†å…¶å®ä¸ç„¶, å…³äºå˜é‡è¿˜éœ€è¦åŒ…æ‹¬Argument,
ä¹Ÿå°±æ˜¯å‡½æ•°å‚æ•°.å› æ­¤åœ¨å®éªŒä¸­éœ€è¦åˆ†åˆ«å¯¹ä¸¤è€…è¿›è¡Œå°è£…,
ä¹Ÿå°±æ˜¯Variableå’ŒExpression</p></li>
<li><p>â€œæ–¹å‘â€œ.éå†çš„æ–¹å‘æ‰€å½±å“çš„æ˜¯åœ¨è¿™ä¸ªFunctionPassä¸­æ‰€éœ€è¦éå†æŒ‡ä»¤çš„é¡ºåºä¸åŒ,
å› æ­¤å¯ä»¥è€ƒè™‘ä¸åŒçš„â€æ–¹å‘â€œ è¿”å›ä¸åŒæ–¹å¼çš„è¿­ä»£å™¨.
ä¹‹åéå†å¤„ç†çš„éƒ¨åˆ†å°±å¯ä»¥å…±ç”¨åŒä¸€ç§ä»£ç å®ç°äº†.<strong>æ‰€ä»¥åœ¨å…·ä½“å®ç°ä¸­,
éœ€è¦ç¼–å†™ä»£ç æ¥è¿”å›ä¸åŒç§ç±»çš„è¿­ä»£å™¨(é€†å‘æˆ–è€…æ­£å‘).</strong></p></li>
<li><p>â€äº¤æ±‡æ–¹å‘â€œ,
ä¹Ÿå°±æ˜¯æ–¹ç¨‹ç»„æ±‚è§£è¿‡ç¨‹ä¸­æ‰€æ¶‰åŠçš„è¿ç®—.å¯¹åº”MeetOpä¸­å…³äºIntersectå’ŒUnionçš„å®ç°.</p></li>
</ul>
<p>å…¶ä»–å› ç´ éƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ä»£ç å¤„ç†,
æ— éœ€ä½œä¸ºâ€œå¯å˜å› ç´ â€,åœ¨åé¢è¯¦ç»†åˆ†æ.</p>
<p>åœ¨Frameworkç±»ä¸­å…¶æ¨¡ç‰ˆå‚æ•°å¦‚ä¸‹:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-template">template</span> <span class="token operator">&lt;</span><span class="token keyword keyword-typename">typename</span> <span class="token class-name">TDomainElem</span><span class="token punctuation">,</span> <span class="token keyword keyword-typename">typename</span> <span class="token class-name">TDomainElemRepr</span><span class="token punctuation">,</span> Direction TDirection<span class="token punctuation">,</span>
          <span class="token keyword keyword-typename">typename</span> <span class="token class-name">TMeetOp</span><span class="token operator">&gt;</span>  <span class="token comment">//</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">Framework</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>TDomainElem</code>å¯¹åº”çš„æ­£æ˜¯åŸŸ, è¦ä¹ˆæ˜¯Expression,
è¦ä¹ˆæ˜¯Variable.ç¬¬äºŒä¸ªå‚æ•°åœ¨è¿™ä¸¤è€…åˆ†æä¸­éƒ½æ˜¯boolç±»å‹,
è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªExpression/Variableæ˜¯å¦å¯ç”¨/æ´»è·ƒ.ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæšä¸¾ç±»(åˆ†ä¸ºå‘å‰å’Œå‘å),
è¡¨ç¤ºçš„æ˜¯ä¼ é€’æ–¹å‘.ç¬¬å››ä¸ªå‚æ•°ä»£è¡¨äº†äº¤æ±‡è¿ç®—ç¬¦.</p>
<h3 id="frameworkä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„">2) Frameworkä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„</h3>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-protected">protected</span><span class="token operator">:</span>
  <span class="token comment">// Domahein</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>TDomainElem<span class="token operator">&gt;</span> Domain<span class="token punctuation">;</span>  <span class="token comment">// Domainæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼çš„é›†åˆ</span>
  <span class="token comment">// Instruction-Domain Value Mapping</span>
  std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword keyword-const">const</span> Instruction <span class="token operator">*</span><span class="token punctuation">,</span> DomainVal_t<span class="token operator">&gt;</span> InstDomainValMap<span class="token punctuation">;</span>  <span class="token comment">// è¿™ä¸ªmapè¡¨ç¤ºçš„æ˜¯æŸä¸ªæŒ‡ä»¤bitmap</span>
  std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword keyword-const">const</span> Value <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span><span class="token operator">&gt;</span> InstIndexMap<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‰è€…æ˜¯æ”¶é›†çš„è¯¥Functionä¸­æ‰€æœ‰åŸŸçš„é›†åˆ.<code>InstDomainValMap</code>æ˜¯æ¯ä¸ªInstructionå¯¹åº”çš„bitmap,
åœ¨æ­£å‘è¿­ä»£ä¸­, è¯¥bitmapæ˜¯æ¯ä¸ªè¡¨è¾¾å¼çš„OUTé›†åˆ, å¦‚æœæ˜¯åå‘çš„,
åˆ™æ˜¯INé›†åˆ.<code>InstIndexMap</code>æ˜¯æˆ‘åŠ ä¸Šäº†,
ç”¨æ¥è®°å½•æ¯ä¸ªDomainåœ¨Bitmapä¸­çš„ç´¢å¼•,
æ— è®ºæ˜¯Variableè¿˜æ˜¯Exprssion(æˆ‘åœ¨Expressionä¸­å¢åŠ äº†è¯¥è¡¨è¾¾å¼æ‰€å¯¹åº”çš„ValueæŒ‡é’ˆä¸ºæ•°æ®æˆå‘˜)éƒ½å¯¹åº”äº†ä¸€ä¸ªValue,
åˆ©ç”¨å¤šæ€çš„ç‰¹æ€§å¯ä»¥ç»Ÿä¸€ç”¨ValueæŒ‡é’ˆæ¥è¡¨ç¤º.</p>
<h3 id="è¿­ä»£ç®—æ³•å®ç°">3) è¿­ä»£ç®—æ³•å®ç°</h3>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-bool">bool</span> <span class="token function">runOnFunction</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// initialize the domain</span>
  <span class="token function">initializeDomain</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// é¦–å…ˆå¯¹Domainè¿›è¡Œåˆå§‹åŒ–</span>
  <span class="token comment">// apply the initial conditions</span>
  TMeetOp MeetOp<span class="token punctuation">;</span>
  <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-auto">auto</span> <span class="token operator">&amp;</span>Inst <span class="token operator">:</span> <span class="token function">instructions</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    InstDomainValMap<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Inst<span class="token punctuation">,</span> MeetOp<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span>Domain<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// æ­¤æ—¶è¯¥mapæ¯ä¸ªkeyå¯¹åº”ä¸€ä¸ªInstructionï¼Œ å…¶ä¸­çš„é›†åˆä¸ºå…¨false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token function">traverseCFG</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// éå†cfgï¼Œ ä¹Ÿå°±å¯¹åº”äº†ç®—æ³•æ ¸å¿ƒè¿­ä»£éƒ¨åˆ†</span>
  <span class="token punctuation">}</span>
  <span class="token function">printInstDomainValMap</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// æ‰“å°å‡ºæ¥ç»“æœ</span>
  <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­è¿­ä»£ç®—æ³•çš„æ€»ä½“ä»£ç æµç¨‹å¦‚ä¸Šæ‰€ç¤º.<code>initializeDomain</code>é€šè¿‡éå†æ¯ä¸ªInstructionæ¥æ”¶é›†Domain.è¿™ä¸€éƒ¨åˆ†å¯¹äºLivenesså’ŒAvailExpræœ‰ä¸åŒçš„å®ç°æ–¹å¼.ç„¶åæ˜¯å®šä¹‰MeetOp,
åˆå§‹åŒ–æ¯ä¸€ä¸ªè¡¨è¾¾å¼çš„Bitmapé›†åˆ, åœ¨åé¢çš„å®ç°ä¸­,
éƒ½æ˜¯å°†å…¶è¾“å‡ºåŒ–ä¸ºå…¨0çš„é›†åˆ.ä¹‹åwhile(traverseCFG(F))è¿­ä»£.æœ€ç»ˆè¾“å‡ºç»“æœ.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-void">void</span> <span class="token function">initializeDomain</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-auto">auto</span> <span class="token operator">&amp;</span>Inst <span class="token operator">:</span> <span class="token function">instructions</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// æ ¹æ®å‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªæŒ‡ä»¤æ¥å¯¹Domainè¿›è¡Œåˆå§‹åŒ–</span>
        <span class="token function">initializeDomainFromInst</span><span class="token punctuation">(</span>Inst<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// æ¯ä¸ªæŒ‡ä»¤éƒ½æœ‰useå’Œdefé›†åˆ</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šé¢çš„<code>initializeDomaininFromInst</code>æ˜¯ä¸€ä¸ªçº¯è™šå‡½æ•°,
åœ¨AvailExprå’ŒLivenessä¸­æœ‰ä¸åŒæ–¹å¼çš„å®ç°:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"> <span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-void">void</span> <span class="token function">initializeDomainFromInst</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Instruction <span class="token operator">&amp;</span>Inst<span class="token punctuation">)</span> <span class="token keyword keyword-override">override</span> <span class="token punctuation">{</span>  <span class="token comment">// AvailExpr</span>
   <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> BinaryOperator <span class="token operator">*</span><span class="token keyword keyword-const">const</span> BinaryOp <span class="token operator">=</span>
           <span class="token generic-function"><span class="token function">dyn_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>BinaryOperator<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Inst<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       InstIndexMap<span class="token punctuation">[</span><span class="token operator">&amp;</span>Inst<span class="token punctuation">]</span> <span class="token operator">=</span> Domain<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       Domain<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token operator">*</span>BinaryOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-void">void</span> <span class="token function">initializeDomainFromInst</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Instruction <span class="token operator">&amp;</span>Inst<span class="token punctuation">)</span> <span class="token keyword keyword-override">override</span> <span class="token punctuation">{</span>  <span class="token comment">// Liveness</span>
       <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> op_it <span class="token operator">=</span> Inst<span class="token punctuation">.</span><span class="token function">op_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> op_it <span class="token operator">!=</span> Inst<span class="token punctuation">.</span><span class="token function">op_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>op_it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword keyword-auto">auto</span> operand <span class="token operator">=</span> op_it<span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dyn_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Argument<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>operand<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token generic-function"><span class="token function">dyn_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Instruction<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>operand<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword keyword-auto">auto</span> findit <span class="token operator">=</span> InstIndexMap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>operand<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>findit <span class="token operator">==</span> InstIndexMap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   InstIndexMap<span class="token punctuation">[</span>operand<span class="token punctuation">]</span> <span class="token operator">=</span> Domain<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   Domain<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token function">Variable</span><span class="token punctuation">(</span>operand<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Expressionè¿™ä¸ªæ¦‚å¿µåœ¨LLVMä¸­æ›´åŠ å‡†ç¡®åœ°è¯´å¯¹åº”çš„æ˜¯BinaryOperatorè¿™ä¸€æ¦‚å¿µ,
å¦‚æœå½“å‰éå†çš„Instructionç¬¦åˆè¯¥ç±»å‹å°±å°†å…¶åŠ å…¥åŒæ—¶è®°å½•å…¶Index.åœ¨Livenessä¸­,é€šè¿‡æ£€æŸ¥æ“ä½œæ•°çš„æ–¹å¼è¿›è¡Œæ”¶é›†,
å…¶ä¸­éœ€è¦Argumentå’ŒInstruction(å‰è€…å®¹æ˜“é—æ¼). æˆ‘æœ€åˆåœ¨å®ç°æ—¶,
è€ƒè™‘çš„ä¸æ˜¯éå†æ“ä½œæ•°, è€Œæ˜¯ç›´æ¥éå†Instructionæœ¬èº«,ä¹Ÿå°±æ˜¯def.
ä½†è¿™å®é™…ä¸Šä¼šé€ æˆå¯¹Argumentçš„é—æ¼.</p>
<p>å…¶ä¸­è¿­ä»£ç®—æ³•çš„æ ¸å¿ƒ, ä¹Ÿå°±æ˜¯è¿­ä»£ç®—æ³•çš„æ ¸å¿ƒéƒ¨åˆ†,
è¿™ä¸€éƒ¨åˆ†æ ¹æ®å„ç§æ•™ç§‘ä¹¦ä¸­ç»™å‡ºçš„ä¼ªä»£ç å°±å¾ˆå®¹æ˜“å®ç°:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-bool">bool</span> <span class="token function">traverseCFG</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-bool">bool</span> has_changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// ç”¨æ¥è¡¨ç¤ºæ˜¯å¦æœ‰blockå‘ç”Ÿäº†å˜åŒ–</span>
    DomainVal_t ibv<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> <span class="token operator">&amp;</span>bb <span class="token operator">:</span> <span class="token function">getBBTraversalOrder</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// è¿™é‡Œç”¨çš„åŸºæœ¬å—æ˜¯forwardçš„é¡ºåº</span>
        ibv <span class="token operator">=</span> <span class="token function">getBoundaryVal</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// é¦–å…ˆè·å–æ‰€æœ‰å‰é©±ç»“ç‚¹meetèµ·æ¥çš„ç»“æœ</span>
        <span class="token keyword keyword-bool">bool</span> is_changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// ç”¨æ¥è¡¨ç¤ºè¯¥blockæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–</span>
        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> <span class="token operator">&amp;</span>ins <span class="token operator">:</span> <span class="token function">getInstTraversalOrder</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            is_changed <span class="token operator">=</span> <span class="token function">transferFunc</span><span class="token punctuation">(</span>ins<span class="token punctuation">,</span> ibv<span class="token punctuation">,</span> InstDomainValMap<span class="token punctuation">[</span><span class="token operator">&amp;</span>ins<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ibv <span class="token operator">=</span> InstDomainValMap<span class="token punctuation">[</span><span class="token operator">&amp;</span>ins<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// è®¾ç½®å¥½ä¸‹ä¸€ä¸ªInstructionéœ€è¦çš„å…¥å£é›†åˆ(æœ‰å¯èƒ½æ˜¯inä¹Ÿå¯èƒ½æ˜¯out)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ­¤æ—¶çš„ibvåœ¨Livenessä¸­æ˜¯è¯¥blockçš„inï¼Œåœ¨AvialExprä¸­æ˜¯blockä¸­çš„outï¼Œchangeä¹Ÿå°±æ˜¯è¡¨ç¤ºçš„è¯¥</span>
        <span class="token comment">// outæˆ–è€…inæ˜¯å¦å‘ç”Ÿå˜åŒ–</span>
        has_changed <span class="token operator">|=</span> is_changed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> has_changed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‚è€ƒ:</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2023%2001%2006%2020%2058%2020%201673009900%201673009900517%20orCIay%20image-20230106205820432%20.png" alt="image-20230106205820432" style="zoom:50%;"></p>
<p>ç®€è€Œè¨€ä¹‹, æ¯æ¬¡è¿­ä»£éƒ½ä»¥åŸºæœ¬å—ä¸ºå•ä½, é¦–å…ˆéœ€è¦è·å–çš„æ˜¯out[p]é›†åˆ,
é€šè¿‡<code>getBBTraversalOrder</code>å³å¯è·å–,
å¹¶è®¾ç½®ä¸ºå½“å‰éå†å—çš„iné›†åˆ, ä¹‹åå¦‚æœæƒ³è¦å®ç°â€œoldout = out[i]â€,
åˆ™éœ€è¦å°†æ­¤BasicBlockçš„æŒ‡ä»¤ä»å¤´åˆ°å°¾è¿­ä»£ä¸€é,
å¯¹å…¶è°ƒç”¨transferFunc.å½“å¾ªç¯é€€å‡ºå,
is_changedè¡¨ç¤ºçš„å°±æ˜¯è¯¥BasicBlockçš„outæ˜¯å¦å‘ç”Ÿå˜åŒ–.æœ€ç»ˆè¦è¿”å›çš„has_changedè¡¨ç¤ºçš„åˆ™æ˜¯è¿™æ•´ä¸€è½®è¿­ä»£æ˜¯å¦å‡ºç°å˜åŒ–.</p>
<p>å…³äºtransferFunc.æœ‰è¶£çš„æ˜¯,åœ¨ä¸åŒè¿­ä»£æ–¹å‘ä¸‹,IVå’ŒOVçš„æ„ä¹‰æœ‰æ‰€ä¸åŒ,å½“ä¸ºForwardæ—¶,IVå¯¹åº”çš„æ­£æ˜¯iné›†åˆ,OVåˆ™æ˜¯æ‰€è¦æ±‚çš„out;å¦‚æœæ˜¯backendæ–¹å‘,IVå¯¹åº”çš„åˆ™æ˜¯out,OVæ˜¯iné›†åˆ.â€œOVâ€æ˜¯éœ€è¦é€šè¿‡â€œIVâ€œè¿›è¡Œæ›´æ–°çš„,å…¶è¿”å›å€¼è¡¨ç¤ºOVæœ‰æ²¡æœ‰å‘ç”Ÿæ”¹å˜.ä¹Ÿå°±å¯¹åº”äº†å‰é¢çš„is_changedçš„è®¾ç½®.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-bool">bool</span> <span class="token function">transferFunc</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Instruction <span class="token operator">&amp;</span>Inst<span class="token punctuation">,</span> <span class="token keyword keyword-const">const</span> DomainVal_t <span class="token operator">&amp;</span>IV<span class="token punctuation">,</span>
                          DomainVal_t <span class="token operator">&amp;</span>OV<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å…³äºå…¶ä¸­çš„ä¼ é€’å‡½æ•°, ä¸¤è€…çš„å®ç°æœ‰æ‰€åŒºåˆ«:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-bool">bool</span> <span class="token class-name">Liveness</span><span class="token double-colon punctuation">::</span><span class="token function">transferFunc</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Instruction <span class="token operator">&amp;</span>Inst<span class="token punctuation">,</span> <span class="token keyword keyword-const">const</span> DomainVal_t <span class="token operator">&amp;</span>IBV<span class="token punctuation">,</span> DomainVal_t <span class="token operator">&amp;</span>OBV<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DomainVal_t OLD_OBV <span class="token operator">=</span> OBV<span class="token punctuation">;</span>
    OBV <span class="token operator">=</span> IBV<span class="token punctuation">;</span>
    <span class="token comment">// å°†è¯¥Inst defçš„éƒ¨åˆ†å»é™¤æ‰</span>
    <span class="token keyword keyword-auto">auto</span> find_def_it <span class="token operator">=</span> InstIndexMap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>find_def_it <span class="token operator">!=</span> InstIndexMap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// è¡¨ç¤ºè¯¥æŒ‡ä»¤å­˜åœ¨ä¸€ä¸ªdef</span>
        OBV<span class="token punctuation">[</span>find_def_it<span class="token operator">-&gt;</span>second<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†useçš„éƒ¨åˆ†åˆå¹¶ä¸Š</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> op_it <span class="token operator">=</span> Inst<span class="token punctuation">.</span><span class="token function">op_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> op_it <span class="token operator">!=</span> Inst<span class="token punctuation">.</span><span class="token function">op_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>op_it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-auto">auto</span> operand <span class="token operator">=</span> op_it<span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">dyn_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Argument<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>operand<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token generic-function"><span class="token function">dyn_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Instruction<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>operand<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-auto">auto</span> findit <span class="token operator">=</span> InstIndexMap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>operand<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>findit <span class="token operator">!=</span> InstIndexMap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">// å¦‚æœè¯¥defä¹‹å‰æ˜¯å­˜åœ¨çš„è¯</span>
                OBV<span class="token punctuation">[</span>findit<span class="token operator">-&gt;</span>second<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// æ¯”è¾ƒæ˜¯å¦å‘ç”Ÿäº†æ›´æ–°</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> IBV<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>OBV<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> OLD_OBV<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šé¢æ˜¯æ´»è·ƒå˜é‡éƒ¨åˆ†çš„å®ç°,é¦–å…ˆéœ€è¦ä¿å­˜OLD_OBV, ç„¶åè®¾ç½®æ–°çš„OBV,
æ–°çš„OBVå°±æ˜¯INé›†åˆå»æ‰defå¹¶ä¸Šuse.å¯¹äºdefçš„å¤„ç†å¾ˆç®€å•,Instæœ¬èº«å°±æ˜¯def.è‡³äºuseè¿˜æ˜¯é€šè¿‡è®¿é—®operandçš„æ–¹æ³•,é€šè¿‡dyn_caståˆ¤æ–­æ˜¯å¦ä¸ºArgumentæˆ–è€…Instructionç±»å‹.æœ€åæ¯”è¾ƒæ˜¯å¦æœ‰chenged.</p>
<h2 id="loop-invariant-code-motion">3. Loop Invariant Code Motion</h2>
<p>æ„Ÿè§‰åˆ°äº†Assignment3è¿™ä¸€éƒ¨åˆ†éš¾åº¦æ˜æ˜¾ä¸Šæ¥äº†å‘¢.<strong>å°¤å…¶æ˜¯å¯„å­˜å™¨åˆ†é…æ˜¯æ–°åŠ çš„éƒ¨åˆ†,æˆ‘å°è¯•ç€å»å®ç°,ä½†æ˜¯å¤±è´¥äº†ğŸ˜­.</strong></p>
<h3 id="å¾ªç¯ä¸å˜é‡è®¡ç®—">1) å¾ªç¯ä¸å˜é‡è®¡ç®—</h3>
<p>å…³äºå¾ªç¯ä¸å˜é‡ç›¸å…³çš„ä»£ç æ¶ˆé™¤,å…¶æ ¸å¿ƒç®—æ³•æœ‰ä¸¤ä¸ªå…³é”®:</p>
<ul>
<li><strong>å¦‚ä½•åˆ¤æ–­å¾ªç¯ä¸å˜é‡?</strong>å¾ªç¯ä¸å˜é‡æ¶‰åŠåˆ°çš„éƒ½æ˜¯ç”±BinaryOperatorå®šä¹‰çš„,å› æ­¤å–å†³äºå…¶Operand.è¯¥Operandåº”æ»¡è¶³ä¸€ä¸‹æ¡ä»¶:(1)æ˜¯Constant;(2)å·²ç»ç¡®å®šä¸ºå¾ªç¯ä¸å˜é‡;(3)æ”¹å˜é‡çš„å®šä¹‰ä¸å¤„äºè¯¥Loop,å¹¶ä¸”å¤„äºå¤–éƒ¨.å½“æ‰€æœ‰Operandéƒ½ç¬¦åˆä¸‰ä¸ªæ¡ä»¶ä¹‹ä¸€æ—¶,æ­¤è¡¨è¾¾å¼å°±æ˜¯ä¸€ä¸ªå¾ªç¯ä¸å˜é‡.</li>
<li><strong>ä»€ä¹ˆæ ·çš„å¾ªç¯ä¸å˜é‡å¯ä»¥å¤–æ?</strong>è¯¥å¾ªç¯ä¸å˜é‡æ‰€å¯¹åº”çš„è¡¨è¾¾å¼(Instruction)åŒæ—¶ä¸ºæ‰€æœ‰exit
blockçš„æ”¯é…ç»“ç‚¹.</li>
</ul>
<p>æ­¤ç®—æ³•ä»ç„¶æ˜¯ä¸€ä¸ªè¿­ä»£ç®—æ³•,
è¿­ä»£ç®—æ³•ä¼šåœ¨æ¯ä¸€æ¬¡è¿­ä»£æ›´æ–°ä¸€ä¸ªå¾ªç¯ä¸å˜é‡çš„é›†åˆ,å½“å¾ªç¯ä¸å˜é‡çš„é›†åˆå’Œä¸Šä¸€è½®æ²¡æœ‰å‘ç”Ÿå˜åŒ–æ—¶,è¿­ä»£ç»“æŸ.</p>
<blockquote>
<p><strong>å…³äºè¿­ä»£ç®—æ³•çš„ç®€å•æ€è€ƒ</strong></p>
<p>å‰é¢çš„æ´»è·ƒåˆ†æã€å¯ç”¨è¡¨è¾¾å¼ä»¥åŠè¿™é‡Œçš„å¾ªç¯ä¸å˜é‡è®¡ç®—éƒ½ç”¨åˆ°äº†è¿­ä»£ç®—æ³•.ä¹Ÿå¾ˆæ˜¾ç„¶å®ƒä»¬æœ‰å…±åŒä¹‹å¤„,å³æ›´æ–°æ—¶éœ€è¦æ ¹æ®ä¸€äº›ä¸å˜ä¿¡æ¯(æ¯”å¦‚æ´»è·ƒåˆ†æä¸­çš„defå’Œuseé›†åˆ,å¾ªç¯ä¸å˜é‡è®¡ç®—ä¸­å…³äºConstantå’Œæ˜¯å¦å¤„äºå¤–éƒ¨å¾ªç¯çš„åˆ¤æ–­),ä¹Ÿéœ€è¦æ ¹æ®ä¸€äº›å˜åŒ–çš„ä¿¡æ¯(ä¹Ÿå°±æ˜¯æ¯ä¸€æ¬¡è¿­ä»£è¦æ›´æ–°çš„ä¿¡æ¯,æ¯”å¦‚è¯´æ´»è·ƒåˆ†æä¸­çš„OUTé›†åˆ,å¾ªç¯ä¸å˜é‡è®¡ç®—ä¸­çš„ä¸å˜é‡é›†åˆ),ä¸€æ—¦è¿™äº›å˜åŒ–çš„ä¿¡æ¯æ²¡æœ‰å‘ç”Ÿæ”¹å˜,æ¥ä¸‹æ¥è¿­ä»£ä¸­çš„æ‰€æœ‰ä¿¡æ¯ä¹Ÿå°±éƒ½æˆäº†â€œä¸å˜ä¿¡æ¯â€,å› æ­¤æ¥ä¸‹æ¥æ— è®ºè¿›è¡Œå¤šå°‘è¿­ä»£,å…¶ç»“æœéƒ½ä¸ä¼šå‘ç”Ÿæ”¹å˜,å› æ­¤å¯ä»¥åˆ¤å®šä¸ºè¿­ä»£ç»“æŸ.</p>
</blockquote>
<h4 id="ä¾èµ–è®¾ç½®">ä¾èµ–è®¾ç½®</h4>
<p>å…³äºLoopæœ‰å…³çš„ä¼˜åŒ–,
éœ€è¦äº†è§£ä¸€äº›ä¸å¾ªç¯ç›¸å…³çš„ä¿¡æ¯,ä»¥åŠæ§åˆ¶æµå›¾ä¸­çš„å¾ªç¯ä¿¡æ¯(æ¯”å¦‚è¯´å¾ªç¯ä¸­çš„æ”¯é…ç»“ç‚¹ç­‰).è€Œè¿™äº›ä¿¡æ¯éƒ½ä¸æ˜¯LLVMåº“ç›´æ¥æä¾›çš„,è€Œæ˜¯ç»è¿‡å‰é¢çš„æ•°æ®æµåˆ†ææ‰€è·å¾—çš„,æ‰€ä»¥éœ€è¦å¢åŠ ä¾èµ–,è¡¨ç¤ºè¿™ä¸€éƒ¨åˆ†Passéœ€è¦å€Ÿç”¨ä¹‹å‰çš„ä¸€äº›åˆ†æç»“æœæ¥è¿›è¡Œå¤„ç†.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-void">void</span> <span class="token function">getAnalysisUsage</span><span class="token punctuation">(</span>AnalysisUsage <span class="token operator">&amp;</span>AU<span class="token punctuation">)</span> <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-override">override</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @todo(cscd70) Request the dominator tree and the loop simplify pass.
   */</span>
  AU<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">addRequired</span><span class="token generic class-name"><span class="token operator">&lt;</span>DominatorTreeWrapperPass<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// ç”¨äºæ£€æŸ¥æŸä¸ªInstructionæ˜¯å¦æ˜¯æ”¯é…ç»“ç‚¹</span>
  AU<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">addRequired</span><span class="token generic class-name"><span class="token operator">&lt;</span>LoopInfoWrapperPass<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  AU<span class="token punctuation">.</span><span class="token function">setPreservesCFG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// ä¿ç•™ä¹‹å‰æ‰€æ±‚å‡ºçš„æ•°æ®æµå›¾çš„ç»“æœ.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>getAnalysisUsage</code>ä¹Ÿæ˜¯å¾ˆå¤šPasséœ€è¦overrideçš„æ–¹æ³•.å› æ­¤è®¾ç½®å¥½äº†åˆ†æä¾èµ–ä¹‹å,
å°±å¯ä»¥è·å–ç›¸å…³çš„æ•°æ®ç»“æ„,è¿›è€Œåœ¨åç»­é˜¶æ®µè¯»å–ä½¿ç”¨:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>loopInfo <span class="token operator">==</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    loopInfo <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">getAnalysis</span><span class="token generic class-name"><span class="token operator">&lt;</span>LoopInfoWrapperPass<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLoopInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>dominatorTree <span class="token operator">==</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dominatorTree <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">getAnalysis</span><span class="token generic class-name"><span class="token operator">&lt;</span>DominatorTreeWrapperPass<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDomTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­,loopInfoå’ŒdominatorTreeéƒ½æ˜¯è¯¥Passä¸­çš„æ•°æ®æˆå‘˜.</p>
<h4 id="æ ¸å¿ƒæ•°æ®ç»“æ„">æ ¸å¿ƒæ•°æ®ç»“æ„</h4>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-const">const</span> LoopInfo <span class="token operator">*</span>loopInfo<span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> DominatorTree <span class="token operator">*</span>dominatorTree<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>unordered_set<span class="token operator">&lt;</span>Instruction<span class="token operator">*</span><span class="token operator">&gt;</span> InvariantSet<span class="token punctuation">;</span>		<span class="token comment">// æ‰€æ”¶é›†çš„å¾ªç¯ä¸å˜é‡çš„é›†åˆ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å‰ä¸¤è€…ä¹‹å‰æœ‰æ‰€ä»‹ç»,<code>InvariantSet</code>åˆ™ç”¨æ¥ä¿å­˜åœ¨è¿­ä»£æ—¶æ‰€ç¡®å®šçš„å¾ªç¯ä¸å˜é‡.ç”¨äºåœ¨åç»­è¿­ä»£ä¸­æŸ¥è¯¢å˜é‡æ˜¯å¦ä¸ºå¾ªç¯ä¸å˜é‡.</p>
<h4 id="æ ¸å¿ƒå®ç°">æ ¸å¿ƒå®ç°</h4>
<p>æ ¸å¿ƒå®ç°ä¹Ÿå°±æ˜¯è¿­ä»£ç®—æ³•æ”¶é›†ä¸å˜é‡çš„å®ç°.åœ¨<code>runOnLoop</code>ä¸­åªå¯¹åº”äº†ä¸€è¡Œ:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token function">traversalLoop</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>traversalLoop</code>çš„è¿”å›å€¼è¡¨ç¤ºçš„æ˜¯è¿™ä¸€è½®è¿­ä»£æœ‰æ²¡æœ‰å‘ç”Ÿæ”¹å˜.å…³äºrunOnLoop(ä¼˜åŒ–çš„ç²’åº¦æ˜¯ä¸€ä¸ªLoop).runOnLoopçš„å…¨éƒ¨å®ç°å¦‚ä¸‹:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-virtual">virtual</span> <span class="token keyword keyword-bool">bool</span> <span class="token function">runOnLoop</span><span class="token punctuation">(</span>Loop <span class="token operator">*</span>L<span class="token punctuation">,</span> LPPassManager <span class="token operator">&amp;</span>LPM<span class="token punctuation">)</span> <span class="token keyword keyword-override">override</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>L<span class="token operator">-&gt;</span><span class="token function">getLoopPreheader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      InvariantSet<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>loopInfo <span class="token operator">==</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          loopInfo <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">getAnalysis</span><span class="token generic class-name"><span class="token operator">&lt;</span>LoopInfoWrapperPass<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLoopInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>dominatorTree <span class="token operator">==</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          dominatorTree <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">getAnalysis</span><span class="token generic class-name"><span class="token operator">&lt;</span>DominatorTreeWrapperPass<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDomTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// é¦–å…ˆéœ€è¦ä»ä¸­æ‰¾å‡ºå¾ªç¯ä¸å˜é‡ï¼Œé€šè¿‡éå†Instructionæ¥ç¡®å®šï¼Œ æ”¶é›†åˆ°ä¸€ä¸ªlistä¸­</span>
      <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token function">traversalLoop</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">}</span>
      <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> Invariant <span class="token operator">:</span> InvariantSet<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å°†å¯¹åº”çš„æŒ‡ä»¤ç§»åŠ¨åˆ°Preheaderä¸­</span>
          <span class="token comment">// éœ€è¦åˆ¤æ–­çš„æ˜¯æ˜¯å¦æ˜¯exitçš„æ”¯é…ç»“ç‚¹</span>
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token function">checkIsExitsDom</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> Invariant<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">moveInvariant</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> Invariant<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ¥ä¸‹æ¥æ ¹æ®æ‰€æ”¶é›†çš„æŒ‡ä»¤åˆ¤æ–­æ˜¯å¦å¯ä»¥å¹¶è¿›è¡Œç§»åŠ¨</span>
      <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é¦–å…ˆéœ€è¦åˆ¤æ–­å½“å‰Loopæ˜¯å¦æœ‰Preheader,ç„¶è€Œä»€ä¹ˆæ ·çš„Loopæ˜¯æ²¡æœ‰Preheaderçš„å‘¢?LLVMä¸­æ³¨é‡Šè§£é‡Šé“:</p>
<blockquote>
<p>If there is a preheader for this loop, return it. A loop has a
preheader if there is only one edge to the header of the loop from
outside of the loop. If this is the case, the block branching to the
header of the loop is the preheader node. This method returns null if
there is no preheader for the loop.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´å¾ªç¯å¤–éƒ¨ç»“ç‚¹åˆ°è¾¾headeråªæœ‰ä¸€ä¸ªè¾¹çš„æƒ…å†µä¸‹,æ‰æ˜¯æœ‰Preheaderçš„æƒ…å†µ.</p>
<p>ä¹‹åå¯¹äºInvariantSetçš„åˆå§‹åŒ–,æˆ‘æœ€åˆä¹Ÿåœ¨çº ç»“,è¿™ä¸ªé›†åˆåº”è¯¥ä½œç”¨äºæ‰€æœ‰Loop,è¿˜æ˜¯å•ä¸ªLoopå‘¢?åœ¨è¿™é‡Œæ˜¯å¯¹å•ä¸ªLoopæœ‰æ•ˆçš„,å› æ­¤æ¯ä¸ªrunOnLoopéƒ½clear,å¦‚æœä¸clear,åé¢ä¸‹é¢ç§»åŠ¨ä»£ç ä¼šå¯¼è‡´é‡å¤ç§»åŠ¨çš„æƒ…å†µ,æˆ‘è®¤ä¸ºå°†è¯¥é›†åˆè¡¨ç¤ºä¸ºæ‰€æœ‰Loopçš„å€’ä¹Ÿè¿˜å¯ä»¥,ä¸è¿‡éœ€è¦å¢åŠ ä¸€ä¸ªmapæ¥åˆ¤æ–­è¯¥Instructionæ˜¯å¦å·²ç»ç§»åŠ¨,ä»è€Œé˜²æ­¢é‡å¤ç§»åŠ¨ä»£ç çš„æƒ…å†µ.</p>
<p>æ¥ä¸‹æ¥åˆ†æ<code>traversalLoop</code>çš„å®ç°:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-bool">bool</span> <span class="token class-name">LoopInvariantCodeMotion</span><span class="token double-colon punctuation">::</span><span class="token function">traversalLoop</span><span class="token punctuation">(</span>Loop <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// æ¯æ¬¡åªé’ˆå¯¹æŸä¸€ç‰¹å®šçš„L, å¯¹åº”äº†runOnLoopä¸­çš„L</span>
    <span class="token keyword keyword-bool">bool</span> is_changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> BB <span class="token operator">:</span> L<span class="token operator">-&gt;</span><span class="token function">getBlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>loopInfo<span class="token operator">-&gt;</span><span class="token function">getLoopFor</span><span class="token punctuation">(</span>BB<span class="token punctuation">)</span> <span class="token operator">!=</span> L<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">// æ¯æ¬¡åªé’ˆå¯¹ç‰¹å®šçš„L</span>
            <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> <span class="token operator">&amp;</span>Inst <span class="token operator">:</span> <span class="token operator">*</span>BB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInSet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Inst<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isInvariant</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Inst<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                InvariantSet<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Inst<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// åŠ å…¥åˆ°é›†åˆä¸­</span>
                is_changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> is_changed<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œéœ€è¦å¯¹æ­¤Loopä¸­çš„æ‰€æœ‰Instructionè¿›è¡Œéå†,ä¸è¿‡è¿™é‡Œçš„å…³äºBasicBlockåªèƒ½è¡¨ç¤ºæ­¤Loopå¤´å°¾ä¹‹é—´çš„æ‰€æœ‰BasicBlock,è€Œä¸ä¸€å®šå¤„äºæœ¬Loopä¹‹ä¸­(æ¯”å¦‚è¯´å¯èƒ½å¤„äºå†…éƒ¨çš„æŸä¸ªåµŒå¥—å¾ªç¯ä¹‹ä¸­),å› æ­¤å¯¹äºè¿™ç§æƒ…å†µå°±continue.å¯¹è¯¥æŒ‡ä»¤è¿›è¡Œéå†æ—¶é¦–å…ˆåˆ¤æ–­ä¹‹å‰æ˜¯å¦å·²ç»å¤„äºInstä¸­,
å¹¶ä¸”é€šè¿‡<code>isInvariant</code>æ¥åšå…·ä½“çš„åˆ¤æ–­.å¦‚æœå‘ç°æ–°çš„å¾ªç¯ä¸å˜é‡,å°±åŠ å…¥åˆ°é›†åˆ,å¹¶è®¾ç½®changed.</p>
<p>å…³äº<code>isInvariant</code>çš„å®ç°å¦‚ä¸‹:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-bool">bool</span> <span class="token class-name">LoopInvariantCodeMotion</span><span class="token double-colon punctuation">::</span><span class="token function">isInvariant</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Loop <span class="token operator">*</span>loop<span class="token punctuation">,</span> Instruction <span class="token operator">*</span><span class="token keyword keyword-const">const</span> I<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// loop ä¹Ÿæ­£æ˜¯å½“å‰æ‰€å¤„ç†çš„Iæ‰€å¤„äºloop</span>
    <span class="token keyword keyword-bool">bool</span> IsVariable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-auto">auto</span> isOutLoop
    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Instruction<span class="token operator">*</span> inst<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword keyword-bool">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> loop<span class="token operator">-&gt;</span><span class="token function">contains</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> oper_it <span class="token operator">=</span> I<span class="token operator">-&gt;</span><span class="token function">op_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> oper_it <span class="token operator">!=</span> I<span class="token operator">-&gt;</span><span class="token function">op_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>oper_it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-bool">bool</span> op_is_const<span class="token punctuation">,</span> op_is_inset<span class="token punctuation">,</span> op_notsame_loop<span class="token punctuation">;</span>
        op_is_const <span class="token operator">=</span> <span class="token generic-function"><span class="token function">isa</span><span class="token generic class-name"><span class="token operator">&lt;</span>Constant<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>oper_it<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-auto">auto</span> oper_inst <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dyn_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Instruction<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>oper_it<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>oper_inst <span class="token operator">!=</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            op_is_inset <span class="token operator">=</span> <span class="token function">isInSet</span><span class="token punctuation">(</span>oper_inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
            op_notsame_loop <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isOutLoop</span><span class="token punctuation">(</span>oper_inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            op_is_inset <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            op_notsame_loop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åˆ¤æ–­å¾ªç¯æ‰€å¤„çš„ä½ç½®ï¼Œæ˜¯å¦ä½äºå¾ªç¯å¤–éƒ¨</span>
        IsVariable <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>op_is_inset <span class="token operator">||</span> op_is_const <span class="token operator">||</span> op_notsame_loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> IsVariable <span class="token operator">&amp;&amp;</span>
    <span class="token function">isSafeToSpeculativelyExecute</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>I<span class="token operator">-&gt;</span><span class="token function">mayReadFromMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token generic-function"><span class="token function">isa</span><span class="token generic class-name"><span class="token operator">&lt;</span>LandingPadInst<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶æ ¸å¿ƒåœ¨äºå¯¹æ“ä½œæ•°çš„åˆ¤æ–­,ç»“åˆå‰é¢æ‰€æåˆ°çš„ç¬¦åˆå¾ªç¯ä¸å˜é‡çš„æ¡ä»¶ä¹Ÿå°±ä¸éš¾å®ç°è¿™ä¸€éƒ¨åˆ†çš„ä»£ç .å…¶ä¸­å¯¹äºæ˜¯å¦å¤„äºå¤–éƒ¨å¾ªç¯çš„å®ç°,é‡‡ç”¨<code>contains</code>å®Œæˆ,<strong>è¯¥æ–¹æ³•å¯ä»¥ç”¨æ¥åˆ¤æ–­æŸä¸ªInstæ˜¯å¦å¤„äºæŸä¸ªloopä¹‹ä¸­.</strong></p>
<p>æ”¶é›†å®Œè¿™ä¸€è½®çš„å¾ªç¯ä¸å˜é‡æ—¶,éœ€è¦å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥ç§»åŠ¨ä¹‹åæ‰å¯ä»¥è¿›è¡Œç§»åŠ¨.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-bool">bool</span> <span class="token class-name">LoopInvariantCodeMotion</span><span class="token double-colon punctuation">::</span><span class="token function">checkIsExitsDom</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Loop <span class="token operator">*</span>loop<span class="token punctuation">,</span> <span class="token keyword keyword-const">const</span> Instruction <span class="token operator">*</span>Inst<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// åœ¨ä¸€ä¸ªæ§åˆ¶æµå›¾ä¸­, å…¶Exit Blockå¾€å¾€æœ‰å¥½å‡ ä¸ª</span>
    SmallVector<span class="token operator">&lt;</span>BasicBlock<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span> exit_blocks<span class="token punctuation">;</span>
    loop<span class="token operator">-&gt;</span><span class="token function">getExitBlocks</span><span class="token punctuation">(</span>exit_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-auto">auto</span> exit_block <span class="token operator">:</span> exit_blocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ£€æŸ¥Instæ˜¯å¦ä¸ºè¯¥Blockçš„æ”¯é…ç»“ç‚¹</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dominatorTree<span class="token operator">-&gt;</span><span class="token function">dominates</span><span class="token punctuation">(</span>Inst<span class="token punctuation">,</span> exit_block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœä¸æ˜¯æ”¯é…ç»“ç‚¹</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-void">void</span> <span class="token class-name">LoopInvariantCodeMotion</span><span class="token double-colon punctuation">::</span><span class="token function">moveInvariant</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> Loop <span class="token operator">*</span>loop<span class="token punctuation">,</span> Instruction <span class="token operator">*</span>Inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-auto">auto</span> perheader <span class="token operator">=</span> loop<span class="token operator">-&gt;</span><span class="token function">getLoopPreheader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Inst<span class="token operator">-&gt;</span><span class="token function">moveBefore</span><span class="token punctuation">(</span>perheader<span class="token operator">-&gt;</span><span class="token function">getTerminator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡<code>getExitBlocks</code>æ–¹æ³•å¯ä»¥è¿”å›è¯¥Loopçš„æ‰€æœ‰é€€å‡ºå—,å¯¹äºInståº”è¯¥æ»¡è¶³çš„æ¡ä»¶æ˜¯:<strong>ä¸ºæ‰€æœ‰exit
blockçš„æ”¯é…ç»“ç‚¹</strong>.é€šè¿‡dominatorTreeä¸­çš„<code>dominates</code>æ–¹æ³•åˆ¤æ–­.åœ¨ç§»åŠ¨ä»£ç æ—¶,è·å–è¯¥Loopçš„Preheader,å°†è¯¥Instç§»åŠ¨åˆ°é‡Œé¢å°±å¯ä»¥.å…¶å®é¡ºåºä¸éœ€è¦è®²ç©¶,å› ä¸ºå¾ªç¯ä¸å˜é‡å¯¹åº”çš„æŒ‡ä»¤å¾€å¾€æ˜¯æ²¡æœ‰ä»€ä¹ˆä¾èµ–å…³ç³»çš„.</p>
<h3 id="å¯„å­˜å™¨åˆ†é…">2) å¯„å­˜å™¨åˆ†é…</h3>
<p>è¿™ä¸€éƒ¨åˆ†æˆ‘æ²¡å†™å‡ºæ¥,ç½‘ä¸Šæ‰¾çš„å¤§ä½¬çš„ä»£ç éƒ½æ˜¯æ—§ç‰ˆçš„,è¿™ä¸€éƒ¨åˆ†ä¹Ÿæ²¡æœ‰.ä¹‹æ‰€ä»¥å›°æ‰°æˆ‘ä¸€æ–¹é¢æ˜¯å› ä¸ºç†è§£å¯„å­˜å™¨åˆ†é…çš„ç®—æ³•æœ‰ç‚¹éš¾,å¦ä¸€æ–¹é¢æ˜¯å› ä¸ºè¿™å…¶ä¸­æ¶‰åŠåˆ°å¾ˆå¤šLLVMçš„æ•°æ®ç»“æ„æˆ‘æ²¡æœ‰æ•´æ˜ç™½,è€Œä¸”æ¥ä¸‹æ¥çš„å­¦ä¹ ä»»åŠ¡æœ‰äº›ç´§å¼ ,æ‰€ä»¥å°è¯•å†™äº†å†™ä¹‹åå°±å…ˆææµ…äº†,<strong>æˆ‘æ˜¯çœŸçš„åºŸç‰©</strong>.</p>
<p>ä¹‹å‰çš„Passéƒ½æ˜¯åŸºäºIRå¤„ç†,è€Œå¯„å­˜å™¨åˆ†é…çš„Passå¤„äºä¸€ä¸ªä¸åŒçš„é˜¶æ®µ,è¿™ä¸€éƒ¨åˆ†ä½äºæŒ‡ä»¤é€‰æ‹©ä¸æŒ‡ä»¤è°ƒåº¦ä¹‹å,æ­¤æ—¶è¯¥Passæ‰€æ¥å—çš„å½¢å¼ä¸å†æ˜¯IR,è€Œæ˜¯MachineFunction,å¯ä»¥è¯´å·²ç»æ¥è¿‘ç›®æ ‡æ±‡ç¼–è¯­è¨€,ä½†åªæ˜¯æ²¡æœ‰å°†å…¶ä¸­çš„è™šæ‹Ÿå¯„å­˜å™¨è½¬åŒ–ä¸ºç‰©ç†å¯„å­˜å™¨.å› æ­¤è¿™é‡Œæ‰€éœ€è¦ä½¿ç”¨çš„LLVMä¸­çš„APIå’Œæ•°æ®ç»“æ„å’Œå‰é¢çš„Passéƒ½ä¸å¤ªä¸€æ ·.</p>
<p>ä¸è¿‡LLVMä¸­æœ‰æä¾›çš„å‡ ç§å¯„å­˜å™¨åˆ†é…çš„å®ç°,æˆ‘æƒ³ä»¥åæœ‰æ—¶é—´å†å­¦ä¸€å­¦å§.</p>
<h4 id="exampleä¸­çš„ç®€å•å®ç°">exampleä¸­çš„ç®€å•å®ç°</h4>
<p>CSCD70çš„exampleä¸­ç»™å‡ºäº†ä¸€ä¸ªç®€å•çš„å¯„å­˜å™¨å®ç°.åƒä¹‹å‰çš„Passä¸€æ ·,è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªclass,ç»§æ‰¿äº†<code>MachineFunctionPasså’ŒLiveRangeEdit::Delegate</code>.æ­£å¦‚ä¹‹å‰æ‰€å†™çš„Passä¸€æ ·,é¦–å…ˆéœ€è¦è¯´æ˜çš„æ˜¯è¯¥Passæ‰€éœ€è¦çš„ä¾èµ–,å…¶ä¸­æ¶‰åŠçš„ä»£ç å¦‚ä¸‹:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>SlotIndexes<span class="token punctuation">)</span>
<span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>VirtRegMap<span class="token punctuation">)</span>
<span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>LiveIntervals<span class="token punctuation">)</span>
<span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>LiveRegMatrix<span class="token punctuation">)</span>
<span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>LiveStacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>AAResultsWrapperPass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>MachineDominatorTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>MachineLoopInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">INITIALIZE_PASS_DEPENDENCY</span><span class="token punctuation">(</span>MachineBlockFrequencyInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">INITIALIZE_PASS_END</span><span class="token punctuation">(</span>RAMinimal<span class="token punctuation">,</span> <span class="token string">"regallominimal"</span><span class="token punctuation">,</span> <span class="token string">"Minimal Register Allocator"</span><span class="token punctuation">,</span>
                    <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œçš„<code>INITIALIZE_PASS_DEPENDENCY</code>å£°æ˜çš„ä½œç”¨å’Œ<code>getAnalysisUsage</code>ä¸­è®¾ç½®ä¾èµ–ç±»ä¼¼,å…¶ä¸­é€ä¸ªç®€è¦è¯´æ˜å…¶ä¸­çš„æ„ä¹‰:</p>
<ul>
<li>SlotIndexes.ç”¨äºç»™æŒ‡ä»¤ç¼–æ’åºå·,
ç¼–æ’åºå·çš„é‡è¦ä½œç”¨ä¹‹ä¸€åœ¨äºä¸ºå˜é‡çš„LiveIntervalç¡®å®šåŒºé—´.æ¯”å¦‚è¯´æŒ‡ä»¤Aåºå·ä¸º01BæŒ‡ä»¤Bçš„åºå·ä¸º09B,å› æ­¤æ´»è·ƒåœ¨è¿™ä¸¤ä¸ªæŒ‡ä»¤ä¹‹é—´çš„å˜é‡çš„LiveIntervalå°±å¯¹åº”äº†[01B,
09B),ä¸è¿‡è¿™åªæ˜¯å…¶ä¸­ä¸€æ®µ.</li>
<li>VirtRegMap.ç»´æŠ¤äº†ä¸€äº›è™šæ‹Ÿå¯„å­˜å™¨æœ‰å…³çš„Map,æ¯”å¦‚è¯´åˆ°ç‰©ç†å¯„å­˜å™¨çš„Map(ä¹Ÿæ­£æ˜¯å¯„å­˜å™¨åˆ†é…æ—¶éœ€è¦è®¾ç½®çš„).</li>
<li>LiveIntervals.ç»´æŠ¤äº†å˜é‡çš„LiveIntervalçš„é›†åˆ,å…³äºLiveIntervalå…¶ä¸­ä¸»è¦çš„æ•°æ®ç»“æ„æœ‰ä¸€ä¸ªVNInfo,ä»£è¡¨äº†ä¸€ä¸ªdefç‚¹(é€šè¿‡SlotIndexè¡¨ç¤º),è¿˜æœ‰ä¸€ä¸ªSegment,è¡¨ç¤ºä¸€ä¸ªå·¦å¿…å³å¼€åŒºé—´(startã€end,è¿˜æœ‰ä¸€ä¸ªæŒ‡å‘VNInfoçš„æŒ‡é’ˆ),è¡¨ç¤ºä¸€æ®µæ´»è·ƒæœŸ,LiveRangeè¡¨ç¤ºä¸€ä¸ªè™šæ‹Ÿå¯„å­˜å™¨çš„å®Œæ•´å‘¨æœŸ,æ˜¯Segmentçš„é›†åˆ.è€ŒLiveIntervalç»§æ‰¿è‡ªLiveRange,ä¸»è¦æ˜¯å¤šäº†Regå¯„å­˜å™¨å’ŒWeightæƒé‡.</li>
<li>LiveRegMatrix.é€šè¿‡ä¸¤ä¸ªç»´åº¦åˆ¤æ–­è™šæ‹Ÿå¯„å­˜å™¨ä¹‹é—´æœ‰æ— interference.åˆ†åˆ«æ˜¯Slot
indexeså’Œregister
unit.æ•°æ®æˆå‘˜ä¸»è¦æ˜¯ä¸€ä¸ªVirRegMapå’ŒLiveIntervalsçš„æŒ‡é’ˆ.æœ‰checkInterference,assignç­‰æ–¹æ³•.</li>
<li>LiveStacks.ç±»ä¼¼äºæ´»è·ƒåˆ†æ,ä½†æ˜¯åˆ†æçš„ä¸æ˜¯å¯„å­˜å™¨,è€Œæ˜¯Slot.(è¯´å®è¯ä¸æ˜¯å¤ªæ‡‚è¿™ä¸ªä¸œè¥¿).</li>
</ul>
<p>å› æ­¤è¿™äº›åˆ†æç»“æœä¹Ÿéƒ½æœ‰ç›¸åº”çš„æ•°æ®æˆå‘˜,åœ¨runOnLoopå‡½æ•°ä¸­,ä¸€å¼€å§‹å°±æ˜¯åˆå§‹åŒ–ä¸è¿™äº›ä»¥æ¥ç›¸å…³çš„æ•°æ®ç»“æ„:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-const">const</span> SlotIndexes <span class="token operator">*</span>SI<span class="token punctuation">;</span>        <span class="token comment">// ç”¨äºç»™æ¯ä¸ªæŒ‡ä»¤ç¼–æˆåºå·</span>
 <span class="token comment">// Virtual Register Mapping</span>
 VirtRegMap <span class="token operator">*</span>VRM<span class="token punctuation">;</span>      <span class="token comment">// æ˜¯ä¸€ä¸ªä»è™šæ‹Ÿå¯„å­˜å™¨åˆ°ç‰©ç†å¯„å­˜å™¨çš„Map, ä¹Ÿæ˜¯æˆ‘ä»¬å®ç°å¯„å­˜å™¨åˆ†é…æ‰€éœ€è¦å¡«å……çš„å†…å®¹</span>
 <span class="token keyword keyword-const">const</span> TargetRegisterInfo <span class="token operator">*</span>TRI<span class="token punctuation">;</span>        <span class="token comment">// ç›®æ ‡å¯„å­˜å™¨Info</span>
 MachineRegisterInfo <span class="token operator">*</span>MRI<span class="token punctuation">;</span>
 <span class="token comment">// Live Intervals</span>
 LiveIntervals <span class="token operator">*</span>LIS<span class="token punctuation">;</span>       <span class="token comment">// å¯„å­˜å™¨çš„æ´»è·ƒé—´éš”</span>
 std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>LiveInterval <span class="token operator">*</span><span class="token operator">&gt;</span> LIQ<span class="token punctuation">;</span> <span class="token comment">// FIFO Queue</span>
LiveRegMatrix <span class="token operator">*</span>LRM<span class="token punctuation">;</span><span class="token comment">// Register Class Information</span>
 RegisterClassInfo RCI<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Spiller<span class="token operator">&gt;</span> SpillerInst<span class="token punctuation">;</span>			<span class="token comment">// æä¾›äº†spillæ–¹æ³•</span>
 SmallPtrSet<span class="token operator">&lt;</span>MachineInstr <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">&gt;</span> DeadRemats<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨runOnMachineFunctionä¸­,åšå®Œä¸€äº›åˆå§‹åŒ–ä¹‹å,å°†LiveIntervalç»“ç‚¹ä¸€ä¸ªä¸ªåœ°åŠ å…¥LIQ,ä¹‹åä»LIQä¸­å°†ç»“ç‚¹é€ä¸ªå¼¹å‡º,å¹¶å¯¹å…¶è°ƒç”¨selectOrSplit.å…¶ä¸­å¼¹å‡ºé˜Ÿåˆ—ä¸­çš„å¤„ç†è¿‡ç¨‹åŸºæœ¬å¦‚ä¸‹:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>LiveInterval <span class="token operator">*</span><span class="token keyword keyword-const">const</span> LI <span class="token operator">=</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// å°†FIFOé€ä¸ªå¼¹å‡ºå¹¶è¿›è¡ŒæŸ“è‰²</span>
   <span class="token comment">// again, skip all unused registers</span>
   <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>MRI<span class="token operator">-&gt;</span><span class="token function">reg_nodbg_empty</span><span class="token punctuation">(</span>LI<span class="token operator">-&gt;</span><span class="token function">reg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     LIS<span class="token operator">-&gt;</span><span class="token function">removeInterval</span><span class="token punctuation">(</span>LI<span class="token operator">-&gt;</span><span class="token function">reg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>     <span class="token comment">// å¦‚æœå‡ºç°äº†nodbg_emptyå°±éœ€è¦ç§»é™¤</span>
   LRM<span class="token operator">-&gt;</span><span class="token function">invalidateVirtRegs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 2. Allocate to a physical register (if available) or split to a list of</span>
   <span class="token comment">//    virtual registers.</span>
   SmallVector<span class="token operator">&lt;</span>Register<span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">&gt;</span> SplitVirtRegs<span class="token punctuation">;</span>
   MCRegister PhysReg <span class="token operator">=</span> <span class="token function">selectOrSplit</span><span class="token punctuation">(</span>LI<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SplitVirtRegs<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// Splitä¹Ÿå°±æ˜¯éœ€è¦æº¢å‡ºçš„,è¿™ç§æƒ…å†µä¸‹,éœ€è¦å°†å…¶è¿›è¡Œsplit</span>
   <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>PhysReg<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// å¦‚æœæ˜¯å¯ä»¥åˆ†é…çš„å¯„å­˜å™¨,å°±å¯ä»¥è¿›è¡Œèµ‹å€¼äº†,å¯„å­˜å™¨åˆ†é…çš„ç›®æ ‡å°±åœ¨äºè®¾ç½®ä¸€ä¸ªMap</span>
     LRM<span class="token operator">-&gt;</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token operator">*</span>LI<span class="token punctuation">,</span> PhysReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// enqueue the splitted live ranges</span>
   <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>Register Reg <span class="token operator">:</span> SplitVirtRegs<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// æ‰€è¿”å›çš„</span>
     LiveInterval <span class="token operator">*</span>LI <span class="token operator">=</span> <span class="token operator">&amp;</span>LIS<span class="token operator">-&gt;</span><span class="token function">getInterval</span><span class="token punctuation">(</span>Reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>MRI<span class="token operator">-&gt;</span><span class="token function">reg_nodbg_empty</span><span class="token punctuation">(</span>LI<span class="token operator">-&gt;</span><span class="token function">reg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       LIS<span class="token operator">-&gt;</span><span class="token function">removeInterval</span><span class="token punctuation">(</span>LI<span class="token operator">-&gt;</span><span class="token function">reg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// å¯¹äºåˆ†è£‚çš„å¦‚ä½•è¿›è¡Œå¤„ç†??ä¸ºä»€ä¹ˆéœ€è¦è¿›è¡Œåˆ†è£‚å‘¢?</span>
       <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token function">enqueue</span><span class="token punctuation">(</span>LI<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token comment">// å¯¹äºSplitçš„åº”è¯¥è¿›è¡Œæ€æ ·çš„å¤„ç†å‘¢?</span>
 <span class="token punctuation">}</span> <span class="token comment">// while (dequeue())</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…¶ä¸­æœ€é‡è¦çš„å‡½æ•°æ˜¯<code>selectOrSplit</code>.è¯¥å‡½æ•°æ¶‰åŠçš„æ“ä½œå¦‚ä¸‹:</p>
<ul>
<li>é¦–å…ˆè·å–ä¸€ä¸ªå¯ä¾›åˆ†é…çš„ç‰©ç†å¯„å­˜å™¨çš„åºåˆ—.</li>
<li>ä¹‹åå¯¹äºè¯¥æŒ‡ä»¤,éå†å¯ç”¨ç‰©ç†å¯„å­˜å™¨åºåˆ—,é€šè¿‡LiveRegMatrixä¸­çš„checkInterferenceåˆ¤æ–­æ˜¯å¦å†²çª,<strong>å¦‚æœä¸å†²çªå°±ç›´æ¥è¿”å›å°±å¥½äº†</strong>;å¦‚æœå†²çªå°±åŠ å…¥ä¸€ä¸ªæº¢å‡ºå€™é€‰å¯„å­˜å™¨åºåˆ—(å› ä¸ºæº¢å‡ºçš„å˜é‡è™½ç„¶ä¼šæº¢å‡ºåˆ°å†…å­˜ä¸­,ä½†æ˜¯ä»å†…å­˜ä¸­å–å‡ºæ­¤å˜é‡æ—¶ä»ç„¶éœ€è¦å¯„å­˜å™¨).</li>
<li>éå†æº¢å‡ºå€™é€‰å¯„å­˜å™¨åºåˆ—,ä»ä¸­è°ƒç”¨spillInterferences(å¯ä»¥å°è¯•ä»å€™é€‰å¯„å­˜å™¨ä¸­æ‰¾å‡ºæ¥ä¸€ä¸ªå¯ä»¥åˆ†é…ç»™å½“å‰æŒ‡ä»¤çš„,å› æ­¤ä¹Ÿå°±å…å»äº†å¯¹å½“å‰æŒ‡ä»¤çš„spill),å¦‚æœæº¢å‡ºå¯„å­˜å™¨åºåˆ—ä¸­æœ‰å¯ä»¥spill(å…¶å®spillçš„æ˜¯å…¶å¯¹åº”çš„å˜é‡)çš„,<strong>å°±è¿”å›è¯¥å¯„å­˜å™¨</strong>.ç›¸å…³çš„æºä»£ç å¦‚ä¸‹:</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>MCRegister PhysReg <span class="token operator">:</span> PhysRegSpillCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token comment">// è¿™ä¸€éƒ¨åˆ†è€ƒè™‘è¿›è¡Œsplitçš„æ“ä½œ</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">spillInterferences</span><span class="token punctuation">(</span>LI<span class="token punctuation">,</span> PhysReg<span class="token punctuation">,</span> SplitVirtRegs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// ä¼šè®²splitçš„ç»“æœè¿”å›åˆ°SplitVirtualä¸­</span>
    <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> PhysReg<span class="token punctuation">;</span>			<span class="token comment">// è¿™ç§æƒ…å†µ,å°±æ˜¯è¯¥PhysRegå¯ä»¥è…¾å‡ºæ¥åˆ†é…ç»™å½“å‰æŒ‡ä»¤çš„æƒ…å†µ</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æœ€ç»ˆå°†å½“å‰æŒ‡ä»¤spill,ä¹Ÿå°±æ˜¯å‰é¢éƒ½æ²¡æœ‰å‡ºç°è¿”å›çš„æƒ…å†µ,ç›¸å…³å®ç°å¦‚ä¸‹:</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">LiveRangeEdit <span class="token function">LRE</span><span class="token punctuation">(</span>LI<span class="token punctuation">,</span> <span class="token operator">*</span>SplitVirtRegs<span class="token punctuation">,</span> <span class="token operator">*</span>MF<span class="token punctuation">,</span> <span class="token operator">*</span>LIS<span class="token punctuation">,</span> VRM<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>DeadRemats<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// ç”¨äºä¿®æ”¹LivenessèŒƒå›´çš„</span>
SpillerInst<span class="token operator">-&gt;</span><span class="token function">spill</span><span class="token punctuation">(</span>LRE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æ¥ä¸‹æ¥ç»†è¯´<code>spillInterferences</code>.</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword keyword-bool">bool</span> <span class="token function">spillInterferences</span><span class="token punctuation">(</span>LiveInterval <span class="token operator">*</span><span class="token keyword keyword-const">const</span> LI<span class="token punctuation">,</span> MCRegister PhysReg<span class="token punctuation">,</span>
                        SmallVectorImpl<span class="token operator">&lt;</span>Register<span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token keyword keyword-const">const</span> SplitVirtRegs<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
  SmallVector<span class="token operator">&lt;</span>LiveInterval <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">&gt;</span> IntfLIs<span class="token punctuation">;</span>
  <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>MCRegUnitIterator <span class="token function">Units</span><span class="token punctuation">(</span>PhysReg<span class="token punctuation">,</span> TRI<span class="token punctuation">)</span><span class="token punctuation">;</span> Units<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>Units<span class="token punctuation">)</span> <span class="token punctuation">{</span>		<span class="token comment">// ç‰©ç†å¯„å­˜å™¨å¯èƒ½æ˜¯æœ‰åˆ«åçš„,æ‰€ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼éå†</span>
    LiveIntervalUnion<span class="token double-colon punctuation">::</span>Query <span class="token operator">&amp;</span>Q <span class="token operator">=</span> LRM<span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token operator">*</span>LI<span class="token punctuation">,</span> <span class="token operator">*</span>Units<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Q<span class="token punctuation">.</span><span class="token function">collectInterferingVRegs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>LiveInterval <span class="token operator">*</span><span class="token keyword keyword-const">const</span> IntfLI <span class="token operator">:</span> Q<span class="token punctuation">.</span><span class="token function">interferingVRegs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>			<span class="token comment">// éå†å…¶ä¸­å†²çªçš„è™šæ‹Ÿå¯„å­˜å™¨</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>IntfLI<span class="token operator">-&gt;</span><span class="token function">isSpillable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> IntfLI<span class="token operator">-&gt;</span><span class="token function">weight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> LI<span class="token operator">-&gt;</span><span class="token function">weight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      IntfLIs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>IntfLI<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Spill each interfering vreg allocated to PhysRegs.</span>
  <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> IntfIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> IntfIdx <span class="token operator">&lt;</span> IntfLIs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>IntfIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    LiveInterval <span class="token operator">*</span><span class="token keyword keyword-const">const</span> LIToSpill <span class="token operator">=</span> IntfLIs<span class="token punctuation">[</span>IntfIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// avoid duplicates</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>VRM<span class="token operator">-&gt;</span><span class="token function">hasPhys</span><span class="token punctuation">(</span>LIToSpill<span class="token operator">-&gt;</span><span class="token function">reg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Deallocate the interfering virtual registers.</span>
    LRM<span class="token operator">-&gt;</span><span class="token function">unassign</span><span class="token punctuation">(</span><span class="token operator">*</span>LIToSpill<span class="token punctuation">)</span><span class="token punctuation">;</span>
    LiveRangeEdit <span class="token function">LRE</span><span class="token punctuation">(</span>LIToSpill<span class="token punctuation">,</span> <span class="token operator">*</span>SplitVirtRegs<span class="token punctuation">,</span> <span class="token operator">*</span>MF<span class="token punctuation">,</span> <span class="token operator">*</span>LIS<span class="token punctuation">,</span> VRM<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span>
                      <span class="token operator">&amp;</span>DeadRemats<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SpillerInst<span class="token operator">-&gt;</span><span class="token function">spill</span><span class="token punctuation">(</span>LRE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç®€è€Œè¨€ä¹‹,è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥éª¤:</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µ,æ”¶é›†è¯¥ç‰©ç†å¯„å­˜å™¨æ‰€æ¶‰åŠçš„è™šæ‹Ÿå¯„å­˜å™¨,ç”±äºç‰©ç†å¯„å­˜å™¨ä¹Ÿè®¸æœ‰åˆ«å,æ‰€ä»¥åœ¨é€šè¿‡<code>MCRegUnitIterator</code>éå†,ä¹‹åé€šè¿‡LRMä¸­çš„queryè¿”å›<code>LiveIntervalUnion::Query</code>,ä¹‹åå¯ä»¥è·å–è¯¥Unitæ‰€å¯¹åº”çš„ä¸LIå†²çªçš„è™šæ‹Ÿå¯„å­˜å™¨çš„é›†åˆ,ç„¶åå†å¯¹æ­¤éå†,åªè¦å‡ºç°äº†ä¸å¯spillæˆ–è€…spill
weightå¤§äºLIçš„,å°±è¿”å›false.å› æ­¤å¯ä»¥è¯´<strong>åªæœ‰å½“ä¸€ä¸ªå€™é€‰ç‰©ç†å¯„å­˜å™¨ä¸­ä¸LIå†²çªçš„æ‰€æœ‰è™šæ‹Ÿå¯„å­˜å™¨éƒ½æ¯”LIçš„spill
weightå°,æ‰å¯ä»¥å°†è¯¥å€™é€‰ç‰©ç†å¯„å­˜å™¨spill</strong>.</li>
<li>ç¬¬äºŒé˜¶æ®µ,å°†è¯¥ç‰©ç†å¯„å­˜å™¨æ‰€æ¶‰åŠçš„è™šæ‹Ÿå¯„å­˜å™¨æº¢å‡º.</li>
</ul>
<blockquote>
<p><strong>ä½¿ç”¨åŸºäºspill costçš„ä¼˜å…ˆçº§é˜Ÿåˆ—</strong></p>
<p>åœ¨exampleä¸­åªæ˜¯ä½¿ç”¨äº†æ™®é€šé˜Ÿåˆ—, åœ¨LLVM basic register
allocatorä¸­,ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—,å¹¶ä¸”æ ¹æ®è®¡ç®—çš„LiveIntervalçš„æƒé‡æ¥æ’åº,è¯¥æƒé‡ç”¨äºè¡¡é‡spillçš„ä»£ä»·,å…¶ä¸­æœ€å¸¸ç”¨çš„è®¡ç®—æ–¹å¼å¦‚ä¸‹:</p>
<p>Cost = [(is_defs + is_use)*10^loop-nest-depth]/degree</p>
<p>å› æ­¤åœ¨å°†ç»“ç‚¹åŠ å…¥åˆ°é˜Ÿåˆ—æ—¶,å¯¼è‡´ä»£ä»·ä½åœ¨é˜Ÿåˆ—åº•éƒ¨,ä»£ä»·é«˜çš„åœ¨ä¸Šéƒ¨,è¿™ä½¿å¾—åœ¨åæ¥popé˜Ÿåˆ—æ—¶,ä»£ä»·é«˜çš„ä¼˜å…ˆå…·æœ‰è¢«åˆ†é…çš„æœºä¼š,å› æ­¤å®é™…è¢«spillçš„å¾€å¾€éƒ½æ˜¯ä»£ä»·æ¯”è¾ƒä½çš„å˜é‡,æ˜¾ç„¶ç›¸æ¯”ä½¿ç”¨æ™®é€šçš„é˜Ÿåˆ—æ˜¯ä¸€ç§ä¼˜åŒ–.</p>
</blockquote>
<p>æ­¤å¤–,åœ¨exampleä¸­,æ²¡æœ‰å®ç°split,splitæ˜¯ä¸€ç§é€šè¿‡å°†ä¸€ä¸ªå¤§çš„æ´»è·ƒåŒºé—´åˆ†å‰²æˆä¸€ä¸ªä¸ªå°æ´»è·ƒåŒºé—´çš„æ–¹æ³•,ç”¨äºé™ä½spillçš„ä»£ä»·,åœ¨exampleä¸­,<code>SplitVirtRegs</code>é›†åˆå…¨ç¨‹éƒ½æ˜¯ç©ºçš„.</p>
<h2 id="ç›¸å…³å‚è€ƒ">ç›¸å…³å‚è€ƒ</h2>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/290946850#:~:text=CallGrap,Pass.h%E4%B8%AD%EF%BC%9A">LLVMä¸­çš„passåŠå…¶ç®¡ç†æœºåˆ¶</a></p>
<p><a target="_blank" rel="noopener" href="https://www.llvm.org/docs/ProgrammersManual.html#iterating-over-the-instruction-in-a-basicblock">LLVM
Programmerâ€™s Manual</a></p>
<p><a target="_blank" rel="noopener" href="https://kiprey.github.io/2020/06/LLVM-IR-pass/">ä»£ç ä¼˜åŒ–ä¸LLVM IR
pass</a></p>
<p><a target="_blank" rel="noopener" href="https://yogdzewa.github.io/2022-03/Now-CSCD70/">CSCD70
&amp;&amp; LLVM</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Evian-Zhang/llvm-ir-tutorial">Evian-Zhang/llvm-ir-tutorial</a></p>
<p><a href="https://link.zhihu.com/?target=http%3A//llvm.org/devmtg/2019-04/slides/Tutorial-Bridgers-LLVM_IR_tutorial.pdf">Tutorial-Bridgers-LLVM_IR_tutorial</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28182330">How To Write An LLVM
Register Allocator</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/178228779">ç¼–è¯‘å™¨ç®—æ³•ä¹‹å¯„å­˜å™¨åˆ†é…</a></p>
<p><a target="_blank" rel="noopener" href="https://www.daimajiaoliu.com/series/llvm/485c0ce27900405">LLVMé‡Œçš„å¯„å­˜å™¨åˆ†é…
- basicåˆ†é…å™¨(ä¸‰)</a></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>åŠ è½½è¯„è®ºéœ€è¦åœ¨æµè§ˆå™¨å¯ç”¨ JavaScript è„šæœ¬æ”¯æŒã€‚</noscript>
        </div>
    </div>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>åŠ è½½è¯„è®ºéœ€è¦åœ¨æµè§ˆå™¨å¯ç”¨ JavaScript è„šæœ¬æ”¯æŒã€‚</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">é¦–é¡µ</a></li>
         
          <li><a href="/about/">å…³äº</a></li>
         
          <li><a href="/archives/">å½’æ¡£</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.</span> <span class="toc-text">0 .ç¯å¢ƒå‡†å¤‡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#introduction-to-llvm"><span class="toc-number"></span> <span class="toc-text">1. Introduction to LLVM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%87%BD%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">1) è¾“å‡ºå‡½æ•°ä¿¡æ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E4%BC%98%E5%8C%96%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">2) å±€éƒ¨ä¼˜åŒ–å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dataflow-analysis"><span class="toc-number"></span> <span class="toc-text">2. Dataflow Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#framework%E7%9A%84%E5%8F%AF%E5%8F%98%E5%9B%A0%E7%B4%A0%E4%B8%8E%E6%A8%A1%E7%89%88%E5%8F%82%E6%95%B0"><span class="toc-number">1.</span> <span class="toc-text">1)
Frameworkçš„å¯å˜å› ç´ ä¸æ¨¡ç‰ˆå‚æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#framework%E4%B8%AD%E7%9A%84%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">2) Frameworkä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">3) è¿­ä»£ç®—æ³•å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#loop-invariant-code-motion"><span class="toc-number"></span> <span class="toc-text">3. Loop Invariant Code Motion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E4%B8%8D%E5%8F%98%E9%87%8F%E8%AE%A1%E7%AE%97"><span class="toc-number">1.</span> <span class="toc-text">1) å¾ªç¯ä¸å˜é‡è®¡ç®—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">ä¾èµ–è®¾ç½®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">æ ¸å¿ƒæ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">æ ¸å¿ƒå®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E5%88%86%E9%85%8D"><span class="toc-number">2.</span> <span class="toc-text">2) å¯„å­˜å™¨åˆ†é…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example%E4%B8%AD%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.1.</span> <span class="toc-text">exampleä¸­çš„ç®€å•å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%8F%82%E8%80%83"><span class="toc-number"></span> <span class="toc-text">ç›¸å…³å‚è€ƒ</span></a>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/12294483.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/12294483.html&text=LLVM IR Pass Labs"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/12294483.html&is_video=false&description=LLVM IR Pass Labs"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=LLVM IR Pass Labs&body=Check out this article: http://example.com/2022/12294483.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/12294483.html&title=LLVM IR Pass Labs"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/12294483.html&name=LLVM IR Pass Labs&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/12294483.html&t=LLVM IR Pass Labs"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> èœå•</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> ç›®å½•</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> åˆ†äº«</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> è¿”å›é¡¶éƒ¨</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    yfs
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">é¦–é¡µ</a></li><!--
    --><!--
      --><li><a href="/about/">å…³äº</a></li><!--
    --><!--
      --><li><a href="/archives/">å½’æ¡£</a></li><!--
    -->
      </ul>
      <ul>
        
          <!-- ä¸è’œå­ç»Ÿè®¡ -->
          <span id="busuanzi_container_site_pv">
              æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äºº
          </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  
</footer>

<script src="/js/prism/prism.js" async></script>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"å¤åˆ¶åˆ°ç²˜è´´æ¿ï¼\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "å¤åˆ¶æˆåŠŸï¼");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
