<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="linux 0.11源码分析:boot与系统调用, Yfs&#39;s Box">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>linux 0.11源码分析:boot与系统调用 | Yfs&#39;s Box</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <link rel="stylesheet" href="/js/prism/prism.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Yfs&#39;s Box</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Yfs&#39;s Box</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/banner/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">linux 0.11源码分析:boot与系统调用</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/linux/">
                                <span class="chip bg-color">linux</span>
                            </a>
                        
                            <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                                <span class="chip bg-color">操作系统</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-category">
                                源码分析
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-06-17
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    7.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    30 Min
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="boot">1.boot</h2>
<h3 id="总体概述">1) 总体概述</h3>
<p>当机器加电之后,开始运行BIOS,自动处于0xffff0执行代码,之后的主要行为如下:</p>
<ul>
<li>做一些和系统相关的检测.</li>
<li>在0x0处初始化中断向量表.</li>
<li>将引导扇区读入到0x7c00,并跳转到此.</li>
</ul>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2017%2023%2014%2043%201655478883%201655478883928%20Rna36F%20image-20220617231443741%20.png" alt="image-20220617231443741">
<figcaption aria-hidden="true">image-20220617231443741</figcaption>
</figure>
<p>之后其指令执行过程和代码移动过程如下:</p>
<ul>
<li>bootsect.s:
<ul>
<li>bootsect.s的代码被BIOS读入到0x7c00后,移动内存并跳转到0x9000.</li>
<li>读入system模块和setup.s模块.</li>
</ul></li>
<li>setup:
<ul>
<li>识别主机的一些特性以及VGA卡类型.</li>
<li>移动system到内存0x0000处.</li>
<li>进入保护模式并且跳转到0x0000处.</li>
</ul></li>
<li>head.s
<ul>
<li>..</li>
</ul></li>
</ul>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2017%2023%2016%2024%201655478984%201655478984895%20YZuC3A%20image-20220617231624729%20.png" alt="image-20220617231624729">
<figcaption aria-hidden="true">image-20220617231624729</figcaption>
</figure>
<h3 id="bootsect.s源码分析">2) bootsect.s源码分析</h3>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">! 定义了4个基本的端地址,分别对应bootseg代码的初始和移动后地址,setup代码地址,系统内核地址,系统内核末尾地址
SETUPLEN = 4		
BOOTSEG  = 0x07c0	
INITSEG  = 0x9000
SETUPSEG = 0x9020	
SYSSEG   = 0x1000	
ENDSEG   = SYSSEG + SYSSIZE
! 设备号
ROOT_DEV = 0x306
! 设置好基本的段寄存器信息,并且将boot的代码移动到0x9000.
entry _start
_start:
	mov	ax,#BOOTSEG
	mov	ds,ax
	mov	ax,#INITSEG
	mov	es,ax
	mov	cx,#256
	sub	si,si
	sub	di,di
	rep
	movw
	jmpi	go,INITSEG
! 此时已经处于0x9000地址之后,也就是移动后的boot所处于的代码
go:	mov	ax,cs
	mov	ds,ax
	mov	es,ax
! 设置栈地址:(0x9000|0xff00)
	mov	ss,ax
	mov	sp,#0xFF00		! arbitrary value &gt;&gt;512<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先这一段代码除了段寄存器设置,最重要的在于完成了代码的拷贝内存的移动,还有执行的跳转.跳转之后,对有关的段寄存器进行操作,还有对于栈的设置(后面会有关于栈的操作).</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">load_setup:
	mov	dx,#0x0000		! drive 0, head 0
	mov	cx,#0x0002		! sector 2, track 0
	mov	bx,#0x0200		! address = 512, in INITSEG
	mov	ax,#0x0200+SETUPLEN	! service 2, nr of sectors
	int	0x13			! read it
	jnc	ok_load_setup		! ok - continue
	mov	dx,#0x0000
	mov	ax,#0x0000		! reset the diskette
	int	0x13
	j	load_setup
ok_load_setup:
	mov	dl,#0x00
	mov	ax,#0x0800		! AH=8 is get drive parameters
	int	0x13
	mov	ch,#0x00
	seg cs
	mov	sectors,cx
	mov	ax,#INITSEG
	mov	es,ax<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一部分主要与读取磁盘扇区有关,用于将setup程序读到内存中0x9200的位置.这里主要借助了0x13来对磁盘进行读取并加载到指定的内存中,这个时候我们就可以理解,为什么要在BIOS初始化一个中断向量表了.</p>
<p><strong>int
0x13有关于参数的配置,是通过几个通用寄存器来完成的.</strong>更具体来说是这样的:</p>
<ul>
<li>ah=0x02,表示磁盘扇区到内存;al=需要读的扇区数量.</li>
<li>ch=磁道号的低8位;cl=开始扇区和磁道号.</li>
<li>dh=磁头号;dl=驱动器号.</li>
<li>es:b-&gt;要移动到的缓冲区.</li>
</ul>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">
! 输出一些字符串
	mov	ah,#0x03		! read cursor pos
	xor	bh,bh
	int	0x10

	mov	cx,#24
	mov	bx,#0x0007		! page 0, attribute 7 (normal)
	mov	bp,#msg1
	mov	ax,#0x1301		! write string, move cursor
	int	0x10

	msg1:
        .byte 13,10            ! 换行+回车
        .ascii "Loading system ..."
        .byte 13,10,13,10            ! 两对换行+回车
      !其中ascii占了18个字符,byte等换行回车占6个,总共24个<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先这个过程主要借助中断0x10来实现:</p>
<ul>
<li>第一个int
0x10.参数配置为:ah=0x03,表示的是读取光标号,也就是功能号.然后将bh设置为0,调用int
0x10返回的结果为主要在cx和dx(dh行号0x00,dl列号0x00)中.</li>
<li>第二个功能号是0x13(ah),代表的是输出字符串功能.al代表的是光标的放置方式.bp指向是所要输出的字符串的地址.cx代表输出的字符个数.</li>
</ul>
<p>我们再次可以发现,对于一些中断来说,通用寄存器可以作为其参数配置和返回结果.</p>
<p>我们可以根据这种技巧,来对boot输出的字符串进行一定的控制.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">!将ascii进行修改,此时cx应该改为25,此时25个字符.
msg1:
	.byte 13,10
	.ascii "Yfsos is booting..."
	.byte 13,10,13,10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果如下:</p>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2018%2001%2013%2056%201655486036%201655486036048%20ibkpYN%20image-20220618011355835%20.png" alt="image-20220618011355835">
<figcaption aria-hidden="true">image-20220618011355835</figcaption>
</figure>
<p>接下来要做的就是将system部分,加载到内存中.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">! ok, we've written the message, now
! we want to load the system (at 0x10000)

	mov	ax,#SYSSEG
	mov	es,ax		! segment of 0x010000
	call	read_it
	call	kill_motor

	seg cs
	mov	ax,root_dev
	cmp	ax,#0
	jne	root_defined
	seg cs
	mov	bx,sectors
	mov	ax,#0x0208		! /dev/ps0 - 1.2Mb
	cmp	bx,#15
	je	root_defined
	mov	ax,#0x021c		! /dev/PS0 - 1.44Mb
	cmp	bx,#18
	je	root_defined
undef_root:
	jmp undef_root
root_defined:
	seg cs
	mov	root_dev,ax

	jmpi	0,SETUPSEG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先设置好段寄存器位0x1000,然后调用子程序(read_it)将system的部分拷贝到0x1000为起始的内存中,然后调用kill_motor关闭马达.接下来要检查要使用的根文件系统设备,至于检查根文件系统设备中的细节行为,我还没有搞明白.检查完之后,上述代码中最后一行,直接跳转到0x9020:0000,也也就意味着程序bootsect已经执行完了,即将进入下一个阶段,也就是setup的阶段.</p>
<p>剩余的部分是两个子程序read_it和kill_motor,我没有深究太多.</p>
<p>在此简要地梳理一下bootsect的行为:</p>
<ul>
<li><strong>这个阶段全程处于实模式</strong>,采用(段寄存器:偏移寄存器)的寻址方式.</li>
<li><strong>内存程序段的加载与移动.</strong>关于加载和移动,这是两种不同的操作,一个在于将原本内存上的东西移动到另一段内存上,另一个在于将内存中原本不存在的东西从磁盘上载入到一段内存上.前者借助寄存器中的mov指令可以实现,后者需要借助中断(0x13).</li>
<li><strong>中断的使用</strong>.这里中断发挥了很重要的作用,一是int
0x13在磁盘访问中的作用.这时的中断是基于BIOS时期所设置的中断向量表完成的.这就是为什么我们在最初加载system时,没有从0x0000开始的原因,为了避免覆盖中断向量表.除此之外,此时中断有关参数的传递是基于修改几个通用寄存器来完成的.二是关于int
0x10对于屏幕输出的作用.</li>
</ul>
<h3 id="setup.s程序">3) setup.s程序</h3>
<p>这个程序的主要作用在于利用BIOS中的中断将一些系统数据读取到内存0x90000开始的位置.这些参数将服务于后续内核中的一些工作.</p>
<p>除此之外将0x10000-0x8fffff整体向下移动到0x00000.之后准备进入保护模式(加载idt和gdt,开启A20总线,设置好CR0标志着保护模式的开启完成).</p>
<p>最后跳转到system中的head.s代码中.最终内存中的变化,如下所示.</p>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2018%2016%2054%2004%201655542444%201655542444133%20MF3aU1%20image-20220618165403937%20.png" alt="image-20220618165403937">
<figcaption aria-hidden="true">image-20220618165403937</figcaption>
</figure>
<p>之后结合代码进行分析.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">entry start
start:
! ok, the read went well so we get current cursor position and save it for
! posterity.
	mov	ax,#INITSEG	! this is done in bootsect already, but...
	mov	ds,ax
	mov	ah,#0x03	! read cursor pos
	xor	bh,bh
	int	0x10		! save it in known place, con_init fetches
	mov	[0],dx		! it from 0x90000.
! Get memory size (extended mem, kB)
	mov	ah,#0x88
	int	0x15
	mov	[2],ax
! Get video-card data:
	mov	ah,#0x0f
	int	0x10
	mov	[4],bx		! bh = display page
	mov	[6],ax		! al = video mode, ah = window width
! check for EGA/VGA and some config parameters
	mov	ah,#0x12
	mov	bl,#0x10
	int	0x10
	mov	[8],ax
	mov	[10],bx
	mov	[12],cx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述代码是,setup读取一些系统变量的部分,这一部分主要采用“参数配置+中断+内存拷贝”为主.以上分别对应的参数为:</p>
<ul>
<li>光标位置,0x90000,这个参数服务于后来内核在初始化时,需要初始化控制台(console).</li>
<li>拓展内存大小,0x90002.系统从1MB开始的拓展内存数值.</li>
<li>显卡的显示模式,0x90004.</li>
</ul>
<p>除了这里列举的几项之外,还有其他几项暂时不做深究.接下来主要看到保护模式的转换.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">! now we want to move to protected mode ...

	cli			! no interrupts allowed !
! first we move the system to it's rightful place
	mov	ax,#0x0000
	cld			! 'direction'=0, movs moves forward
do_move:
	mov	es,ax		! destination segment
	add	ax,#0x1000
	cmp	ax,#0x9000
	jz	end_move
	mov	ds,ax		! source segment
	sub	di,di
	sub	si,si
	mov 	cx,#0x8000
	rep
	movsw
	jmp	do_move
! then we load the segment descriptors
end_move:
	mov	ax,#SETUPSEG	! right, forgot this at first. didn't work :-)
	mov	ds,ax
	lidt	idt_48		! load idt with 0,0
	lgdt	gdt_48		! load gdt with whatever appropriate
! that was painless, now we enable A20
	call	empty_8042
	mov	al,#0xD1		! command write
	out	#0x64,al
	call	empty_8042
	mov	al,#0xDF		! A20 on
	out	#0x60,al
	call	empty_8042<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先我们需要进行的时,system段的代码移动,代码从一段内存移动到另一段内存采用了mov拷贝的方式.使用循环+mov来进行移动,在每一轮循环中,es:di是内存移动的目的地址,ds:di是源地址,es在ax+0x1000之前赋值,ds在ax+0x1000之后赋值,所以从而实现了目的和源之间地址的偏移,而ax只不过是一个用来保存临时变量的寄存器.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">end_move:
	mov	ax,#SETUPSEG	! right, forgot this at first. didn't work :-)
	mov	ds,ax
	lidt	idt_48		! load idt with 0,0
	lgdt	gdt_48		! load gdt with whatever appropriate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先需要将idt和gdt的地址,加载到idt和gdt对应的寄存器中.但是我们结合前面的经验也可以总结出,如果只是单纯地
<code>lidt idt_48</code>这个时候,其实“idt_48”这个只能代表一个地址的偏移量,而此时采用的寻址方式就是(段:偏移量),所以说这种指令加载的地址其实就是“段:idt_48”,而此时对于段地址的设置,需要设置成SETUPSEG,所以前面需要设置好ds的值,从而表明,所加载的地址就是“0x9020:idt_48”所处的地址.</p>
<p>而对于idt和gdt加载到寄存器中的地址所代表的数据结构,其实并不是“表”的本身.只是相当于“limit+base”这么一个数据结构.limit可以视为这个表的最大长度,后者可以视为这个表的基地址.在此称之为<strong>表描述符</strong>吧.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">gdt:
	.word	0,0,0,0		! dummy

	.word	0x07FF		! 8Mb - limit=2047 (2048*4096=8Mb)
	.word	0x0000		! base address=0
	.word	0x9A00		! code read/exec
	.word	0x00C0		! granularity=4096, 386

	.word	0x07FF		! 8Mb - limit=2047 (2048*4096=8Mb)
	.word	0x0000		! base address=0
	.word	0x9200		! data read/write
	.word	0x00C0		! granularity=4096, 386
idt_48:
	.word	0			! idt limit=0
	.word	0,0			! idt base=0L
gdt_48:
	.word	0x800		! gdt limit=2048, 256 GDT entries
	.word	512+gdt,0x9	! gdt base = 0X9xxxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ucore中也是有类似的表示的.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword keyword-static">static</span> <span class="token keyword keyword-struct">struct</span> <span class="token class-name">pseudodesc</span> idt_pd <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-sizeof">sizeof</span><span class="token punctuation">(</span>idt<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>idt
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果说,这两个表的描述符所处于的地址具体处于什么地方,可以确定的是,它处于setup程序所对应的内存段中,末尾的位置.</p>
<p>这两个表用于顶替BIOS中断表(在system移动之后就已经牺牲了,但也是临时的,其可以发挥的作用后面再进行说明.</p>
<p>之后的这段代码为开启实模式作准备,用于开启A20引脚,从而为后续全面开放机器的寻址能力做基础.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">call	empty_8042
mov	al,#0xD1		! command write
out	#0x64,al
call	empty_8042
mov	al,#0xDF		! A20 on
out	#0x60,al
call	empty_8042<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要体现为轮询设备,只有当输入缓冲器为空时,才可以对其执行写命令,当设备空闲时,对两个端口进行写.这两个端口分别代表什么呢?</p>
<p>之后的一部分有关于对中断的重新编程,没有做太多的深究.之后的部分真正地进入保护模式.这个时候的寻址模式,就转化成了“段号+偏移”的模式,此时需要将段号8带入到gdt中,进而检索出base地址,检索出来的base就是0,所以之后跳转到了0x0000
0000地址处.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov	ax,#0x0001	! protected mode (PE) bit
lmsw	ax		! This is it!
jmpi	0,8		! jmp offset 0 of segment 8 (cs)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>将寄存器cr0设置为1即可,表示已经开启保护模式,随后跳转到cs段中的0偏移处.在这里使用了lmsw来对cr0寄存器进行赋值.就类似ucore中的:</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">movl %cr0, %eax
orl $CR0_PE_ON, %eax
movl %eax, %cr0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>之后就可以说,正式进入保护模式了,接下来要进入的部分就是head.s的部分.</p>
<h3 id="head.s">4)head.s</h3>
<p>从运行head开始,这个时候已经完全处于保护模式之下,其地址处于绝对地址0x0000
0000作为开始.head的作用相对来说比较单一,简而言之如下:</p>
<ul>
<li>加载段寄存器.</li>
<li>重置中断描述符表idt和全局描述符表.</li>
<li>检查A20地址是否真的已经开启.</li>
<li>设置分页机制.</li>
</ul>
<p>首先我们来看关于段寄存器的设置:</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.text
.globl idt,gdt,pg_dir,tmp_floppy_area
pg_dir:
.globl startup_32
startup_32:
	movl $0x10,%eax
	mov %ax,%ds
	mov %ax,%es
	mov %ax,%fs
	mov %ax,%gs
	lss stack_start,%esp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在一开始,对应的位置也就是0x00000000的绝对地址这么一个地址,出现了pg_dir这也就是表示了0x0000
0000用来作为后来目录表的地址.当之后页目录表被加载之后,就见原本此处的程度代码给覆盖掉了.</p>
<p>首先将0x10载入到%ds,%es,%fs,%gs中,此时0x10指的是在gdt中的偏移值,如果将gdt看作一个表的话,那么0x10就是表的索引.这因而也就是段寄存器的含义,段寄存器存储的就是对应某个段描述符在表中的索引.</p>
<p>除此之外 <code>lss stack_start %esp</code>用于系统堆栈的设置.</p>
<p>之后开始充值中断描述符idt和全局描述符表gdt:</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">call setup_idt
call setup_gdt

setup_idt:
	lea ignore_int,%edx
	movl $0x00080000,%eax
	movw %dx,%ax		/* selector = 0x0008 = cs */
	movw $0x8E00,%dx	/* interrupt gate - dpl=0, present */

	lea idt,%edi
	mov $256,%ecx
rp_sidt:
	movl %eax,(%edi)
	movl %edx,4(%edi)
	addl $8,%edi
	dec %ecx
	jne rp_sidt
	lidt idt_descr
	ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中在对于idt的设置上:</p>
<ul>
<li>首先初始化一些变量.</li>
<li>进入一个256步的循环,每一次对应idt表中的每一项.</li>
<li>初始化结束后,将idt描述符加载到idt的寄存器中.</li>
<li>返回.</li>
</ul>
<p>可见,每一项都被设置为相同的ignore_int这个中断描述符.这里仅仅起到一个初始化作用,真正有用的中断描述符还会在后面进行配置.稍微详细地说明一下,在这里参数的配置以及中断描述符的模式.其中%eax表示的是:段选择符+过程入口点偏移值(15..0),而edx表示的是过程入口点偏移值(31..16)和0x8E00.</p>
<p>再次强调一下,ignore_int是一个地址,这个地址表示的并不是一个绝对地址,而是一个偏移值,这个偏移值可以理解为在head.s中的偏移值,也可以说是一个在0x0000
0000之后的偏移值.</p>
<p>而此处理程序的绝对地址,不仅需要偏移值还需要借助段选择符.这个段选择正好就是0x0008,也就对应了0x0000
0000的绝对地址.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">setup_gdt:
	lgdt gdt_descr
	ret
gdt_descr:
	.word 256*8-1		# so does gdt (not that that's any
	.long gdt		# magic number, but it works for me :^)
	.align 8
gdt:	.quad 0x0000000000000000	/* NULL descriptor */
	.quad 0x00c09a0000000fff	/* 16Mb */
	.quad 0x00c0920000000fff	/* 16Mb */
	.quad 0x0000000000000000	/* TEMPORARY - don't use */
	.fill 252,8,0			/* space for LDT's and TSS's etc */<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对应gdt的设置,在描述符上,还是采用了“limit+base”这种数据结构,此时的gdt内容如下:</p>
<ul>
<li>0,NULL.</li>
<li>1-cs段,0x08,其中此段最大为16MB.</li>
<li>2-ds段,0x10,最大长度也是16MB.</li>
<li>3-这一段原本想作为系统调用的段,但是没有使用.</li>
<li>后面为预留的252项,主要防止LDT和TSS.</li>
</ul>
<p>在这里gdt是直接配置好的.所以简单的概括一下,最初的`<code>GDT</code>的状况,也就是只设置好了<strong>内核代码段和内核数据段</strong>.又因为<code>GDT</code>决定了虚拟地址到线性地址的映射,所以从这个角度考虑的话,内核代码段和内核数据段的情况如下:</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2027%2000%2032%2008%201656261128%201656261128239%20Ie5acS%20image-20220627003207948%20.png" alt="image-20220627003207948" style="zoom:50%;"></p>
<p>也就是说,根据<code>head.s</code>中的对于GDT内容的定义,内核代码段和内核数据段的线性地址空间处于<code>0-16MB</code>范围内.占<code>4096</code>个物理页.</p>
<p>关于A20的检查,我没有深究.</p>
<p>下面分析一下,分页机制的开启.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">pg_dir:
.globl startup_32
.org 0x1000
pg0:
.org 0x2000
pg1:
.org 0x3000
pg2:
.org 0x4000
pg3:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先,我们可以从中知道预留出来的页表和页目录表的位置.我们可以简要的梳理出,偏移值,0x0000~0x0ffff是页目录表,之后紧接着是4个4KB大小的页表.每个页项占据4B,总体来说,一个页有1024个页表项.</p>
<p>下面我们来具体看一下设置页表的子程序.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">setup_paging:
	movl $1024*5,%ecx		/* 总共的项数 */
	xorl %eax,%eax			/* 将eax设置为0,进而用%eax来赋值 */
	xorl %edi,%edi			/*  es:edi作为目的地,将%eax拷贝到es:edi中 */
	cld;rep;stosl
	movl $pg0+7,pg_dir		/* 末尾的7代表的是权限位,每一项相当于"偏移值|权限位" */
	movl $pg1+7,pg_dir+4		/*  --------- " " --------- */
	movl $pg2+7,pg_dir+8		/*  --------- " " --------- */
	movl $pg3+7,pg_dir+12		/*  --------- " " --------- */
	movl $pg3+4092,%edi		/* 从最后一页的最后一个页表项开始 */
	movl $0xfff007,%eax		/*  eax作为页表项的内容,这里映射的是0xfff 000地址 */
	std
1:	stosl			/* fill pages backwards - more efficient :-) */
	subl $0x1000,%eax
	jge 1b
	xorl %eax,%eax		/* pg_dir is at 0x0000 */
	movl %eax,%cr3		/* cr3 - page directory start */
	movl %cr0,%eax
	orl $0x80000000,%eax
	movl %eax,%cr0		/* set paging (PG) bit */
	ret			/* this also flushes prefetch-queue */<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简而言之,其过程可以概括为:</p>
<ul>
<li>将5页内存进行初始化,全部设置为0.</li>
<li>设置页目录表,因为有4个页表,所以设置4项.</li>
<li>将四个页表与实际的物理页进行映射.采用将adi反向递减的方式.其中我们可以确定可映射的物理地址的范围是0x000
000-0xfff 000.</li>
<li>设置r3寄存器,将页目录表载入也就是0x0000.</li>
<li>开启分页机制,将cr0最高位设置为1.</li>
</ul>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2018%2019%2008%2033%201655550513%201655550513981%20dSVCVv%20image-20220618190833767%20.png" alt="image-20220618190833767">
<figcaption aria-hidden="true">image-20220618190833767</figcaption>
</figure>
<p>程序执行完之后的内存布局如下:</p>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2018%2018%2043%2018%201655548998%201655548998184%20o7BZ8O%20image-20220618184317971%20.png" alt="image-20220618184317971">
<figcaption aria-hidden="true">image-20220618184317971</figcaption>
</figure>
<h2 id="系统调用">2.系统调用</h2>
<p>linux
0.11中有关于系统调用的文件集中在kernel中.kernel这个文件夹之下的代码有三类:</p>
<ul>
<li>中断处理,比如trap.c等,</li>
<li>系统调用服务程序.比如system_call.s等.</li>
<li>有关于进程调度,比如sched.c;</li>
</ul>
<h3 id="中断处理">1)中断处理</h3>
<p>中断是系统调用的基础,如果不能实现中断相关的处理,那么也就无法实现系统调用,所以在此先讲中断有关的代码进行分析.</p>
<p>我们在init/main.c中就可以看到,其中有一个trap_init的调用,以此为切入点来进行分析.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword keyword-void">void</span> <span class="token function">trap_init</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword keyword-int">int</span> i<span class="token punctuation">;</span>

	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>divide_error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//除以0</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>debug<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在程序的单步跟踪调试时,设置了标识寄存器eflags的T标志产生这个中断</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>nmi<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//NMI是一个不可屏蔽中断</span>
	<span class="token function">set_system_gate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>int3<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* int3-5 can be called from all */</span>
	<span class="token function">set_system_gate</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>overflow<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//由eflags的OF标志引起</span>
	<span class="token function">set_system_gate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>bounds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//寻址越界</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>invalid_op<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//CPU执行无效指令操作</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>device_not_available<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设备不存在</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>double_fault<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//双故障出错</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>coprocessor_segment_overrun<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//断处理器,段超出</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>invalid_TSS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//CPU切换时发现TSS无效</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>segment_not_present<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//段描述符对应段不存在</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>stack_segment<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//堆栈不存在或者越界</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>general_protection<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//与保护机制下的特权级检查不符</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>page_fault<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//缺页</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>reserved<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//空的,留出来,待设置</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>coprocessor_error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//协处理器发出的出错信息</span>
	<span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">17</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">48</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//全都是空的</span>
		<span class="token function">set_trap_gate</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token operator">&amp;</span>reserved<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>irq13<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//协处理器中断处理</span>
	<span class="token function">outb_p</span><span class="token punctuation">(</span><span class="token function">inb_p</span><span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xfb</span><span class="token punctuation">,</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开启8259A主芯片的IRQ2中断请求</span>
	<span class="token function">outb</span><span class="token punctuation">(</span><span class="token function">inb_p</span><span class="token punctuation">(</span><span class="token number">0xA1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xdf</span><span class="token punctuation">,</span><span class="token number">0xA1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开启8259A从芯片的IRQ13中断请求</span>
	<span class="token function">set_trap_gate</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>parallel_interrupt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以发现,这一部分代码以设置中断向量表的陷阱门为主,并且这些陷阱门很大一部分代表的是一些与故障有关的中断.其中的含义,标注在注释中.除此之外,还开启硬件的中断请求允许.</p>
<p>这里和ucore对于中断的初始化方法基本上一致,ucore有关于中断的初始化集中于两个函数中.其中pic_init的作用类似于
<code>outb_p(inb_p(0x21)&amp;0xfb,0x21);outb(inb_p(0xA1)&amp;0xdf,0xA1);</code>作用在于激活8259A有关于中断的请求.除此之外ucore最后初始化中断向量表结束之后,还将中断向量表(描述符)地址加载到了相应的寄存器中(<code>lidt(&amp;idt_pd);</code>).我们再看linux
0.11的话,中断向量表配置好之后,我们没有在trap_init中看到加载的操作.,究竟是怎么做的?</p>
<p>更具体看中断向量表的配置的话,这些set操作是几个宏定义,更底层是借助汇编实现的.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_intr_gate</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span>addr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">_set_gate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idt<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_trap_gate</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span>addr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">_set_gate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idt<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_system_gate</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span>addr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">_set_gate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idt<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这几项,分别对应的是:idt表中的地址,类型(陷阱,中断.....),特权级,处理程序的地址.而这里的这个idt,是head.s中就定义好的idt,其地址位于system模块中,位于0x7000偏移量的中断向量表,再回顾head.s中的行为,我们可以发现head中早就有使用
<code>lidt idt_descr</code>的指令,加载到CPU中的IDTR寄存器.从而使CPU明确了idt的位置.所以,至此上面所提到的关于idt加载的问题也就解决了.</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2019%2016%2046%2036%201655628396%201655628396096%20ijF22W%20image-20220619164635886%20.png" alt="image-20220619164635886" style="zoom:50%;"></p>
<p>其中断描述符设置的细节和ucore区别不大,因为两者中断描述符的结构都是一样的.若真要说,有什么区别,就是是否使用了c语言的抽象,我认为linux
0.11中,直接使用了汇编写到了idt的内存中,实现了对idt项的设置.而ucore,则多了一层抽象,ucore借助了c语言的抽象,它将段描述符抽象成结构体,读idt项的设置体现为对该结构体项的赋值,而这些结构体也恰恰是对idt表中一个个中断描述符的抽象.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//ucore对于中断描述符的设置</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SETGATE</span><span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">,</span> istrap<span class="token punctuation">,</span> sel<span class="token punctuation">,</span> off<span class="token punctuation">,</span> dpl<span class="token punctuation">)</span> <span class="token punctuation">{</span>               </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_off_15_0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>off<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>      </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_ss <span class="token operator">=</span> <span class="token punctuation">(</span>sel<span class="token punctuation">)</span><span class="token punctuation">;</span>                                </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_args <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                 </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_rsv1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                 </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_type <span class="token operator">=</span> <span class="token punctuation">(</span>istrap<span class="token punctuation">)</span> <span class="token operator">?</span> STS_TG32 <span class="token operator">:</span> STS_IG32<span class="token punctuation">;</span>    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_dpl <span class="token operator">=</span> <span class="token punctuation">(</span>dpl<span class="token punctuation">)</span><span class="token punctuation">;</span>                              </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_p <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                                    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span>gate<span class="token punctuation">)</span><span class="token punctuation">.</span>gd_off_31_16 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>off<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>        </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span></span></span>
<span class="token comment">//linux 0.11的设置</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_set_gate</span><span class="token expression"><span class="token punctuation">(</span>gate_addr<span class="token punctuation">,</span>type<span class="token punctuation">,</span>dpl<span class="token punctuation">,</span>addr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token function">__asm__</span> <span class="token punctuation">(</span></span><span class="token string">"movw %%dx,%%ax\n\t"</span> <span class="token punctuation">\</span>
	<span class="token string">"movw %0,%%dx\n\t"</span> <span class="token punctuation">\</span>
	<span class="token string">"movl %%eax,%1\n\t"</span> <span class="token punctuation">\</span>
	<span class="token string">"movl %%edx,%2"</span> <span class="token punctuation">\</span>
	<span class="token expression"><span class="token operator">:</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token operator">:</span> </span><span class="token string">"i"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-short">short</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0x8000</span><span class="token operator">+</span><span class="token punctuation">(</span>dpl<span class="token operator">&lt;&lt;</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>type<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
	<span class="token string">"o"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-char">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gate_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
	<span class="token string">"o"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword keyword-char">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gate_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
	<span class="token string">"d"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-char">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token string">"a"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x00080000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以,就在中断初始化方面,我认为两者在实现上的主要区别在于:</p>
<ul>
<li><strong>idt加载的时机不同</strong>.看ucore的boot就可以发现,其中没有关于idt的设置.而linux
0.11在head.s运行阶段,就做好了对idt的初始化,包括IDTR寄存器的载入.</li>
<li><strong>ucore对于中断描述符的抽象化层次更高</strong>,ucore的中断描述符和中断向量表都抽象了对应的c语言形式的数据结构,其set也是处于c语言的层次上进行的,而linux
0.11对于中断描述符的设置,除了一层宏定义外,在往下就是直接使用汇编来对idt的内存进行设置.</li>
</ul>
<p>下面,我们再来看一下,中断处理程序的定义.每个中断事件对应的中断处理程序的入口,集中定义在
<code>/kernel/asm.s</code>
中.其中的模式,基本上都是类似的,但是大体上可以分为三类:</p>
<ul>
<li>压入处理函数地址,并跳转到执行no_error_code的.</li>
<li>压入处理函数地址,并跳转到执行error_code的.</li>
<li>Irq13.</li>
</ul>
<p>首先压入一个要执行的函数的地址,这些地址在trap.c中有定义.然后执行
<code>no_error_code</code>,</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2019%2017%2022%2006%201655630526%201655630526660%20gsB7FZ%20image-20220619172206398%20.png" alt="image-20220619172206398" style="zoom:50%;"></p>
<p>总体来说,这个过程中堆栈的状况是如图中所示的,不过图中的例子都是特权级发生转变的情况,如果是没有发生转变的情况,那么就不会有原ss和esp的压入,c函数地址前的寄存器都是硬件压入的.</p>
<p>但仅仅把握住这些还是不够的,应该还结合代码进行更细致地分析.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">error_code:
	xchgl %eax,4(%esp)		# error code &lt;-&gt; %eax
	xchgl %ebx,(%esp)		# &amp;function &lt;-&gt; %ebx
	pushl %ecx
	pushl %edx
	pushl %edi
	pushl %esi
	pushl %ebp
	push %ds
	push %es
	push %fs
	pushl %eax			# error code
	lea 44(%esp),%eax		# offset
	pushl %eax
	movl $0x10,%eax
	mov %ax,%ds
	mov %ax,%es
	mov %ax,%fs
	call *%ebx
	addl $8,%esp
	pop %fs
	pop %es
	pop %ds
	popl %ebp
	popl %esi
	popl %edi
	popl %edx
	popl %ecx
	popl %ebx
	popl %eax
	iret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结合代码分析,除了压栈和弹栈之外,最核心的操作在于借助交换指令,将错误码和处理函数地址保存到了%eax和%ebx中,所以后来执行
<code>call *%ebx</code>进行地址跳转,进入到中断处理函数,%eax保存了错误码,所执行的中断处理函数中是有用的,接着则是将栈弹出.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword keyword-void">void</span> <span class="token function">do_divide_error</span><span class="token punctuation">(</span><span class="token keyword keyword-long">long</span> esp<span class="token punctuation">,</span> <span class="token keyword keyword-long">long</span> error_code<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">die</span><span class="token punctuation">(</span><span class="token string">"divide error"</span><span class="token punctuation">,</span>esp<span class="token punctuation">,</span>error_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment">//在具体的中断处理函数中,确实用到了%eax中保存的error_code.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>相比之下,ucore和linux
0.11在这个地方处理的最大不同,我认为仍然在于抽象的层次上.ucore将压栈过程中的这一系列寄存器(也包含中断向量号,错误码等)抽象成了一个
<code>trapframe</code>数据结构,并且定义了一个
<code>trap_dispatch</code>函数作为分发器,将之前所抽象的trapframe的指针作为媒介传递到这个“分发器”中,这个复用器会根据中断向量号分出不同的分支,进而也对应了不同的处理,执行完之后返回.而linux
0.11只是直接压入处理函数的地址,并且直接执行这个地址上的函数.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//ucore中trapframe</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">trapframe</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">pushregs</span> tf_regs<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_gs<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_padding0<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_fs<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_padding1<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_es<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_padding2<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_ds<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_padding3<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> tf_trapno<span class="token punctuation">;</span>
    <span class="token comment">/* below here defined by x86 hardware */</span>
    <span class="token class-name">uint32_t</span> tf_err<span class="token punctuation">;</span>
    <span class="token class-name">uintptr_t</span> tf_eip<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_cs<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_padding4<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> tf_eflags<span class="token punctuation">;</span>
    <span class="token comment">/* below here only when crossing rings, such as from user to kernel */</span>
    <span class="token class-name">uintptr_t</span> tf_esp<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_ss<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> tf_padding5<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword keyword-__attribute__">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="系统调用到中断处理之间的部分">2)系统调用到中断处理之间的部分</h3>
<p>下面,我们主要关注system_call.s程序.</p>
<p>首先,需要明白的是,用户调用通过使用中断调用
<code>int 0x80</code>和存放寄存器%eax中的功能号来使用内核提供的各种系统服务.用户并不是直接使用系统调用中断,而是通过libc中的接口调用.</p>
<p>以 <code>unistd.h</code>函数库中的系统调用为例,这些系统调用都需要借助
<code>int 0x80</code>来进行处理,而这些需要使用
<code>int 0x80</code>的系统调用每个又都有不同的编号,进而区分为不同的事件.这些事件号在触发
<code>int 0x80</code>时被保存在%eax寄存器中.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_syscall3</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span>name<span class="token punctuation">,</span>atype<span class="token punctuation">,</span>a<span class="token punctuation">,</span>btype<span class="token punctuation">,</span>b<span class="token punctuation">,</span>ctype<span class="token punctuation">,</span>c<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression">type <span class="token function">name</span><span class="token punctuation">(</span>atype a<span class="token punctuation">,</span>btype b<span class="token punctuation">,</span>ctype c<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword keyword-long">long</span> __res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression">__asm__ <span class="token keyword keyword-volatile">volatile</span> <span class="token punctuation">(</span></span><span class="token string">"int $0x80"</span> <span class="token punctuation">\</span>
	<span class="token expression"><span class="token operator">:</span> </span><span class="token string">"=a"</span> <span class="token expression"><span class="token punctuation">(</span>__res<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token operator">:</span> </span><span class="token string">"0"</span> <span class="token expression"><span class="token punctuation">(</span>__NR_</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token string">"b"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-long">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token string">"c"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-long">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token string">"d"</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-long">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>__res<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> __res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression">errno<span class="token operator">=</span><span class="token operator">-</span>__res<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个时候,有一个疑问,就在于我们当初在进行初始化idt的时候没有设置0x80所对应的的中断描述符,既然如此
<code>int 0x80</code>又是怎样执行的呢?</p>
<p>这在linux
0.11中,我认为是比较奇怪的,它在sched.c中对0x80对应的中断描述符进行了设置.其实现代码如下:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword keyword-void">void</span> <span class="token function">sched_init</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//code......</span>
	<span class="token function">set_intr_gate</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>timer_interrupt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//code......</span>
	<span class="token function">set_system_gate</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>system_call<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个函数中设置了0x80和0x20.我们可以感觉出,idt表的配置并不是在idt_init一次性就完成的.所以我们在这里也可以确定,<code>int 0x80</code>的入口就是system_call,定义在system_call.s中.</p>
<p>下面来复盘一下,以close为例,一个系统调用究竟发生了什么.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LIBRARY__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token function">_syscall1</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span><span class="token punctuation">,</span>close<span class="token punctuation">,</span><span class="token keyword keyword-int">int</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//这个宏定义展开之后是这样的</span>
<span class="token keyword keyword-int">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> fd<span class="token punctuation">)</span> 
<span class="token punctuation">{</span> 
    <span class="token keyword keyword-long">long</span> __res<span class="token punctuation">;</span>    
    __asm__ <span class="token keyword keyword-volatile">volatile</span> <span class="token punctuation">(</span><span class="token string">"int $0x80"</span> 
        <span class="token operator">:</span> <span class="token string">"=a"</span> <span class="token punctuation">(</span>__res<span class="token punctuation">)</span> 
        <span class="token operator">:</span> <span class="token string">"0"</span> <span class="token punctuation">(</span>__NR_close<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"b"</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-long">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>__res <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span><span class="token punctuation">)</span> __res<span class="token punctuation">;</span> 
    errno <span class="token operator">=</span> <span class="token operator">-</span>__res<span class="token punctuation">;</span> 
    <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token comment">//将事件号__NR_close存入%eax,将参数fd存入%edx后,触发int 0x80中断,注意参数要存在通用寄存器中,并且最多3个.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后进入
<code>system_call</code>进行处理,下面重点分析一下这个程序.</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">system_call:
	cmpl $nr_system_calls-1,%eax
	ja bad_sys_call
	push %ds
	push %es
	push %fs
	pushl %edx
	pushl %ecx		# push %ebx,%ecx,%edx as parameters
	pushl %ebx		# to the system call
	movl $0x10,%edx		# set up ds,es to kernel space
	mov %dx,%ds
	mov %dx,%es
	movl $0x17,%edx		# fs points to local data space
	mov %dx,%fs
	call sys_call_table(,%eax,4)
	pushl %eax
	movl current,%eax
	cmpl $0,state(%eax)		# state
	jne reschedule
	cmpl $0,counter(%eax)		# counter
	je reschedule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其过程可以概括如下:</p>
<ul>
<li>比较事件号(%eax)是否合法,如果不合法就跳转到bad_sys_call处理.</li>
<li>压入段寄存器(ds,es指向内核代码段,fs指向局部数据段).</li>
<li>传参,也就是三个通用寄存器.</li>
<li>调用内核中的处理函数,通过一个函数表,也就是一个地址的数组.这个函数表定义如下:</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
fn_ptr sys_call_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> sys_setup<span class="token punctuation">,</span> sys_exit<span class="token punctuation">,</span> sys_fork<span class="token punctuation">,</span> sys_read<span class="token punctuation">,</span>
sys_write<span class="token punctuation">,</span> sys_open<span class="token punctuation">,</span> sys_close<span class="token punctuation">,</span> sys_waitpid<span class="token punctuation">,</span> sys_creat<span class="token punctuation">,</span> sys_link<span class="token punctuation">,</span>
sys_unlink<span class="token punctuation">,</span> sys_execve<span class="token punctuation">,</span> sys_chdir<span class="token punctuation">,</span> sys_time<span class="token punctuation">,</span> sys_mknod<span class="token punctuation">,</span> sys_chmod<span class="token punctuation">,</span>
sys_chown<span class="token punctuation">,</span> sys_break<span class="token punctuation">,</span> sys_stat<span class="token punctuation">,</span> sys_lseek<span class="token punctuation">,</span> sys_getpid<span class="token punctuation">,</span> sys_mount<span class="token punctuation">,</span>
sys_umount<span class="token punctuation">,</span> sys_setuid<span class="token punctuation">,</span> sys_getuid<span class="token punctuation">,</span> sys_stime<span class="token punctuation">,</span> sys_ptrace<span class="token punctuation">,</span> sys_alarm<span class="token punctuation">,</span>
sys_fstat<span class="token punctuation">,</span> sys_pause<span class="token punctuation">,</span> sys_utime<span class="token punctuation">,</span> sys_stty<span class="token punctuation">,</span> sys_gtty<span class="token punctuation">,</span> sys_access<span class="token punctuation">,</span>
sys_nice<span class="token punctuation">,</span> sys_ftime<span class="token punctuation">,</span> sys_sync<span class="token punctuation">,</span> sys_kill<span class="token punctuation">,</span> sys_rename<span class="token punctuation">,</span> sys_mkdir<span class="token punctuation">,</span>
sys_rmdir<span class="token punctuation">,</span> sys_dup<span class="token punctuation">,</span> sys_pipe<span class="token punctuation">,</span> sys_times<span class="token punctuation">,</span> sys_prof<span class="token punctuation">,</span> sys_brk<span class="token punctuation">,</span> sys_setgid<span class="token punctuation">,</span>
sys_getgid<span class="token punctuation">,</span> sys_signal<span class="token punctuation">,</span> sys_geteuid<span class="token punctuation">,</span> sys_getegid<span class="token punctuation">,</span> sys_acct<span class="token punctuation">,</span> sys_phys<span class="token punctuation">,</span>
sys_lock<span class="token punctuation">,</span> sys_ioctl<span class="token punctuation">,</span> sys_fcntl<span class="token punctuation">,</span> sys_mpx<span class="token punctuation">,</span> sys_setpgid<span class="token punctuation">,</span> sys_ulimit<span class="token punctuation">,</span>
sys_uname<span class="token punctuation">,</span> sys_umask<span class="token punctuation">,</span> sys_chroot<span class="token punctuation">,</span> sys_ustat<span class="token punctuation">,</span> sys_dup2<span class="token punctuation">,</span> sys_getppid<span class="token punctuation">,</span>
sys_getpgrp<span class="token punctuation">,</span> sys_setsid<span class="token punctuation">,</span> sys_sigaction<span class="token punctuation">,</span> sys_sgetmask<span class="token punctuation">,</span> sys_ssetmask<span class="token punctuation">,</span>
sys_setreuid<span class="token punctuation">,</span>sys_setregid <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>处理结束后,根据<strong>当前进程是否就绪</strong>和<strong>时间片是否为0</strong>来判断是否需要让出CPU,进入schedule.</li>
</ul>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">ret_from_sys_call:
	movl current,%eax		# task[0] cannot have signals
	cmpl task,%eax
	je 3f
	cmpw $0x0f,CS(%esp)		# was old code segment supervisor ?
	jne 3f
	cmpw $0x17,OLDSS(%esp)		# was stack segment = 0x17 ?
	jne 3f
	movl signal(%eax),%ebx
	movl blocked(%eax),%ecx
	notl %ecx
	andl %ebx,%ecx
	bsfl %ecx,%ecx
	je 3f
	btrl %ecx,%ebx
	movl %ebx,signal(%eax)
	incl %ecx
	pushl %ecx
	call do_signal
	popl %eax
3:	popl %eax
	popl %ebx
	popl %ecx
	popl %edx
	pop %fs
	pop %es
	pop %ds
	iret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来是处理完后,返回的部分.<strong>暂鸽</strong>.</p>
<h3 id="增加系统调用要干的事">3)增加系统调用要干的事</h3>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">yfs</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2022/061731999.html">http://example.com/2022/061731999.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">yfs</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/linux/">
                                    <span class="chip bg-color">linux</span>
                                </a>
                            
                                <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                                    <span class="chip bg-color">操作系统</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/062117979.html">
                    <div class="card-image">
                        
                        <img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2021%2015%2034%2002%201655796842%201655796842773%20V7XCTd%20CD91185C5387BCDC6AAF36ABF14D7A5A%20.jpg" class="responsive-img" alt="Inside The C++ Object Model reading notes">
                        
                        <span class="card-title">Inside The C++ Object Model reading notes</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Inside The C++ Object Model,即《深度探索C++对象模型》,是讲解C++对象底层实现机制的经典著作.个人感觉这本书实在是太难了😭.
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-06-21
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            yfs
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/061715238.html">
                    <div class="card-image">
                        
                        <img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2006%2017%2000%2018%2017%201655396297%201655396297298%201pCOxg%20image-20220617001817107%20.png" class="responsive-img" alt="effective C++ reading notes">
                        
                        <span class="card-title">effective C++ reading notes</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            effective C++的读书笔记,很多地方理解的还不深,但有空就会拿来看几章.尽可能保持精简.
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-06-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            yfs
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">yfs</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/YfsBox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1027342142@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1027342142" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1027342142" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<script src="/js/prism/prism.js" async></script>
<link rel="stylesheet" href="/css/prism.css">

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

    <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>');
        }
        </script>
        

</body>

</html>
