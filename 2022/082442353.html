<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="总体来说,lab3这一部分就是为lab4打基础的,所以难度并不是太难,可讲的东西并不多. 这一部分,让我们实现raft之上的应用层,通过这次实验我对raft论文中开头所提的复制状态机理论有更深刻的认识.  将应用层抽象成一个状态机,而这个对于这个状态机的操作抽象日志序列,大前提是,操作序列一致则状态机状态一致,因此维护状态机的一致性也就成了维护log的一致性.其中对于快照,快照是一个对于raft之">
<meta property="og:type" content="article">
<meta property="og:title" content="mit 6.824:分布式系统 lab3 kvraft">
<meta property="og:url" content="http://example.com/2022/082442353.html">
<meta property="og:site_name" content="Yfs&#39;s Box">
<meta property="og:description" content="总体来说,lab3这一部分就是为lab4打基础的,所以难度并不是太难,可讲的东西并不多. 这一部分,让我们实现raft之上的应用层,通过这次实验我对raft论文中开头所提的复制状态机理论有更深刻的认识.  将应用层抽象成一个状态机,而这个对于这个状态机的操作抽象日志序列,大前提是,操作序列一致则状态机状态一致,因此维护状态机的一致性也就成了维护log的一致性.其中对于快照,快照是一个对于raft之">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2008%2024%2023%2031%2018%201661355078%201661355078070%20TIEN22%20image-20220824233117960%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2008%2026%2020%2054%2023%201661518463%201661518463268%20mjfW45%20image-20220826205423116%20.png">
<meta property="og:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2008%2026%2021%2035%2034%201661520934%201661520934250%20wGHA4o%20image-20220826213534157%20.png">
<meta property="article:published_time" content="2022-08-24T15:22:32.000Z">
<meta property="article:modified_time" content="2022-08-28T06:54:30.732Z">
<meta property="article:author" content="yfs">
<meta property="article:tag" content="分布式系统">
<meta property="article:tag" content="mit 6.824">
<meta property="article:tag" content="golang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2008%2024%2023%2031%2018%201661355078%201661355078070%20TIEN22%20image-20220824233117960%20.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>mit 6.824:分布式系统 lab3 kvraft</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<link rel="stylesheet" href="/js/prism/prism.css">

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/082850198.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/082346124.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/082442353.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/082442353.html&text=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/082442353.html&is_video=false&description=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=mit 6.824:分布式系统 lab3 kvraft&body=Check out this article: http://example.com/2022/082442353.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/082442353.html&name=mit 6.824:分布式系统 lab3 kvraft&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/082442353.html&t=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%A6%81%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">1.实现要点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%9A%84%E7%B1%BB%E5%8F%8A%E5%85%B6%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">1)核心的类及其数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%9A%84%E8%B6%85%E6%97%B6%E4%B8%8E%E9%87%8D%E4%BC%A0"><span class="toc-number">1.2.</span> <span class="toc-text">2)请求的超时与重传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E9%87%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">3)去重机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9A%84rpc%E5%8F%82%E6%95%B0%E4%B8%8E%E5%93%8D%E5%BA%94"><span class="toc-number">1.4.</span> <span class="toc-text">4) 相关的RPC参数与响应</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 实现过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#clerk"><span class="toc-number">2.1.</span> <span class="toc-text">1) Clerk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server"><span class="toc-number">2.2.</span> <span class="toc-text">2) Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rpc%E5%A4%84%E7%90%86"><span class="toc-number">2.2.1.</span> <span class="toc-text">RPC处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#raft%E6%97%A5%E5%BF%97%E6%8F%90%E4%BA%A4"><span class="toc-number">2.2.2.</span> <span class="toc-text">raft日志提交</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E7%85%A7%E6%8F%90%E4%BA%A4"><span class="toc-number">2.2.3.</span> <span class="toc-text">快照提交</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">3.问题总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%93%8D%E4%BD%9C%E4%B8%8E%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">3.1.</span> <span class="toc-text">1) 幂等操作与线性一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kvraft%E5%AF%B9%E4%BA%8E%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3"><span class="toc-number">3.2.</span> <span class="toc-text">2)
Kvraft对于线性一致性问题的解决</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        mit 6.824:分布式系统 lab3 kvraft
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">yfs</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-08-24T15:22:32.000Z" itemprop="datePublished">2022-08-24</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/golang/" rel="tag">golang</a>, <a class="tag-link-link" href="/tags/mit-6-824/" rel="tag">mit 6.824</a>, <a class="tag-link-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" rel="tag">分布式系统</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>总体来说,lab3这一部分就是为lab4打基础的,所以难度并不是太难,可讲的东西并不多.</p>
<p>这一部分,让我们实现raft之上的应用层,通过这次实验我对raft论文中开头所提的复制状态机理论有更深刻的认识.</p>
<p><img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2008%2024%2023%2031%2018%201661355078%201661355078070%20TIEN22%20image-20220824233117960%20.png" alt="image-20220824233117960" style="zoom: 50%;"></p>
<p>将应用层抽象成一个状态机,而这个对于这个状态机的操作抽象日志序列,<strong>大前提是,操作序列一致则状态机状态一致</strong>,因此维护状态机的一致性也就成了维护log的一致性.其中对于快照,快照是一个对于raft之上的应用层而言的东西,快照应该保存的是应用层状态机的状态.</p>
<h2 id="实现要点">1.实现要点</h2>
<h3 id="核心的类及其数据结构">1)核心的类及其数据结构</h3>
<p>首先是<code>Clerk</code>,其中<code>currentLeader</code>的作用在于,每次发其请求时,都优先从<code>currLeader</code>开始遍历,这样的话,可以有效地节省时间开销.每当成功从某个RPC返回,都会将<code>currLeader</code>设置该节点.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-type">type</span> Clerk <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd
	<span class="token comment">// You will have to modify this struct.</span>
	currLeader  <span class="token builtin">int</span>
	commandId	<span class="token builtin">int</span>
	clientId	<span class="token builtin">int64</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于<code>clientId</code>,这个在每个client初始化的时候,被设置成一个64位随机数,可以保证每个<code>client</code>的唯一性,而commandId维护的是该<code>Clerk</code>发起的请求的序列,每发起一个请求就+1,由于<code>Clerk</code>发起的请求是同步阻塞的,结合这个可以用来做去重判断.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-type">type</span> KVServer <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	mu           sync<span class="token punctuation">.</span>Mutex
	me           <span class="token builtin">int</span>
	rf           <span class="token operator">*</span>raft<span class="token punctuation">.</span>Raft
	applyCh      <span class="token keyword keyword-chan">chan</span> raft<span class="token punctuation">.</span>ApplyMsg
	dead         <span class="token builtin">int32</span> <span class="token comment">// set by Kill()</span>
	kvMap        <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	commitMap    <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token comment">//用来记录每一个client的commited情况</span>
	applyBuffer  <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span><span class="token keyword keyword-chan">chan</span> AppliedResult
	maxraftstate <span class="token builtin">int</span> <span class="token comment">// snapshot if log grows this big</span>
	<span class="token comment">// Your definitions here.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中<code>applyCh</code>是用来接收来自raft的apply.其中kvMap就是用来存储数据的,也就是本次lab的核心操作对象,所有的请求和应用都最终作用于kvMap上,也是整个状态机的核心,需要进行持久化保存,加入快照.此外<code>applyBuffer</code>只有直接处理请求的<code>leader</code>才会使用,当leader接收到请求,调用raft的<code>Start</code>往下进行一致性处理的时候,就会等待在这个channel上,当成功apply某一个条目之后,该channel才会停止阻塞(不考虑超时).其key通过该请求的clientId的前32位和commandId的后32位组成.</p>
<h3 id="请求的超时与重传">2)请求的超时与重传</h3>
<p>我们需要考虑的是一个不可靠的情景下,如何提供可靠的服务,在这里请求是从<code>client</code>到运行raft服务器节点的,更具体地说,是到<code>leader</code>的.在这里提供与TCP类似的一种机制,通过设定一个固定的时限作为timeout,这个值的设置避免了因为一些不可靠的情况导致某个请求无限制地阻塞,导致无法进行新的尝试,并且一直阻塞后面的操作.如果出现超时也就认为是这个消息请求失败了,进而需要进行重传.接下来看一下,在<code>client</code>发送端和<code>server</code>接收端的处理.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-select">select</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-case">case</span> appliedresult <span class="token operator">=</span> <span class="token operator">&lt;-</span> tmpch<span class="token punctuation">:</span>
		isout <span class="token operator">=</span> <span class="token boolean">false</span>
	<span class="token keyword keyword-case">case</span> <span class="token operator">&lt;-</span> time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">:</span>
		isout <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面是server端的超时判断情况,对于每个请求都会有一个唯一的序列号,对于server(leader)处理的每个序列号都会有一个<code>channel</code>,这个<code>channel</code>用来等待raft完成一致后,将此log提交上来.</p>
<p>所以这种机制下,在超时或者raft提交上来之前都会一致阻塞,由于RPC处理具有阻塞性,因此client端也就会阻塞在RPC调用的地方.</p>
<p>如果返回超时,或者其他错误,则会使client陷入重传,直到返回OK为止.client段的实现如下,采用一个for循环,不断地尝试,一旦尝试成功则退出此循环.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
		result <span class="token operator">:=</span> PutAppendReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>currLeader<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.PutAppend"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> ok <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">{</span>
			<span class="token keyword keyword-return">return</span> <span class="token comment">//这个时候说明执行结束</span>
		<span class="token punctuation">}</span>
		serverNumber <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span>servers<span class="token punctuation">)</span> <span class="token comment">//说明此时currentleader无效需要尝试其他的节点</span>
		<span class="token keyword keyword-for">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> serverNumber<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-if">if</span> i <span class="token operator">==</span> ck<span class="token punctuation">.</span>currLeader <span class="token punctuation">{</span>
				<span class="token keyword keyword-continue">continue</span>
			<span class="token punctuation">}</span>
			reply <span class="token operator">:=</span> GetReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
			ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.PutAppend"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>
			<span class="token keyword keyword-if">if</span> ok <span class="token operator">&amp;&amp;</span> reply<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">{</span>
				ck<span class="token punctuation">.</span>currLeader <span class="token operator">=</span> i
				<span class="token keyword keyword-return">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="去重机制">3)去重机制</h3>
<p>当某个请求超时的时候,就将其视为错误的RPC,但实际上其中有一部分只是超时,并不是真正的出错,在这种情况下,还应该增加一定的去重机制.</p>
<p>我最一开始的设想是设一个map,map的key是每个apply对应的请求序列号,但是这样当请求数量上来之后,会占用过多的空间,此外这一部分是需要进行持久化处理和快照的,所以造成的快照过大,导致有一个测试(检测快照大小)会不通过,所以这种方式并不好.</p>
<p>较好的方式是,每个<code>server</code>都维护一个map,这个map的key指的是某个<code>client</code>序列号,其中的值是每个<code>client</code>对应的请求序列(已经提交成功的).每次接收到一个来自raft层的提交时,对于其中<code>put,append</code>等操作都会检查其请求序列号,和该map中对应的值进行比对,如果是已经重复提交过的,则就是小于等于对应值的.每成功接受一个apply,就会更新对应的值.</p>
<p>关于如何唯一标识一个用户的请求,其方式如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token function">getSerial</span><span class="token punctuation">(</span>clientId <span class="token builtin">int64</span><span class="token punctuation">,</span>cmdId <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	low <span class="token operator">:=</span> clientId <span class="token operator">&gt;&gt;</span> <span class="token number">32</span>
	high <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>cmdId<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span>
	<span class="token keyword keyword-return">return</span> high <span class="token operator">+</span> low
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是借助一个<code>ClientId</code>和<code>CommandId</code>实现,因为<code>ClientId</code>也是一个随机数,在一个服务器节点初始化时由<code>rand</code>函数生成.</p>
<h3 id="相关的rpc参数与响应">4) 相关的RPC参数与响应</h3>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-type">type</span> PutAppendArgs <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	Key   <span class="token builtin">string</span>
	Value <span class="token builtin">string</span>
	Op    <span class="token builtin">string</span> 
	ClientId	<span class="token builtin">int64</span>
	CommandId	<span class="token builtin">int</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-type">type</span> PutAppendReply <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	Err Err
<span class="token punctuation">}</span>
<span class="token keyword keyword-type">type</span> GetArgs <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	Key <span class="token builtin">string</span>
	<span class="token comment">// You'll have to add definitions here.</span>
	ClientId	<span class="token builtin">int64</span>
	CommandId	<span class="token builtin">int</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-type">type</span> GetReply <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	Err   Err
	Value <span class="token builtin">string</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中有两对RPC的处理,即<code>PutAppend</code>和<code>Get</code>的,其中前者的参数中包含Op要么是<code>Put</code>,要么是<code>Append</code>,<code>ClientId</code>和<code>CommandId</code>结合使用可以唯一地在kv数据库中定一个一个唯一的操作,<code>Get</code>部分同理.</p>
<h2 id="实现过程">2. 实现过程</h2>
<h3 id="clerk">1) Clerk</h3>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">PutAppend</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">,</span> op <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ck<span class="token punctuation">.</span>commandId <span class="token operator">+=</span> <span class="token number">1</span>
	args <span class="token operator">:=</span> PutAppendArgs<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>          key<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>        value<span class="token punctuation">,</span>
		Op<span class="token punctuation">:</span>           op<span class="token punctuation">,</span>
		SerialNumber<span class="token punctuation">:</span> <span class="token function">nrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		CommandId<span class="token punctuation">:</span>	ck<span class="token punctuation">.</span>commandId<span class="token punctuation">,</span>
		ClientId<span class="token punctuation">:</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
		result <span class="token operator">:=</span> PutAppendReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token comment">//DPrintf("[%v]The ck.currenleader %v call rpc %v\n",ck.clientId,ck.currLeader,args)</span>
		ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>ck<span class="token punctuation">.</span>currLeader<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.PutAppend"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> ok <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">{</span>
			<span class="token comment">//DPrintf("The loop break when call %v\n", ck.currLeader)</span>
			<span class="token comment">//DPrintf("[%v] Put or Append success args %v\n",ck.clientId,args)</span>
			<span class="token keyword keyword-return">return</span> <span class="token comment">//这个时候说明执行结束</span>
		<span class="token punctuation">}</span>
		serverNumber <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span>servers<span class="token punctuation">)</span> <span class="token comment">//说明此时currentleader无效需要尝试其他的节点</span>
		<span class="token keyword keyword-for">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> serverNumber<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token keyword keyword-if">if</span> i <span class="token operator">==</span> ck<span class="token punctuation">.</span>currLeader <span class="token punctuation">{</span>
				<span class="token keyword keyword-continue">continue</span>
			<span class="token punctuation">}</span>
			reply <span class="token operator">:=</span> GetReply<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token comment">//DPrintf("[%v]The server %v call rpc %v\n",ck.clientId,i,args)</span>
			ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"KVServer.PutAppend"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>
			<span class="token keyword keyword-if">if</span> ok <span class="token operator">&amp;&amp;</span> reply<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">{</span>
				ck<span class="token punctuation">.</span>currLeader <span class="token operator">=</span> i
				<span class="token comment">//DPrintf("[%v] Put or Append success args %v\n",ck.clientId,args)</span>
				<span class="token keyword keyword-return">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中关于<code>Clerk</code>部分的实现还是比较简单的,除了关于RPC参数的设置,其中请求的部分处于一个训话中,直到返回到OK才会跳出循环,返回该请求函数,因为我们可以说,这是一个同步阻塞的函数,在一个用户的请求时,只要当前请求还没有得到ok的回应,这个用户进程就以一直处于for中,某一个时间点上,一个Clerk只在处理或者等待一个RPC请求.有一个加速的技巧在于,每成功获取一个OK的响应,就会记住其对应的leader,在进行下一次循环时,优先从<code>leader</code>中运行.</p>
<h3 id="server">2) Server</h3>
<h4 id="rpc处理">RPC处理</h4>
<p>在这里两者差不多,在这以<code>Get</code>为例子.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">operation <span class="token operator">:=</span> Op<span class="token punctuation">{</span>
		Optype<span class="token punctuation">:</span>       GetOp<span class="token punctuation">,</span>
		Key<span class="token punctuation">:</span>          args<span class="token punctuation">.</span>Key<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>        None<span class="token punctuation">,</span>
		ClientId<span class="token punctuation">:</span>     args<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>
		CommandId<span class="token punctuation">:</span>    args<span class="token punctuation">.</span>CommandId<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span><span class="token boolean">_</span><span class="token punctuation">,</span>isleader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span> <span class="token comment">//调用raft争取达成共识</span>
	<span class="token keyword keyword-if">if</span> <span class="token operator">!</span>isleader <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword keyword-return">return</span>
	<span class="token punctuation">}</span>
	tmpch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword keyword-chan">chan</span> AppliedResult<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span><span class="token function">initCommitMap</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">)</span>
	serial <span class="token operator">:=</span> <span class="token function">getSerial</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>args<span class="token punctuation">.</span>CommandId<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span>ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>applyBuffer<span class="token punctuation">[</span>serial<span class="token punctuation">]</span>
	<span class="token keyword keyword-if">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		kv<span class="token punctuation">.</span>applyBuffer<span class="token punctuation">[</span>serial<span class="token punctuation">]</span> <span class="token operator">=</span> tmpch
	<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
		tmpch <span class="token operator">=</span> kv<span class="token punctuation">.</span>applyBuffer<span class="token punctuation">[</span>serial<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	isout <span class="token operator">:=</span> <span class="token boolean">false</span>
	appliedresult <span class="token operator">:=</span> AppliedResult<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword keyword-select">select</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-case">case</span> appliedresult <span class="token operator">=</span> <span class="token operator">&lt;-</span> tmpch<span class="token punctuation">:</span>
		isout <span class="token operator">=</span> <span class="token boolean">false</span>
	<span class="token keyword keyword-case">case</span> <span class="token operator">&lt;-</span> time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">:</span>
		isout <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
	<span class="token keyword keyword-if">if</span> isout <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword keyword-return">return</span>
	<span class="token punctuation">}</span>
	reply<span class="token punctuation">.</span>Value <span class="token operator">=</span> appliedresult<span class="token punctuation">.</span>Value
	<span class="token keyword keyword-if">if</span> appliedresult<span class="token punctuation">.</span>Err <span class="token operator">==</span> ErrNoKey <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
	<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
	<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里Log中的内容为Op结构体,这个结构体描述了来自用户的请求.除了类型,key和value,还有用于去重的<code>ClientId和CommandId</code>.之后再设置一个<code>channel</code>,这个<code>channel</code>用来等待来自raft层apply日志的结果.<code>leader</code>会维护一个map,里面有一个根据每个请求的<code>SerialNum</code>来进行标识的<code>channel</code>,当一个<code>applyMsg</code>从raft层接收时,就通过其中log中<code>ClientId和CommandId</code>的内容得出序列号从map中得到这个channel,然后传递结果,如果没有超时,那么RPC响应函数就停止阻塞运行下去.如果一个非<code>leader</code>收到了这个<code>applyMsg</code>,通常没有对应的<code>channel</code>就不进行传递.</p>
<p>其中专门有一个结构体,用来描述<code>applyMsg</code>被apply的情况,如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-type">type</span> AppliedResult <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
	Applied 	<span class="token builtin">bool</span>
	Value		<span class="token builtin">string</span>
	Err			<span class="token builtin">string</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="raft日志提交">raft日志提交</h4>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">RecApplyMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-for">for</span> newApplyMsg <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> kv<span class="token punctuation">.</span>applyCh <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"[%v]the lastindex %v,get applymsg %v from appkych\n"</span><span class="token punctuation">,</span>newApplyMsg<span class="token punctuation">.</span>SnapshotIndex<span class="token punctuation">,</span>kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span> newApplyMsg<span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> newApplyMsg<span class="token punctuation">.</span>CommandValid <span class="token punctuation">{</span>
			<span class="token keyword keyword-var">var</span> operation Op <span class="token operator">=</span> newApplyMsg<span class="token punctuation">.</span>Command<span class="token punctuation">.</span><span class="token punctuation">(</span>Op<span class="token punctuation">)</span>
			kv<span class="token punctuation">.</span><span class="token function">DoCommandOp</span><span class="token punctuation">(</span>operation<span class="token punctuation">,</span>newApplyMsg<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> newApplyMsg<span class="token punctuation">.</span>SnapshotValid <span class="token punctuation">{</span> <span class="token comment">//如果处理的是快照,需要将快照之中的内容也执行</span>
			kv<span class="token punctuation">.</span><span class="token function">RecoverFromSnapshot</span><span class="token punctuation">(</span>newApplyMsg<span class="token punctuation">.</span>Snapshot<span class="token punctuation">)</span> <span class="token comment">//解码得到日志</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这部分单独开了一个协程,设置一个用来接收来自raft的cmd或者快照,对于普通command的处理,其具体过程如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">DoCommandOp</span><span class="token punctuation">(</span>operation Op<span class="token punctuation">,</span>appliedindex <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		result <span class="token operator">:=</span> AppliedResult<span class="token punctuation">{</span><span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		kv<span class="token punctuation">.</span><span class="token function">initCommitMap</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>ClientId<span class="token punctuation">)</span>
		applied <span class="token operator">:=</span> kv<span class="token punctuation">.</span>commitMap<span class="token punctuation">[</span>operation<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> operation<span class="token punctuation">.</span>CommandId
		<span class="token keyword keyword-if">if</span> operation<span class="token punctuation">.</span>Optype <span class="token operator">==</span> PutOp <span class="token operator">||</span> operation<span class="token punctuation">.</span>Optype <span class="token operator">==</span> AppendOp <span class="token punctuation">{</span>
			<span class="token keyword keyword-if">if</span> <span class="token operator">!</span>applied <span class="token punctuation">{</span>
				<span class="token comment">//if !applied {	</span>
					<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">"[%v]DoCmdop %v,appliedidx %v\n"</span><span class="token punctuation">,</span>kv<span class="token punctuation">.</span>me<span class="token punctuation">,</span>operation<span class="token punctuation">,</span>appliedindex<span class="token punctuation">)</span>
					<span class="token boolean">_</span><span class="token punctuation">,</span> have <span class="token operator">:=</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>operation<span class="token punctuation">.</span>Key<span class="token punctuation">]</span>
					<span class="token keyword keyword-if">if</span> operation<span class="token punctuation">.</span>Optype <span class="token operator">==</span> PutOp <span class="token operator">||</span> <span class="token operator">!</span>have <span class="token punctuation">{</span>
						kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>operation<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> operation<span class="token punctuation">.</span>Value
					<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
						kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>operation<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">+=</span> operation<span class="token punctuation">.</span>Value
					<span class="token punctuation">}</span><span class="token comment">//seeril能够唯一地标识某一个用户的某一个操作	</span>
					kv<span class="token punctuation">.</span>commitMap<span class="token punctuation">[</span>operation<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> operation<span class="token punctuation">.</span>CommandId
				<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
					value<span class="token punctuation">,</span>have <span class="token operator">:=</span> kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">[</span>operation<span class="token punctuation">.</span>Key<span class="token punctuation">]</span>
					<span class="token keyword keyword-if">if</span> have <span class="token punctuation">{</span>
						result<span class="token punctuation">.</span>Value <span class="token operator">=</span> value
						<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
							result<span class="token punctuation">.</span>Value <span class="token operator">=</span> None
							result<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrNoKey
						<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			kv<span class="token punctuation">.</span><span class="token function">UpdateApplied</span><span class="token punctuation">(</span>appliedindex<span class="token punctuation">)</span>
			<span class="token comment">//DPrintf("[%v] The kvMap %v When DoCommandOp\n",kv.me,kv.kvMap)</span>
			serial <span class="token operator">:=</span> <span class="token function">getSerial</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span>operation<span class="token punctuation">.</span>CommandId<span class="token punctuation">)</span>
			ch<span class="token punctuation">,</span>ok <span class="token operator">:=</span> kv<span class="token punctuation">.</span>applyBuffer<span class="token punctuation">[</span>serial<span class="token punctuation">]</span>
		<span class="token comment">//kv.UpdateApplied(appliedindex)</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> ok <span class="token punctuation">{</span>
			ch <span class="token operator">&lt;-</span> result <span class="token comment">//直接操作kv.applyBuffer是容易造成竞争条件的,因而也会导致一些预料不到的死锁,所以将其拷贝到ch上</span>
			<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>applyBuffer<span class="token punctuation">,</span>serial<span class="token punctuation">)</span>
			kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先根据<code>CommitMap</code>判断当前接受的Command是否属于之前已经做过的,为什么在这里只对<code>Put,Append</code>进行去重的判断操作呢?因为去重本质上是为了保证像<code>Put,Append</code>这种会对状态机的状态进行改变的操作不会因为重复执行多次,而导致状态机的状态异常,而<code>Get</code>操作本身就不会对状态机的状态作出任何改变,更具体地说,如果真的有一个<code>Get</code>出现重复执行,比如说有n次执行<code>Get</code>了,其中只有一个是返回Ok的,一旦有返回Ok的,就会将其送往<code>channel</code>并且移除对应的项,之后陆续到来的重复<code>Get</code>找不到对应的项了,也就不会再传递结果到<code>channel</code>的阻塞处,况且一旦返回Ok,就不会再有新的RPC处理的回调了.</p>
<h4 id="快照提交">快照提交</h4>
<p>关于快照这部分,实现还是比较简单的.这一部分需要靠一个单独的协程来实现.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">CheckRaftState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
	<span class="token comment">//DPrintf("The raftstate is %v\n",raftstate)</span>
	<span class="token keyword keyword-for">for</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		raftstatesize <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetRaftStateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword keyword-if">if</span> raftstatesize <span class="token operator">&gt;=</span> kv<span class="token punctuation">.</span>maxraftstate<span class="token operator">/</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">9</span> <span class="token operator">&amp;&amp;</span> kv<span class="token punctuation">.</span>maxraftstate <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">//在此调用难道不会变吗,这个参数究竟得多少才是比较合适的呢?如果是三分之一的话是不是太小了呢?</span>
			kv<span class="token punctuation">.</span><span class="token function">DoSnapShot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//每次生成快照时都会附带有kv的状态</span>
		<span class="token punctuation">}</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里,使用的是周期性地检查是否需要进行打快照.</p>
<p>此外,关于快照需要保存的数据,其中有:</p>
<ul>
<li>KvMap,不需要解释,这是状态机最最根本,最最核心的操作对象.</li>
<li>commitMap,去重表.如果不进行正确保存,导致某一次操作或者某一项操作重试后被appliy,就会给状态机带来错误.</li>
<li>lastApplied主要用来判断接受快照时,是否需要将状态机更新为快照,如果快照中的lastApplied比较低,就拒绝该快照.因此可以防止状态机回退的问题.</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>KVServer<span class="token punctuation">)</span> <span class="token function">DoSnapShot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	w <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
	e <span class="token operator">:=</span> labgob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
	e<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>kvMap<span class="token punctuation">)</span>
	e<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>commitMap<span class="token punctuation">)</span>
	e<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>lastApplied<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Snapshot</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>lastApplied<span class="token punctuation">,</span>w<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="问题总结">3.问题总结</h2>
<h3 id="幂等操作与线性一致性">1) 幂等操作与线性一致性</h3>
<p>经过这次lab,在理论方面,首先对幂等操作和线性一致性有了一个初步的认识.其中幂等操作指的是<strong>重复的多次成功操作,其对于系统的影响就如同只进行一次成功操作一样</strong>.其中<code>Get</code>操作是对于kv的幂等操作,Put也可以算是.</p>
<p>就ddia书中所说,线性一致性是一种<strong>新鲜度保证,任何一个读取返回新值后,所有后续读取(在相同或其他客户端上)也必须返回新值</strong>.</p>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2008%2026%2020%2054%2023%201661518463%201661518463268%20mjfW45%20image-20220826205423116%20.png" alt="image-20220826205423116">
<figcaption aria-hidden="true">image-20220826205423116</figcaption>
</figure>
<p>如图中所示,读写操作都是一种延迟操作,这个延迟操作中又可以分为3个阶段,第一阶段为send,也就是RPC发送到目标的过程,第二阶段则是执行具体的任务,比如读写.第三阶段则是返回给RPC的调用者.其中对于像<code>Write</code>这样的操作,第二阶段一定存在某个点作为分水岭,在此“分水岭”前后真正执行read操作的请求其结果也就会呈现新旧两种不同的情况.</p>
<h3 id="kvraft对于线性一致性问题的解决">2)
Kvraft对于线性一致性问题的解决</h3>
<p>最后复盘一下这种问题场景:<code>client</code>发起了某个请求,进而被<code>leader server</code>接收后,经<code>raft</code>完成了一致,并且将要将日志apply到上层的<code>kv</code>,并且也成功接收了,但是就在该<code>leader server</code>需要响应Ok的RPC回应时,RPC丢失.这个时候只能让<code>client</code>重试,但是我们可能会疑问,这个日志已经被apply了一次了!如果重复apply还可以吗?</p>
<p>毕竟raft服务于上层的<code>kv</code>,只要<code>kv</code>的状态机(kv数据库)没有被同一个请求命令重复操作就可以了,这因此也就需要在应用层作出额外的机制,这也就是上面所重点介绍的去重机制.</p>
<p>就如同论文中所说:</p>
<blockquote>
<p>The solution is for clients to assign unique serial numbers to every
command. Then, the state machine tracks the latest serial number
processed for each client, along with the associated response. If it
receives a command whose serial number has already been executed, it
responds immediately without re-executing the request.</p>
</blockquote>
<p>我认为这体现了软件工程中的一种现象,尽管分层抽象可以简化问题,尤其一些服务层可以为应用层提供方便可靠的服务,但是新引入了新的层,就会引入新的问题,比如说上面所提到重复操作问题.我因此也有种疑惑,如果以后再遇到类似的问题的话,怎样才能找清楚解决问题的方向呢?究竟是应该从新引入层的角度上着手,还是像更底层的服务层着手呢?在这个<code>raftKv</code>中,则是新引入层的问题就在本层上进行额外的保障性机制.</p>
<figure>
<img src="https://yfspicturebad1-1309550486.cos.ap-nanjing.myqcloud.com/uPic/2022%2008%2026%2021%2035%2034%201661520934%201661520934250%20wGHA4o%20image-20220826213534157%20.png" alt="image-20220826213534157">
<figcaption aria-hidden="true">image-20220826213534157</figcaption>
</figure>
<p>最后这是整个lab3的测试结果,我实在想不明白了,为什么我的耗时这么长.......</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%A6%81%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">1.实现要点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%9A%84%E7%B1%BB%E5%8F%8A%E5%85%B6%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">1)核心的类及其数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%9A%84%E8%B6%85%E6%97%B6%E4%B8%8E%E9%87%8D%E4%BC%A0"><span class="toc-number">1.2.</span> <span class="toc-text">2)请求的超时与重传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E9%87%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">3)去重机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9A%84rpc%E5%8F%82%E6%95%B0%E4%B8%8E%E5%93%8D%E5%BA%94"><span class="toc-number">1.4.</span> <span class="toc-text">4) 相关的RPC参数与响应</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 实现过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#clerk"><span class="toc-number">2.1.</span> <span class="toc-text">1) Clerk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server"><span class="toc-number">2.2.</span> <span class="toc-text">2) Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rpc%E5%A4%84%E7%90%86"><span class="toc-number">2.2.1.</span> <span class="toc-text">RPC处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#raft%E6%97%A5%E5%BF%97%E6%8F%90%E4%BA%A4"><span class="toc-number">2.2.2.</span> <span class="toc-text">raft日志提交</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E7%85%A7%E6%8F%90%E4%BA%A4"><span class="toc-number">2.2.3.</span> <span class="toc-text">快照提交</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">3.问题总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%93%8D%E4%BD%9C%E4%B8%8E%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">3.1.</span> <span class="toc-text">1) 幂等操作与线性一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kvraft%E5%AF%B9%E4%BA%8E%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3"><span class="toc-number">3.2.</span> <span class="toc-text">2)
Kvraft对于线性一致性问题的解决</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/082442353.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/082442353.html&text=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/082442353.html&is_video=false&description=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=mit 6.824:分布式系统 lab3 kvraft&body=Check out this article: http://example.com/2022/082442353.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/082442353.html&title=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/082442353.html&name=mit 6.824:分布式系统 lab3 kvraft&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/082442353.html&t=mit 6.824:分布式系统 lab3 kvraft"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    yfs
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">首页</a></li><!--
    --><!--
      --><li><a href="/about/">关于</a></li><!--
    --><!--
      --><li><a href="/archives/">归档</a></li><!--
    -->
      </ul>
      <ul>
        
          <!-- 不蒜子统计 -->
          <span id="busuanzi_container_site_pv">
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  本站访客数<span id="busuanzi_value_site_uv"></span>人
          </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  
</footer>

<script src="/js/prism/prism.js" async></script>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
